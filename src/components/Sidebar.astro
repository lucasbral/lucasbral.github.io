---
import { getCollection, type CollectionEntry } from "astro:content";
import FormattedDate from "./FormattedDate.astro";

const posts = (await getCollection("blog")).sort(
    (a, b) => b.data.date.valueOf() - a.data.date.valueOf(),
);

// Profile Data
const profile = {
    name: "Lucas Sobral",
    avatar: "https://avatars.githubusercontent.com/u/27840392?v=4",
    bio: "Simplifying technology, one line of code at a time.",
};

// Types
type CategoryMap = Record<string, CollectionEntry<"blog">[]>;
type TagMap = Record<string, number>;
type ArchiveMap = Record<number, CollectionEntry<"blog">[]>;

// Categories Logic
const categories: CategoryMap = {};
posts.forEach((post) => {
    if (post.data.categories) {
        post.data.categories.forEach((category) => {
            if (!categories[category]) {
                categories[category] = [];
            }
            categories[category].push(post);
        });
    }
});

// Tags Logic
const tags: TagMap = {};
posts.forEach((post) => {
    if (post.data.tags) {
        post.data.tags.forEach((tag) => {
            tags[tag] = (tags[tag] || 0) + 1;
        });
    }
});
const sortedTags = Object.entries(tags).sort((a, b) => b[1] - a[1]);

// Archives Logic (Group by Year)
const archives: ArchiveMap = {};
posts.forEach((post) => {
    const year = post.data.date.getFullYear();
    if (!archives[year]) {
        archives[year] = [];
    }
    archives[year].push(post);
});
const sortedYears = Object.keys(archives)
    .map(Number)
    .sort((a, b) => b - a);
const { pathname } = Astro.url;
const isActive = (path: string) => pathname.startsWith(path);
---

<aside class="sidebar">
    <div class="mobile-header">
        <h2 class="sidebar-title"><!-- Menu title removed as requested --></h2>
        <button id="sidebar-close" aria-label="Close Menu"> ✕ </button>
    </div>

    <div class="mobile-toggle">
        <!-- Kept for backward compatibility if needed, but likely redundant now -->
        <button
            id="sidebar-toggle"
            aria-label="Toggle Menu"
            style="display: none;"
        >
            ☰ Menu
        </button>
    </div>

    <div class="sidebar-content" id="sidebar-content">
        <div class="profile-section">
            <div class="avatar-container">
                <img src={profile.avatar} alt={profile.name} class="avatar" />
            </div>
            <h3 class="profile-name">{profile.name}</h3>
            <p class="profile-bio">{profile.bio}</p>
        </div>

        <!-- Mobile Navigation Links -->

        <!-- Mobile Only: About Link -->
        <div class="sidebar-section mobile-only-section">
            <h3>
                <a
                    href="/about"
                    class:list={[
                        "sidebar-link",
                        { active: isActive("/about") },
                    ]}>About</a
                >
            </h3>
        </div>

        <!-- Categories: Desktop Only -->
        <div class="sidebar-section categories-section">
            <h3>
                <a
                    href="/categories"
                    class:list={[
                        "sidebar-link",
                        { active: isActive("/categories") },
                    ]}>Categories</a
                >
            </h3>
        </div>

        <!-- Archives: Desktop Only -->
        <div class="sidebar-section archives-section">
            <h3>
                <a
                    href="/archives"
                    class:list={[
                        "sidebar-link",
                        { active: isActive("/archives") },
                    ]}>Archives</a
                >
            </h3>
        </div>

        <div class="sidebar-section tags-section">
            <h3>
                <a
                    href="/tags"
                    class:list={["sidebar-link", { active: isActive("/tags") }]}
                    >Tags</a
                >
            </h3>
        </div>
    </div>

    <style>
        .sidebar {
            width: 100%;
            max-width: 300px;
            font-size: 0.9em;
        }

        .mobile-header {
            display: none;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--color-border);
        }

        .sidebar-title {
            margin: 0;
            font-size: 1.2rem;
            font-weight: bold;
        }

        #sidebar-close {
            background: transparent;
            border: 1px solid var(--color-border);
            border-radius: 8px;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            cursor: pointer;
            color: var(--color-text);
            transition: all 0.2s;
        }

        #sidebar-close:hover {
            background: var(--color-hover);
            color: var(--accent);
            border-color: var(--accent);
        }

        .mobile-toggle {
            display: none; /* Hidden on desktop */
            margin-bottom: 1rem;
        }

        @media (max-width: 900px) {
            .mobile-header {
                display: flex;
            }
        }

        #sidebar-toggle {
            width: 100%;
            padding: 0.8rem;
            background: var(--color-bg);
            border: 1px solid var(--color-border);
            border-radius: 8px;
            color: var(--color-text);
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        /* Default: Sidebar content visible */
        .sidebar-content {
            display: block;
        }

        .mobile-only-section {
            display: none;
        }

        /* Mobile specific styles handled by global.css via .sidebar-container off-canvas */
        @media (max-width: 900px) {
            .sidebar {
                max-width: 100%;
            }
            .mobile-only-section {
                display: block;
            }
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .sidebar-section {
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--color-border);
        }

        .sidebar-section h3 {
            margin-bottom: 1rem;
            font-size: 1.1em;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--gray);
        }

        .sidebar-link {
            text-decoration: none;
            color: inherit;
            transition: color 0.2s;
        }

        .sidebar-link:hover {
            color: var(--accent);
        }

        .sidebar-link.active {
            color: var(--accent);
            font-weight: bold;
            border-left: 3px solid var(--accent);
            padding-left: 0.5rem;
            margin-left: -0.5rem; /* Offset border width + padding */
        }

        /* Profile */
        .profile-section {
            text-align: center;
            margin-bottom: 2rem;
        }

        .avatar-container {
            width: 120px;
            height: 120px;
            margin: 0 auto 1rem;
            border-radius: 50%;
            overflow: hidden;
            border: 4px solid var(--color-border);
        }

        .avatar {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .profile-name {
            margin: 0.5rem 0;
            font-size: 1.4em;
        }

        .profile-bio {
            color: var(--gray);
            font-style: italic;
        }

        /* Categories */
        .category-list {
            list-style: none;
            padding: 0;
        }

        .category-list li {
            margin-bottom: 0.5rem;
        }

        .category-link {
            display: flex;
            align-items: center;
            text-decoration: none;
            color: var(--gray-dark);
            transition: color 0.2s;
        }

        .category-link:hover {
            color: var(--accent);
        }

        .folder-icon {
            margin-right: 0.5rem;
        }

        .count {
            margin-left: auto;
            font-size: 0.8em;
            color: var(--gray);
            background: var(--gray-light);
            padding: 0.1rem 0.4rem;
            border-radius: 10px;
        }

        /* Tags */
        .tag-cloud {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .tag-item {
            background: var(--gray-light);
            padding: 0.2rem 0.6rem;
            border-radius: 15px;
            text-decoration: none;
            color: var(--gray-dark);
            font-size: 0.85em;
            transition: all 0.2s;
            border: 1px solid transparent;
        }

        .tag-item:hover {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .tag-count {
            font-size: 0.8em;
            opacity: 0.7;
            margin-left: 3px;
        }

        /* Archives */
        .archive-list {
            list-style: none;
            padding: 0;
        }

        .archive-year {
            font-weight: bold;
            display: block;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
        }

        .archive-posts {
            list-style: none;
            padding-left: 1rem;
            border-left: 2px solid var(--color-border);
        }

        .archive-posts li {
            margin-bottom: 0.3rem;
        }

        .archive-posts a {
            text-decoration: none;
            color: var(--gray-dark);
        }

        .archive-posts a:hover {
            color: var(--accent);
            text-decoration: underline;
        }

        @media (max-width: 900px) {
            /* Categories and Archives now visible on Mobile */
        }
    </style>

    <script is:inline>
        document.addEventListener("DOMContentLoaded", () => {
            const closeBtn = document.getElementById("sidebar-close");
            closeBtn?.addEventListener("click", () => {
                document.body.classList.remove("show-sidebar");
            });
        });
    </script>
</aside>

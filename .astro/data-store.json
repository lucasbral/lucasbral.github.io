[["Map",1,2,9,10],"meta::meta",["Map",3,4,5,6,7,8],"astro-version","5.16.14","content-config-digest","8a58e6b2e99474de","astro-config-digest","{\"root\":{},\"srcDir\":{},\"publicDir\":{},\"outDir\":{},\"cacheDir\":{},\"site\":\"https://lucasbral.github.io\",\"compressHTML\":true,\"base\":\"/\",\"trailingSlash\":\"ignore\",\"output\":\"static\",\"scopedStyleStrategy\":\"attribute\",\"build\":{\"format\":\"directory\",\"client\":{},\"server\":{},\"assets\":\"_astro\",\"serverEntry\":\"entry.mjs\",\"redirects\":true,\"inlineStylesheets\":\"auto\",\"concurrency\":1},\"server\":{\"open\":false,\"host\":true,\"port\":4321,\"streaming\":true,\"allowedHosts\":[]},\"redirects\":{},\"image\":{\"endpoint\":{\"route\":\"/_image\"},\"service\":{\"entrypoint\":\"astro/assets/services/sharp\",\"config\":{}},\"domains\":[],\"remotePatterns\":[],\"responsiveStyles\":false},\"devToolbar\":{\"enabled\":true},\"markdown\":{\"syntaxHighlight\":{\"type\":\"shiki\",\"excludeLangs\":[\"math\"]},\"shikiConfig\":{\"langs\":[],\"langAlias\":{},\"theme\":\"github-dark\",\"themes\":{},\"wrap\":false,\"transformers\":[]},\"remarkPlugins\":[],\"rehypePlugins\":[],\"remarkRehype\":{},\"gfm\":true,\"smartypants\":true},\"security\":{\"checkOrigin\":true,\"allowedDomains\":[]},\"env\":{\"schema\":{},\"validateSecrets\":false},\"experimental\":{\"clientPrerender\":false,\"contentIntellisense\":false,\"headingIdCompat\":false,\"preserveScriptOrder\":false,\"liveContentCollections\":false,\"csp\":false,\"staticImportMetaEnv\":false,\"chromeDevtoolsWorkspace\":false,\"failOnPrerenderConflict\":false,\"svgo\":false},\"legacy\":{\"collections\":false}}","blog",["Map",11,12,78,79,136,137,205,206,241,242],"2025-06-27/2025-06-27-streamlit-duckdb",{"id":11,"data":13,"body":24,"filePath":25,"digest":26,"rendered":27},{"title":14,"description":15,"date":16,"image":17,"categories":19,"tags":23},"Building a High-Performance and Interactive Data Application with Streamlit and DuckDB","This project involves the development of a data-driven web application using Streamlit for the front-end interface and DuckDB as the core data engine. The application is designed to offer a seamless and interactive user experience for data reports.",["Date","2025-06-26T16:00:00.000Z"],{"path":18},"/assets/posts/2025-06-27/1.png",[20,21,22],"Python","Streamlit","Duckdb",[21,22],"## Introduction\n\n### The Challenge\n\nLast week, I was assigned a new task at work following a major migration from our legacy payroll management system. The old system, developed in Delphi and running on a Firebird 2.0 database, was no longer supported or updated.\n\nHowever, this legacy application still contained millions of historical bank remittance records for all employees, spanning its entire operational history. Although the new system was in place, the Human Resources (HR) department frequently needed to query this historical data to verify employee payment details from before the migration.\n\nThe task was to develop a simple, resource-efficient application that could generate reports from this vast dataset for the HR users.\n\n### The Solution\n\nTo solve this, we devised a strategy to decommission the legacy database while retaining full access to its data for reporting purposes.\n\n1.  **Data Extraction and Transformation**: All relevant information was extracted from the legacy Firebird database. The data was then cleaned, processed, and saved into a collection of segmented **Parquet files**. This format is highly efficient for analytical queries.\n\n2.  **Efficient Querying**: With the data structured in Parquet files, we utilized **DuckDB** as our query engine. This allowed us to perform fast, direct SQL queries on the Parquet files without needing to load large volumes of data into memory, ensuring minimal computational overhead.\n\n3.  **Application and Reporting**: The front-end of the application was built using **Streamlit**, creating a simple and intuitive interface for the users. When a user requests a report, the backend uses **Pandas** to handle the data retrieved by DuckDB. Finally, the report is generated and delivered to the user as a PDF file, created with the **FPDF** library.\n\nThis approach provided a modern, lightweight, and effective solution for accessing critical legacy data without maintaining an outdated system.\n\n## 1 . Getting data from firebird 2.0\n\n### Pre-requisites\n\nTo establish a connection and interact with this database, a specific set of tools was required:\n\n1.  **Firebird 2.0 ODBC Drivers**: These drivers are essential to enable data source connections from modern applications.\n2.  **Firebird Client v2.5**: A compatible client version (in this case, v2.5) was installed to communicate effectively with the v2.0 database server.\n\n### Connection with Python\n\nWith these prerequisites installed and configured, it becomes possible to connect to the database using Python. For this task, we will use the `fdb` library, as shown in the example below.\n\n```python\nimport fdb\nimport pandas as pd\nfrom tqdm import tqdm\nimport os\nimport time\n\n# --- connection Settings\nHOST = 'localhost'\nDATABASE_PATH = 'C:/example/example/database.GDB'\nUSER = 'USER'\nPASSWORD = 'password'\nCHARSET = 'ISO8859_1'\nTABLE_NAME = 'RETORNO'\nOUTPUT_DIR = 'data' \nCHUNK_SIZE = 10000000 # Number rows read by iteration\n\nprint(\"Connecting to Firebird...\")\ntry:\n    start_conn_time = time.time()\n    db_conn = fdb.connect(\n        host=HOST,\n        database=DATABASE_PATH,\n        user=USER,\n        password=PASSWORD,\n        charset=CHARSET\n    )\n    end_conn_time = time.time()\n    print(f\"Connection Established in {end_conn_time - start_conn_time:.2f} seconds\")\n\nexcept fdb.Error as e:\n    print(f\"fdb connection error: {e}\")\n    exit() \nexcept Exception as e:\n    print(f\"Error: {e}\")\n    exit()\n\nif not os.path.exists(OUTPUT_DIR):\n    os.makedirs(OUTPUT_DIR)\n    print(f\"Dir '{OUTPUT_DIR}' Created \")\nelse:\n    print(f\"Dir '{OUTPUT_DIR}' Already Exists\")\n\nsql_query = f\"SELECT * FROM {TABLE_NAME}\"\ntotal_rows_exported = 0\nfile_count = 0\n\nprint(f\"Extraction started '{TABLE_NAME}' in chunks...\")\nstart_extraction_time = time.time()\ntry:\n    for chunk_df in tqdm(pd.read_sql_query(sql_query, db_conn, chunksize=CHUNK_SIZE),\n                         desc=\"extracting\"):\n        if not chunk_df.empty:\n            chunk_df.columns = [col.strip() for col in chunk_df.columns]\n            output_file_path = os.path.join(OUTPUT_DIR, f\"{TABLE_NAME}_part_{file_count:05d}.parquet\")\n            chunk_df.to_parquet(output_file_path, index=False)\n            total_rows_exported += len(chunk_df)\n            file_count += 1\n        \nfinally:\n    if 'db_conn' in locals() and db_conn:\n        db_conn.close()\n        print(\"Connection closed\")\n\nend_extraction_time = time.time()\nprint(f\"\\Extraction completed!\")\nprint(f\"{total_rows_exported} rows from  '{TABLE_NAME}'.\")\nprint(f\"Exec time: {end_extraction_time - start_extraction_time:.2f} seconds.\")\n```\n\nUsing the code above, all tables from the database were extracted and saved as **Parquet files**.\n\n## 2. Developing the Streamlit Application\n\nWith the data extracted and saved into a dedicated directory, the next step was to devise a method to filter it and generate reports for the HR team.\n\nA critical project requirement was that the application had to run on a low-specification Linux machine with only **2 vCPUs and 4GB of RAM**. Consequently, loading all Parquet files into memory using libraries like Pandas or Polars was not a viable option. This approach would consume the machine's limited RAM, making the application inefficient and prone to failure.\n\nThis is why **DuckDB** was chosen as the core of our solution.\n\n> ### About DuckDB and its Parquet Optimization\n>\n> DuckDB is an open-source, in-process SQL database designed for analytical queries (OLAP). Think of it as \"the SQLite for analytics.\" It's incredibly fast, requires no external server, and integrates directly into the application.\n>\n> Its key advantage for this project is its ability to **directly query Parquet files** with high efficiency. Instead of loading entire files into memory, DuckDB's engine can scan the files on disk, apply filters, and pull only the specific data requested.\n>\n> The official documentation provides a technical explanation for this efficiency, focusing on how DuckDB interacts with \"row groups\" within Parquet files:\n>\n> > \"Compression algorithms are only applied per row group, so the larger the row group size, the more opportunities to compress the data. DuckDB can read Parquet row groups in parallel even within the same file and uses predicate pushdown to only scan the row groups whose metadata ranges match the WHERE clause of the query. However there is some overhead associated with reading the metadata in each group. A good approach would be to ensure that within each file, the total number of row groups is at least as large as the number of CPU threads used to query that file. More row groups beyond the thread count would improve the speed of highly selective queries, but slow down queries that must scan the whole file like aggregations.\"\n>\n> In short, this means DuckDB intelligently avoids reading unnecessary data through:\n>\n> * **Parallel Scanning:** It can read multiple parts of a single Parquet file (row groups) at the same time, using all available CPU threads.\n> * **Predicate Pushdown:** It first reads the metadata of each part. If the data in that section doesn't match the query's `WHERE` clause, DuckDB skips reading it entirely.\n>\n> This ability to selectively scan files based on user input was the main reason for its choice, allowing us to process datasets much larger than the available RAM.\n>\n> *Source: [Official DuckDB Parquet Documentation](https://duckdb.org/docs/stable/data/parquet/tips.html)*\n\nBy integrating DuckDB, we could use the user's inputs from the Streamlit interface to construct SQL queries. These queries would then run directly on the Parquet files, ensuring that only the pre-filtered, relevant data was ever loaded into memory, thus meeting the project's performance requirements.\n\n```python\nimport pandas as pd\nimport duckdb\n\ndir_files = '/dir_to_your_files/parquet_files/'\n\nquery = f\"\"\"SELECT * FROM read_parquet('{dir_files}') WHERE DT_PAGAMENTO BETWEEN ? AND ? \"\"\"\nparams = [date1, date2]\n\ncon = duckdb.connect(database=':memory:', read_only=False)\nst.session_state.results_df = con.execute(query, params).fetchdf()\ncon.close()\n```\n\n## 3. Building the User Interface with Streamlit\n\nNow that we have an engine capable of performing fast and organized queries, the final step is to create a user-friendly front-end for the HR team to interact with the data.\n\nFor this purpose, we will use **Streamlit**.\n\n> ### About Streamlit\n>\n> Streamlit is an open-source Python library that makes it incredibly easy to create and share beautiful, custom web applications for machine learning and data science. Its main advantage is simplicity: you can turn data scripts into interactive web apps in just a few lines of code, using only Python. It's ideal for creating internal tools, dashboards, and reports with interactive widgets like buttons, sliders, and text inputs.\n>\n> *Source: [Official Streamlit Documentation](https://docs.streamlit.io/)*\n\n### Application Design and Workflow\n\nThe front-end will be designed with simplicity in mind and will feature two distinct query pages for the user to choose from:\n\n1.  **Query by CPF:** This page will allow filtering remittance data based on:\n    * A date range (start and end date).\n    * The employee's CPF.\n\n2.  **Query by Employee ID:** This page will filter based on:\n    * A date range (start and end date).\n    * The employee's registration ID (`matricula`).\n    * The company the employee is associated with.\n\nThe user workflow is straightforward:\nOnce the user fills in the necessary filters on either page, a **\"Search\"** button will become active. Clicking this button sends the input parameters to our DuckDB engine, which executes the query on the Parquet files.\n\nThe result is returned as a **Pandas DataFrame**, which is then neatly displayed on the screen for the user to review.\n\nFinally, a download button will also be available on the screen, allowing the user to export the resulting DataFrame as a PDF. However, the technical details of this PDF generation feature will not be covered in this post.\n\n```python\n# app.py\n\nimport streamlit as st\nimport pandas as pd\nimport duckdb\nfrom datetime import date\nimport yaml\nfrom yaml.loader import SafeLoader\nimport streamlit_authenticator as stauth\nfrom pdf_generator import create_pdf_report\n\n# --- 1. SETUP AND CONFIGURATION ---\n\n# Path to the Parquet files. Using a wildcard (*) tells DuckDB to read all files in the directory.\nPARQUET_FILES_PATH = 'base/returns/*.parquet' \n\n# Set the page configuration. This should be the first Streamlit command in your script.\nst.set_page_config(\n    page_title=\"test\",\n    layout=\"wide\",\n    page_icon=\":mag:\"\n)\n\n# --- 2. AUTHENTICATION ---\n\n# Load authenticator configuration from an external YAML file.\ntry:\n    with open('config.yaml') as file:\n        config = yaml.load(file, Loader=SafeLoader)\nexcept FileNotFoundError:\n    st.error(\"Error: The 'config.yaml' configuration file was not found.\")\n    st.stop() # Halts the app if the config is missing.\n\n# Instantiate the authenticator object.\nauthenticator = stauth.Authenticate(\n    config['credentials'],\n    config['cookie']['name'],\n    config['cookie']['key'],\n    config['cookie']['expiry_days']\n)\n\n# Render the login widget.\nauthenticator.login()\n\n\n@st.cache_data(ttl=600) # Cache the query results for 10 minutes to avoid re-running identical queries.\ndef execute_query(query: str, params: list) -> pd.DataFrame:\n    \"\"\"\n    Connects to DuckDB, executes a given query with parameters, and returns a Pandas DataFrame.\n    Handles potential errors during the database query.\n    \"\"\"\n    try:\n        # DuckDB can run in-memory, which is perfect for this use case.\n        with duckdb.connect(database=':memory:', read_only=False) as con:\n            results = con.execute(query, params).fetchdf()\n        return results\n    except duckdb.Error as e:\n        st.error(f\"Database query error: {e}\")\n    except Exception as e:\n        st.error(f\"An unexpected error occurred: {e}\")\n    return pd.DataFrame()\n\ndef display_results(df: pd.DataFrame, report_info: dict):\n    \"\"\"\n\n    Takes a DataFrame and displays the results, including a success message,\n    the data table, and a PDF download button.\n    \"\"\"\n    st.markdown(\"---\")\n    st.subheader(\"Query Results\")\n    st.success(f\"Found {len(df)} records.\")\n\n    # Prepare a display version of the dataframe (e.g., formatting dates)\n    df_display = df.copy()\n    for col in ['DT_PAGTO', 'DT_GERADO']:\n        if col in df_display.columns:\n            df_display[col] = pd.to_datetime(df_display[col]).dt.strftime('%d/%m/%Y')\n    \n    # We drop the 'NOME' column for display, but keep it for the PDF report.\n    st.dataframe(df_display.drop(columns=['NOME'], errors='ignore'), use_container_width=True)\n    \n    # --- PDF Download Section ---\n    pdf_bytes = create_pdf_report(\n        df=df.drop(columns=['NOME'], errors='ignore'), \n        report_info=report_info\n    )\n    \n    st.download_button(\n        label=\"Download Report as PDF\",\n        data=pdf_bytes,\n        file_name=f\"remittance_report_{report_info.get('cpf', report_info.get('matricula'))}.pdf\",\n        mime=\"application/pdf\"\n    )\n\n# --- 4. MAIN APPLICATION (Protected by Authentication) ---\n\n# st.session_state is Streamlit's way of preserving variables across user interactions (reruns).\n# We check the authentication status stored in the session state.\nif st.session_state.get(\"authentication_status\"):\n\n    # --- HEADER AND SIDEBAR ---\n    col1, col2 = st.columns([1, 4], vertical_alignment=\"center\")\n    with col1:\n        st.image('img/img.png', use_container_width=True)\n    with col2:\n        st.title(f\"Welcome, *{st.session_state['name']}*\")\n        st.markdown(\"#### teste\")\n    \n    st.markdown(\"---\")\n\n    with st.sidebar:\n        st.header(f\"User: {st.session_state['name']}\")\n        authenticator.logout('Logout', 'sidebar', key='logout_button')\n        st.header(\"Navigation\")\n        # st.radio creates the navigation menu. The app reruns when the user changes the selection.\n        selected_page = st.radio(\n            \"Select a page:\",\n            (\"Query by CPF\", \"Query by Employee ID\"),\n            key='page_radio'\n        )\n\n    # --- PAGE 1: QUERY BY CPF ---\n    if selected_page == \"Query by CPF\":\n        st.header(\"Search Remittances by Employee CPF\")\n\n        col1, col2, col3 = st.columns(3)\n        with col1:\n            start_date = st.date_input(\"Start Date\", date(2024, 5, 30), format=\"DD/MM/YYYY\")\n        with col2:\n            end_date = st.date_input(\"End Date\", date(2024, 6, 30), format=\"DD/MM/YYYY\")\n        with col3:\n            cpf_filter = st.text_input(\"Employee CPF\")\n\n        # Disable the search button until the user provides the required input.\n        is_button_disabled = not cpf_filter\n        if is_button_disabled:\n            st.info(\"ℹ️ Please enter an employee's CPF to enable the search.\")\n\n        if st.button(\"Search by CPF\", type=\"primary\", disabled=is_button_disabled):\n            # st.spinner provides visual feedback to the user while the query is running.\n            with st.spinner(\"Querying data... Please wait.\"):\n                query = f\"\"\"\n                    SELECT *\n                    FROM read_parquet('{PARQUET_FILES_PATH}') \n                    WHERE DT_PAGAMENTO BETWEEN ? AND ? AND CPF = ?\n                    ORDER BY DT_PAGAMENTO ASC, EMP ASC\n                \"\"\"\n                params = [start_date, end_date, cpf_filter]\n                results_df = execute_query(query, params)\n                \n                if not results_df.empty:\n                    # Prepare info for the PDF report header\n                    report_info = {\n                        \"name\": results_df['NOME'].iloc[0],\n                        \"cpf\": cpf_filter,\n                        \"start_date\": start_date, \"end_date\": end_date\n                    }\n                    display_results(results_df, report_info)\n                else:\n                    st.warning(\"No records found for the selected filters.\")\n\n    # --- PAGE 2: QUERY BY EMPLOYEE ID ---\n    elif selected_page == \"Query by Employee ID\":\n        st.header(\"Search Remittances by Employee ID\")\n\n        col1, col2, col3, col4 = st.columns(4)\n        with col1:\n            start_date_emp = st.date_input(\"Start Date\", date(2024, 5, 30), key='emp_start_date', format=\"DD/MM/YYYY\")\n        with col2:\n            end_date_emp = st.date_input(\"End Date\", date(2024, 6, 30), key='emp_end_date', format=\"DD/MM/YYYY\")\n        with col3:\n            company_filter = st.text_input(\"Company Code\")\n        with col4:\n            id_filter = st.text_input(\"Employee ID (Matrícula)\")\n            \n        is_button_disabled = not (company_filter and id_filter)\n        if is_button_disabled:\n            st.info(\"ℹ️ Please enter both Company Code and Employee ID to enable the search.\")\n\n        if st.button(\"Search by Employee ID\", type=\"primary\", disabled=is_button_disabled):\n            with st.spinner(\"Querying data... Please wait.\"):\n                query = f\"\"\"\n                    SELECT *\n                    FROM read_parquet('{PARQUET_FILES_PATH}') \n                    WHERE DT_PAGAMENTO BETWEEN ? AND ? AND EMP = ? AND PRONT = ?\n                    ORDER BY DT_PAGAMENTO ASC, EMP ASC\n                \"\"\"\n                # Adjusting inputs to match database format (e.g., zero-padding)\n                params = [start_date_emp, end_date_emp, company_filter.zfill(3), id_filter.zfill(10)]\n                results_df = execute_query(query, params)\n                \n                if not results_df.empty:\n                    report_info = {\n                        \"name\": results_df['NOME'].iloc[0],\n                        \"company\": company_filter, \"matricula\": id_filter,\n                        \"start_date\": start_date_emp, \"end_date\": end_date_emp\n                    }\n                    display_results(results_df, report_info)\n                else:\n                    st.warning(\"No records found for the selected filters.\")\n\n# --- 5. HANDLING FAILED OR NO LOGIN ATTEMPT ---\nelif st.session_state.get(\"authentication_status\") is False:\n    st.error('Incorrect username or password.')\nelif st.session_state.get(\"authentication_status\") is None:\n    st.warning('Please enter your username and password.')\n```\n\n![desktop View](/assets/posts/2025-06-27/2.png)\n_View of Streamlit app after login auth_\n\n## 3. Project Conclusion\nThis project successfully replaced an unsupported legacy system with a modern, efficient data application, ensuring continued access to critical historical payroll data.\n\nThe core of the solution was a strategic combination of technologies. By migrating the data to Parquet files and using DuckDB as the query engine, we were able to deliver high-performance analytics directly on low-specification hardware, bypassing memory limitations. Streamlit provided the final piece, wrapping our backend logic in a secure and user-friendly web interface for the HR team.","src/content/blog/2025-06-27/2025-06-27-streamlit-duckdb.md","29d3c03d571229bd",{"html":28,"metadata":29},"\u003Ch2 id=\"introduction\">Introduction\u003C/h2>\n\u003Ch3 id=\"the-challenge\">The Challenge\u003C/h3>\n\u003Cp>Last week, I was assigned a new task at work following a major migration from our legacy payroll management system. The old system, developed in Delphi and running on a Firebird 2.0 database, was no longer supported or updated.\u003C/p>\n\u003Cp>However, this legacy application still contained millions of historical bank remittance records for all employees, spanning its entire operational history. Although the new system was in place, the Human Resources (HR) department frequently needed to query this historical data to verify employee payment details from before the migration.\u003C/p>\n\u003Cp>The task was to develop a simple, resource-efficient application that could generate reports from this vast dataset for the HR users.\u003C/p>\n\u003Ch3 id=\"the-solution\">The Solution\u003C/h3>\n\u003Cp>To solve this, we devised a strategy to decommission the legacy database while retaining full access to its data for reporting purposes.\u003C/p>\n\u003Col>\n\u003Cli>\n\u003Cp>\u003Cstrong>Data Extraction and Transformation\u003C/strong>: All relevant information was extracted from the legacy Firebird database. The data was then cleaned, processed, and saved into a collection of segmented \u003Cstrong>Parquet files\u003C/strong>. This format is highly efficient for analytical queries.\u003C/p>\n\u003C/li>\n\u003Cli>\n\u003Cp>\u003Cstrong>Efficient Querying\u003C/strong>: With the data structured in Parquet files, we utilized \u003Cstrong>DuckDB\u003C/strong> as our query engine. This allowed us to perform fast, direct SQL queries on the Parquet files without needing to load large volumes of data into memory, ensuring minimal computational overhead.\u003C/p>\n\u003C/li>\n\u003Cli>\n\u003Cp>\u003Cstrong>Application and Reporting\u003C/strong>: The front-end of the application was built using \u003Cstrong>Streamlit\u003C/strong>, creating a simple and intuitive interface for the users. When a user requests a report, the backend uses \u003Cstrong>Pandas\u003C/strong> to handle the data retrieved by DuckDB. Finally, the report is generated and delivered to the user as a PDF file, created with the \u003Cstrong>FPDF\u003C/strong> library.\u003C/p>\n\u003C/li>\n\u003C/ol>\n\u003Cp>This approach provided a modern, lightweight, and effective solution for accessing critical legacy data without maintaining an outdated system.\u003C/p>\n\u003Ch2 id=\"1--getting-data-from-firebird-20\">1 . Getting data from firebird 2.0\u003C/h2>\n\u003Ch3 id=\"pre-requisites\">Pre-requisites\u003C/h3>\n\u003Cp>To establish a connection and interact with this database, a specific set of tools was required:\u003C/p>\n\u003Col>\n\u003Cli>\u003Cstrong>Firebird 2.0 ODBC Drivers\u003C/strong>: These drivers are essential to enable data source connections from modern applications.\u003C/li>\n\u003Cli>\u003Cstrong>Firebird Client v2.5\u003C/strong>: A compatible client version (in this case, v2.5) was installed to communicate effectively with the v2.0 database server.\u003C/li>\n\u003C/ol>\n\u003Ch3 id=\"connection-with-python\">Connection with Python\u003C/h3>\n\u003Cp>With these prerequisites installed and configured, it becomes possible to connect to the database using Python. For this task, we will use the \u003Ccode>fdb\u003C/code> library, as shown in the example below.\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> fdb\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> pandas \u003C/span>\u003Cspan style=\"color:#F97583\">as\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> pd\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">from\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> tqdm \u003C/span>\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> tqdm\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> os\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> time\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># --- connection Settings\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">HOST\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> 'localhost'\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">DATABASE_PATH\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> 'C:/example/example/database.GDB'\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">USER\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> 'USER'\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">PASSWORD\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> 'password'\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">CHARSET\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> 'ISO8859_1'\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">TABLE_NAME\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> 'RETORNO'\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">OUTPUT_DIR\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> 'data'\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> \u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">CHUNK_SIZE\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 10000000\u003C/span>\u003Cspan style=\"color:#6A737D\"> # Number rows read by iteration\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">print\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"Connecting to Firebird...\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">try\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    start_conn_time \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> time.time()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    db_conn \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> fdb.connect(\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">        host\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\">HOST\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">        database\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\">DATABASE_PATH\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">        user\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\">USER\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">        password\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\">PASSWORD\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">        charset\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\">CHARSET\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    )\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    end_conn_time \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> time.time()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">    print\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#F97583\">f\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"Connection Established in \u003C/span>\u003Cspan style=\"color:#79B8FF\">{\u003C/span>\u003Cspan style=\"color:#E1E4E8\">end_conn_time \u003C/span>\u003Cspan style=\"color:#F97583\">-\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> start_conn_time\u003C/span>\u003Cspan style=\"color:#F97583\">:.2f\u003C/span>\u003Cspan style=\"color:#79B8FF\">}\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> seconds\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">except\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> fdb.Error \u003C/span>\u003Cspan style=\"color:#F97583\">as\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> e:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">    print\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#F97583\">f\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"fdb connection error: \u003C/span>\u003Cspan style=\"color:#79B8FF\">{\u003C/span>\u003Cspan style=\"color:#E1E4E8\">e\u003C/span>\u003Cspan style=\"color:#79B8FF\">}\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">    exit\u003C/span>\u003Cspan style=\"color:#E1E4E8\">() \u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">except\u003C/span>\u003Cspan style=\"color:#79B8FF\"> Exception\u003C/span>\u003Cspan style=\"color:#F97583\"> as\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> e:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">    print\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#F97583\">f\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"Error: \u003C/span>\u003Cspan style=\"color:#79B8FF\">{\u003C/span>\u003Cspan style=\"color:#E1E4E8\">e\u003C/span>\u003Cspan style=\"color:#79B8FF\">}\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">    exit\u003C/span>\u003Cspan style=\"color:#E1E4E8\">()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">if\u003C/span>\u003Cspan style=\"color:#F97583\"> not\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> os.path.exists(\u003C/span>\u003Cspan style=\"color:#79B8FF\">OUTPUT_DIR\u003C/span>\u003Cspan style=\"color:#E1E4E8\">):\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    os.makedirs(\u003C/span>\u003Cspan style=\"color:#79B8FF\">OUTPUT_DIR\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">    print\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#F97583\">f\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"Dir '\u003C/span>\u003Cspan style=\"color:#79B8FF\">{OUTPUT_DIR}\u003C/span>\u003Cspan style=\"color:#9ECBFF\">' Created \"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">else\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">    print\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#F97583\">f\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"Dir '\u003C/span>\u003Cspan style=\"color:#79B8FF\">{OUTPUT_DIR}\u003C/span>\u003Cspan style=\"color:#9ECBFF\">' Already Exists\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">sql_query \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#F97583\"> f\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"SELECT * FROM \u003C/span>\u003Cspan style=\"color:#79B8FF\">{TABLE_NAME}\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">total_rows_exported \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 0\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">file_count \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 0\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">print\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#F97583\">f\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"Extraction started '\u003C/span>\u003Cspan style=\"color:#79B8FF\">{TABLE_NAME}\u003C/span>\u003Cspan style=\"color:#9ECBFF\">' in chunks...\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">start_extraction_time \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> time.time()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">try\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    for\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> chunk_df \u003C/span>\u003Cspan style=\"color:#F97583\">in\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> tqdm(pd.read_sql_query(sql_query, db_conn, \u003C/span>\u003Cspan style=\"color:#FFAB70\">chunksize\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\">CHUNK_SIZE\u003C/span>\u003Cspan style=\"color:#E1E4E8\">),\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">                         desc\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"extracting\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">):\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        if\u003C/span>\u003Cspan style=\"color:#F97583\"> not\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> chunk_df.empty:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            chunk_df.columns \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> [col.strip() \u003C/span>\u003Cspan style=\"color:#F97583\">for\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> col \u003C/span>\u003Cspan style=\"color:#F97583\">in\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> chunk_df.columns]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            output_file_path \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> os.path.join(\u003C/span>\u003Cspan style=\"color:#79B8FF\">OUTPUT_DIR\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#F97583\">f\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"\u003C/span>\u003Cspan style=\"color:#79B8FF\">{TABLE_NAME}\u003C/span>\u003Cspan style=\"color:#9ECBFF\">_part_\u003C/span>\u003Cspan style=\"color:#79B8FF\">{\u003C/span>\u003Cspan style=\"color:#E1E4E8\">file_count\u003C/span>\u003Cspan style=\"color:#F97583\">:05d\u003C/span>\u003Cspan style=\"color:#79B8FF\">}\u003C/span>\u003Cspan style=\"color:#9ECBFF\">.parquet\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            chunk_df.to_parquet(output_file_path, \u003C/span>\u003Cspan style=\"color:#FFAB70\">index\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\">False\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            total_rows_exported \u003C/span>\u003Cspan style=\"color:#F97583\">+=\u003C/span>\u003Cspan style=\"color:#79B8FF\"> len\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(chunk_df)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            file_count \u003C/span>\u003Cspan style=\"color:#F97583\">+=\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 1\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        \u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">finally\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    if\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> 'db_conn'\u003C/span>\u003Cspan style=\"color:#F97583\"> in\u003C/span>\u003Cspan style=\"color:#79B8FF\"> locals\u003C/span>\u003Cspan style=\"color:#E1E4E8\">() \u003C/span>\u003Cspan style=\"color:#F97583\">and\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> db_conn:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        db_conn.close()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">        print\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"Connection closed\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">end_extraction_time \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> time.time()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">print\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#F97583\">f\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"\\Extraction completed!\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">print\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#F97583\">f\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"\u003C/span>\u003Cspan style=\"color:#79B8FF\">{\u003C/span>\u003Cspan style=\"color:#E1E4E8\">total_rows_exported\u003C/span>\u003Cspan style=\"color:#79B8FF\">}\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> rows from  '\u003C/span>\u003Cspan style=\"color:#79B8FF\">{TABLE_NAME}\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'.\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">print\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#F97583\">f\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"Exec time: \u003C/span>\u003Cspan style=\"color:#79B8FF\">{\u003C/span>\u003Cspan style=\"color:#E1E4E8\">end_extraction_time \u003C/span>\u003Cspan style=\"color:#F97583\">-\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> start_extraction_time\u003C/span>\u003Cspan style=\"color:#F97583\">:.2f\u003C/span>\u003Cspan style=\"color:#79B8FF\">}\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> seconds.\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Using the code above, all tables from the database were extracted and saved as \u003Cstrong>Parquet files\u003C/strong>.\u003C/p>\n\u003Ch2 id=\"2-developing-the-streamlit-application\">2. Developing the Streamlit Application\u003C/h2>\n\u003Cp>With the data extracted and saved into a dedicated directory, the next step was to devise a method to filter it and generate reports for the HR team.\u003C/p>\n\u003Cp>A critical project requirement was that the application had to run on a low-specification Linux machine with only \u003Cstrong>2 vCPUs and 4GB of RAM\u003C/strong>. Consequently, loading all Parquet files into memory using libraries like Pandas or Polars was not a viable option. This approach would consume the machine’s limited RAM, making the application inefficient and prone to failure.\u003C/p>\n\u003Cp>This is why \u003Cstrong>DuckDB\u003C/strong> was chosen as the core of our solution.\u003C/p>\n\u003Cblockquote>\n\u003Ch3 id=\"about-duckdb-and-its-parquet-optimization\">About DuckDB and its Parquet Optimization\u003C/h3>\n\u003Cp>DuckDB is an open-source, in-process SQL database designed for analytical queries (OLAP). Think of it as “the SQLite for analytics.” It’s incredibly fast, requires no external server, and integrates directly into the application.\u003C/p>\n\u003Cp>Its key advantage for this project is its ability to \u003Cstrong>directly query Parquet files\u003C/strong> with high efficiency. Instead of loading entire files into memory, DuckDB’s engine can scan the files on disk, apply filters, and pull only the specific data requested.\u003C/p>\n\u003Cp>The official documentation provides a technical explanation for this efficiency, focusing on how DuckDB interacts with “row groups” within Parquet files:\u003C/p>\n\u003Cblockquote>\n\u003Cp>“Compression algorithms are only applied per row group, so the larger the row group size, the more opportunities to compress the data. DuckDB can read Parquet row groups in parallel even within the same file and uses predicate pushdown to only scan the row groups whose metadata ranges match the WHERE clause of the query. However there is some overhead associated with reading the metadata in each group. A good approach would be to ensure that within each file, the total number of row groups is at least as large as the number of CPU threads used to query that file. More row groups beyond the thread count would improve the speed of highly selective queries, but slow down queries that must scan the whole file like aggregations.”\u003C/p>\n\u003C/blockquote>\n\u003Cp>In short, this means DuckDB intelligently avoids reading unnecessary data through:\u003C/p>\n\u003Cul>\n\u003Cli>\u003Cstrong>Parallel Scanning:\u003C/strong> It can read multiple parts of a single Parquet file (row groups) at the same time, using all available CPU threads.\u003C/li>\n\u003Cli>\u003Cstrong>Predicate Pushdown:\u003C/strong> It first reads the metadata of each part. If the data in that section doesn’t match the query’s \u003Ccode>WHERE\u003C/code> clause, DuckDB skips reading it entirely.\u003C/li>\n\u003C/ul>\n\u003Cp>This ability to selectively scan files based on user input was the main reason for its choice, allowing us to process datasets much larger than the available RAM.\u003C/p>\n\u003Cp>\u003Cem>Source: \u003Ca href=\"https://duckdb.org/docs/stable/data/parquet/tips.html\">Official DuckDB Parquet Documentation\u003C/a>\u003C/em>\u003C/p>\n\u003C/blockquote>\n\u003Cp>By integrating DuckDB, we could use the user’s inputs from the Streamlit interface to construct SQL queries. These queries would then run directly on the Parquet files, ensuring that only the pre-filtered, relevant data was ever loaded into memory, thus meeting the project’s performance requirements.\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> pandas \u003C/span>\u003Cspan style=\"color:#F97583\">as\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> pd\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> duckdb\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">dir_files \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> '/dir_to_your_files/parquet_files/'\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">query \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#F97583\"> f\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"\"\"SELECT * FROM read_parquet('\u003C/span>\u003Cspan style=\"color:#79B8FF\">{\u003C/span>\u003Cspan style=\"color:#E1E4E8\">dir_files\u003C/span>\u003Cspan style=\"color:#79B8FF\">}\u003C/span>\u003Cspan style=\"color:#9ECBFF\">') WHERE DT_PAGAMENTO BETWEEN ? AND ? \"\"\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">params \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> [date1, date2]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">con \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> duckdb.connect(\u003C/span>\u003Cspan style=\"color:#FFAB70\">database\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\">':memory:'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#FFAB70\">read_only\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\">False\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">st.session_state.results_df \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> con.execute(query, params).fetchdf()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">con.close()\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch2 id=\"3-building-the-user-interface-with-streamlit\">3. Building the User Interface with Streamlit\u003C/h2>\n\u003Cp>Now that we have an engine capable of performing fast and organized queries, the final step is to create a user-friendly front-end for the HR team to interact with the data.\u003C/p>\n\u003Cp>For this purpose, we will use \u003Cstrong>Streamlit\u003C/strong>.\u003C/p>\n\u003Cblockquote>\n\u003Ch3 id=\"about-streamlit\">About Streamlit\u003C/h3>\n\u003Cp>Streamlit is an open-source Python library that makes it incredibly easy to create and share beautiful, custom web applications for machine learning and data science. Its main advantage is simplicity: you can turn data scripts into interactive web apps in just a few lines of code, using only Python. It’s ideal for creating internal tools, dashboards, and reports with interactive widgets like buttons, sliders, and text inputs.\u003C/p>\n\u003Cp>\u003Cem>Source: \u003Ca href=\"https://docs.streamlit.io/\">Official Streamlit Documentation\u003C/a>\u003C/em>\u003C/p>\n\u003C/blockquote>\n\u003Ch3 id=\"application-design-and-workflow\">Application Design and Workflow\u003C/h3>\n\u003Cp>The front-end will be designed with simplicity in mind and will feature two distinct query pages for the user to choose from:\u003C/p>\n\u003Col>\n\u003Cli>\n\u003Cp>\u003Cstrong>Query by CPF:\u003C/strong> This page will allow filtering remittance data based on:\u003C/p>\n\u003Cul>\n\u003Cli>A date range (start and end date).\u003C/li>\n\u003Cli>The employee’s CPF.\u003C/li>\n\u003C/ul>\n\u003C/li>\n\u003Cli>\n\u003Cp>\u003Cstrong>Query by Employee ID:\u003C/strong> This page will filter based on:\u003C/p>\n\u003Cul>\n\u003Cli>A date range (start and end date).\u003C/li>\n\u003Cli>The employee’s registration ID (\u003Ccode>matricula\u003C/code>).\u003C/li>\n\u003Cli>The company the employee is associated with.\u003C/li>\n\u003C/ul>\n\u003C/li>\n\u003C/ol>\n\u003Cp>The user workflow is straightforward:\nOnce the user fills in the necessary filters on either page, a \u003Cstrong>“Search”\u003C/strong> button will become active. Clicking this button sends the input parameters to our DuckDB engine, which executes the query on the Parquet files.\u003C/p>\n\u003Cp>The result is returned as a \u003Cstrong>Pandas DataFrame\u003C/strong>, which is then neatly displayed on the screen for the user to review.\u003C/p>\n\u003Cp>Finally, a download button will also be available on the screen, allowing the user to export the resulting DataFrame as a PDF. However, the technical details of this PDF generation feature will not be covered in this post.\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># app.py\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> streamlit \u003C/span>\u003Cspan style=\"color:#F97583\">as\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> st\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> pandas \u003C/span>\u003Cspan style=\"color:#F97583\">as\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> pd\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> duckdb\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">from\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> datetime \u003C/span>\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> date\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> yaml\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">from\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> yaml.loader \u003C/span>\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> SafeLoader\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> streamlit_authenticator \u003C/span>\u003Cspan style=\"color:#F97583\">as\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> stauth\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">from\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> pdf_generator \u003C/span>\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> create_pdf_report\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># --- 1. SETUP AND CONFIGURATION ---\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># Path to the Parquet files. Using a wildcard (*) tells DuckDB to read all files in the directory.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">PARQUET_FILES_PATH\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> 'base/returns/*.parquet'\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> \u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># Set the page configuration. This should be the first Streamlit command in your script.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">st.set_page_config(\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">    page_title\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"test\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">    layout\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"wide\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">    page_icon\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\":mag:\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># --- 2. AUTHENTICATION ---\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># Load authenticator configuration from an external YAML file.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">try\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    with\u003C/span>\u003Cspan style=\"color:#79B8FF\"> open\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'config.yaml'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">) \u003C/span>\u003Cspan style=\"color:#F97583\">as\u003C/span>\u003Cspan style=\"color:#FFAB70\"> file\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        config \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> yaml.load(\u003C/span>\u003Cspan style=\"color:#FFAB70\">file\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#FFAB70\">Loader\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\">SafeLoader)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">except\u003C/span>\u003Cspan style=\"color:#79B8FF\"> FileNotFoundError\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    st.error(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"Error: The 'config.yaml' configuration file was not found.\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    st.stop() \u003C/span>\u003Cspan style=\"color:#6A737D\"># Halts the app if the config is missing.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># Instantiate the authenticator object.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">authenticator \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> stauth.Authenticate(\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    config[\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'credentials'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">],\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    config[\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'cookie'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">][\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'name'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">],\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    config[\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'cookie'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">][\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'key'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">],\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    config[\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'cookie'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">][\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'expiry_days'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># Render the login widget.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">authenticator.login()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">@st.cache_data\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#FFAB70\">ttl\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\">600\u003C/span>\u003Cspan style=\"color:#E1E4E8\">) \u003C/span>\u003Cspan style=\"color:#6A737D\"># Cache the query results for 10 minutes to avoid re-running identical queries.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">def\u003C/span>\u003Cspan style=\"color:#B392F0\"> execute_query\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(query: \u003C/span>\u003Cspan style=\"color:#79B8FF\">str\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, params: \u003C/span>\u003Cspan style=\"color:#79B8FF\">list\u003C/span>\u003Cspan style=\"color:#E1E4E8\">) -> pd.DataFrame:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">    \"\"\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">    Connects to DuckDB, executes a given query with parameters, and returns a Pandas DataFrame.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">    Handles potential errors during the database query.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">    \"\"\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    try\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">        # DuckDB can run in-memory, which is perfect for this use case.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        with\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> duckdb.connect(\u003C/span>\u003Cspan style=\"color:#FFAB70\">database\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\">':memory:'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#FFAB70\">read_only\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\">False\u003C/span>\u003Cspan style=\"color:#E1E4E8\">) \u003C/span>\u003Cspan style=\"color:#F97583\">as\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> con:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            results \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> con.execute(query, params).fetchdf()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        return\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> results\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    except\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> duckdb.Error \u003C/span>\u003Cspan style=\"color:#F97583\">as\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> e:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        st.error(\u003C/span>\u003Cspan style=\"color:#F97583\">f\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"Database query error: \u003C/span>\u003Cspan style=\"color:#79B8FF\">{\u003C/span>\u003Cspan style=\"color:#E1E4E8\">e\u003C/span>\u003Cspan style=\"color:#79B8FF\">}\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    except\u003C/span>\u003Cspan style=\"color:#79B8FF\"> Exception\u003C/span>\u003Cspan style=\"color:#F97583\"> as\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> e:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        st.error(\u003C/span>\u003Cspan style=\"color:#F97583\">f\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"An unexpected error occurred: \u003C/span>\u003Cspan style=\"color:#79B8FF\">{\u003C/span>\u003Cspan style=\"color:#E1E4E8\">e\u003C/span>\u003Cspan style=\"color:#79B8FF\">}\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    return\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> pd.DataFrame()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">def\u003C/span>\u003Cspan style=\"color:#B392F0\"> display_results\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(df: pd.DataFrame, report_info: \u003C/span>\u003Cspan style=\"color:#79B8FF\">dict\u003C/span>\u003Cspan style=\"color:#E1E4E8\">):\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">    \"\"\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">    Takes a DataFrame and displays the results, including a success message,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">    the data table, and a PDF download button.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">    \"\"\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    st.markdown(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"---\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    st.subheader(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"Query Results\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    st.success(\u003C/span>\u003Cspan style=\"color:#F97583\">f\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"Found \u003C/span>\u003Cspan style=\"color:#79B8FF\">{len\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(df)\u003C/span>\u003Cspan style=\"color:#79B8FF\">}\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> records.\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    # Prepare a display version of the dataframe (e.g., formatting dates)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    df_display \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> df.copy()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    for\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> col \u003C/span>\u003Cspan style=\"color:#F97583\">in\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> [\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'DT_PAGTO'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">'DT_GERADO'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        if\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> col \u003C/span>\u003Cspan style=\"color:#F97583\">in\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> df_display.columns:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            df_display[col] \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> pd.to_datetime(df_display[col]).dt.strftime(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'\u003C/span>\u003Cspan style=\"color:#79B8FF\">%d\u003C/span>\u003Cspan style=\"color:#9ECBFF\">/%m/%Y'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    \u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    # We drop the 'NOME' column for display, but keep it for the PDF report.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    st.dataframe(df_display.drop(\u003C/span>\u003Cspan style=\"color:#FFAB70\">columns\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\">[\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'NOME'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">], \u003C/span>\u003Cspan style=\"color:#FFAB70\">errors\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'ignore'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">), \u003C/span>\u003Cspan style=\"color:#FFAB70\">use_container_width\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\">True\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    \u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    # --- PDF Download Section ---\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    pdf_bytes \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> create_pdf_report(\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">        df\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\">df.drop(\u003C/span>\u003Cspan style=\"color:#FFAB70\">columns\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\">[\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'NOME'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">], \u003C/span>\u003Cspan style=\"color:#FFAB70\">errors\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'ignore'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">), \u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">        report_info\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\">report_info\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    )\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    \u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    st.download_button(\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">        label\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"Download Report as PDF\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">        data\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\">pdf_bytes,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">        file_name\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#F97583\">f\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"remittance_report_\u003C/span>\u003Cspan style=\"color:#79B8FF\">{\u003C/span>\u003Cspan style=\"color:#E1E4E8\">report_info.get(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'cpf'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, report_info.get(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'matricula'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">))\u003C/span>\u003Cspan style=\"color:#79B8FF\">}\u003C/span>\u003Cspan style=\"color:#9ECBFF\">.pdf\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">        mime\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"application/pdf\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    )\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># --- 4. MAIN APPLICATION (Protected by Authentication) ---\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># st.session_state is Streamlit's way of preserving variables across user interactions (reruns).\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># We check the authentication status stored in the session state.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">if\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> st.session_state.get(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"authentication_status\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">):\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    # --- HEADER AND SIDEBAR ---\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    col1, col2 \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> st.columns([\u003C/span>\u003Cspan style=\"color:#79B8FF\">1\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#79B8FF\">4\u003C/span>\u003Cspan style=\"color:#E1E4E8\">], \u003C/span>\u003Cspan style=\"color:#FFAB70\">vertical_alignment\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"center\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    with\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> col1:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        st.image(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'img/img.png'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#FFAB70\">use_container_width\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\">True\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    with\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> col2:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        st.title(\u003C/span>\u003Cspan style=\"color:#F97583\">f\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"Welcome, *\u003C/span>\u003Cspan style=\"color:#79B8FF\">{\u003C/span>\u003Cspan style=\"color:#E1E4E8\">st.session_state[\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'name'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]\u003C/span>\u003Cspan style=\"color:#79B8FF\">}\u003C/span>\u003Cspan style=\"color:#9ECBFF\">*\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        st.markdown(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"#### teste\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    \u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    st.markdown(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"---\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    with\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> st.sidebar:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        st.header(\u003C/span>\u003Cspan style=\"color:#F97583\">f\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"User: \u003C/span>\u003Cspan style=\"color:#79B8FF\">{\u003C/span>\u003Cspan style=\"color:#E1E4E8\">st.session_state[\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'name'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]\u003C/span>\u003Cspan style=\"color:#79B8FF\">}\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        authenticator.logout(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'Logout'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">'sidebar'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#FFAB70\">key\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'logout_button'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        st.header(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"Navigation\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">        # st.radio creates the navigation menu. The app reruns when the user changes the selection.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        selected_page \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> st.radio(\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">            \"Select a page:\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            (\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"Query by CPF\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"Query by Employee ID\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">),\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">            key\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'page_radio'\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        )\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    # --- PAGE 1: QUERY BY CPF ---\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    if\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> selected_page \u003C/span>\u003Cspan style=\"color:#F97583\">==\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> \"Query by CPF\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        st.header(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"Search Remittances by Employee CPF\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        col1, col2, col3 \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> st.columns(\u003C/span>\u003Cspan style=\"color:#79B8FF\">3\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        with\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> col1:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            start_date \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> st.date_input(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"Start Date\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, date(\u003C/span>\u003Cspan style=\"color:#79B8FF\">2024\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#79B8FF\">5\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#79B8FF\">30\u003C/span>\u003Cspan style=\"color:#E1E4E8\">), \u003C/span>\u003Cspan style=\"color:#FFAB70\">format\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"DD/MM/YYYY\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        with\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> col2:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            end_date \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> st.date_input(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"End Date\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, date(\u003C/span>\u003Cspan style=\"color:#79B8FF\">2024\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#79B8FF\">6\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#79B8FF\">30\u003C/span>\u003Cspan style=\"color:#E1E4E8\">), \u003C/span>\u003Cspan style=\"color:#FFAB70\">format\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"DD/MM/YYYY\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        with\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> col3:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            cpf_filter \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> st.text_input(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"Employee CPF\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">        # Disable the search button until the user provides the required input.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        is_button_disabled \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#F97583\"> not\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> cpf_filter\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        if\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> is_button_disabled:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            st.info(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"ℹ️ Please enter an employee's CPF to enable the search.\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        if\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> st.button(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"Search by CPF\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#FFAB70\">type\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"primary\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#FFAB70\">disabled\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\">is_button_disabled):\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">            # st.spinner provides visual feedback to the user while the query is running.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">            with\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> st.spinner(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"Querying data... Please wait.\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">):\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">                query \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#F97583\"> f\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"\"\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">                    SELECT *\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">                    FROM read_parquet('\u003C/span>\u003Cspan style=\"color:#79B8FF\">{PARQUET_FILES_PATH}\u003C/span>\u003Cspan style=\"color:#9ECBFF\">') \u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">                    WHERE DT_PAGAMENTO BETWEEN ? AND ? AND CPF = ?\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">                    ORDER BY DT_PAGAMENTO ASC, EMP ASC\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">                \"\"\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">                params \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> [start_date, end_date, cpf_filter]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">                results_df \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> execute_query(query, params)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">                \u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">                if\u003C/span>\u003Cspan style=\"color:#F97583\"> not\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> results_df.empty:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">                    # Prepare info for the PDF report header\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">                    report_info \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">                        \"name\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: results_df[\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'NOME'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">].iloc[\u003C/span>\u003Cspan style=\"color:#79B8FF\">0\u003C/span>\u003Cspan style=\"color:#E1E4E8\">],\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">                        \"cpf\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: cpf_filter,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">                        \"start_date\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: start_date, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"end_date\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: end_date\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">                    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">                    display_results(results_df, report_info)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">                else\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">                    st.warning(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"No records found for the selected filters.\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    # --- PAGE 2: QUERY BY EMPLOYEE ID ---\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    elif\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> selected_page \u003C/span>\u003Cspan style=\"color:#F97583\">==\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> \"Query by Employee ID\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        st.header(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"Search Remittances by Employee ID\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        col1, col2, col3, col4 \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> st.columns(\u003C/span>\u003Cspan style=\"color:#79B8FF\">4\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        with\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> col1:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            start_date_emp \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> st.date_input(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"Start Date\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, date(\u003C/span>\u003Cspan style=\"color:#79B8FF\">2024\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#79B8FF\">5\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#79B8FF\">30\u003C/span>\u003Cspan style=\"color:#E1E4E8\">), \u003C/span>\u003Cspan style=\"color:#FFAB70\">key\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'emp_start_date'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#FFAB70\">format\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"DD/MM/YYYY\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        with\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> col2:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            end_date_emp \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> st.date_input(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"End Date\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, date(\u003C/span>\u003Cspan style=\"color:#79B8FF\">2024\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#79B8FF\">6\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#79B8FF\">30\u003C/span>\u003Cspan style=\"color:#E1E4E8\">), \u003C/span>\u003Cspan style=\"color:#FFAB70\">key\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'emp_end_date'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#FFAB70\">format\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"DD/MM/YYYY\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        with\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> col3:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            company_filter \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> st.text_input(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"Company Code\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        with\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> col4:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            id_filter \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> st.text_input(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"Employee ID (Matrícula)\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            \u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        is_button_disabled \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#F97583\"> not\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (company_filter \u003C/span>\u003Cspan style=\"color:#F97583\">and\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> id_filter)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        if\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> is_button_disabled:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            st.info(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"ℹ️ Please enter both Company Code and Employee ID to enable the search.\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        if\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> st.button(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"Search by Employee ID\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#FFAB70\">type\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"primary\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#FFAB70\">disabled\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\">is_button_disabled):\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">            with\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> st.spinner(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"Querying data... Please wait.\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">):\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">                query \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#F97583\"> f\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"\"\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">                    SELECT *\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">                    FROM read_parquet('\u003C/span>\u003Cspan style=\"color:#79B8FF\">{PARQUET_FILES_PATH}\u003C/span>\u003Cspan style=\"color:#9ECBFF\">') \u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">                    WHERE DT_PAGAMENTO BETWEEN ? AND ? AND EMP = ? AND PRONT = ?\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">                    ORDER BY DT_PAGAMENTO ASC, EMP ASC\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">                \"\"\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">                # Adjusting inputs to match database format (e.g., zero-padding)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">                params \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> [start_date_emp, end_date_emp, company_filter.zfill(\u003C/span>\u003Cspan style=\"color:#79B8FF\">3\u003C/span>\u003Cspan style=\"color:#E1E4E8\">), id_filter.zfill(\u003C/span>\u003Cspan style=\"color:#79B8FF\">10\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">                results_df \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> execute_query(query, params)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">                \u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">                if\u003C/span>\u003Cspan style=\"color:#F97583\"> not\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> results_df.empty:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">                    report_info \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">                        \"name\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: results_df[\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'NOME'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">].iloc[\u003C/span>\u003Cspan style=\"color:#79B8FF\">0\u003C/span>\u003Cspan style=\"color:#E1E4E8\">],\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">                        \"company\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: company_filter, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"matricula\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: id_filter,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">                        \"start_date\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: start_date_emp, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"end_date\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: end_date_emp\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">                    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">                    display_results(results_df, report_info)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">                else\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">                    st.warning(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"No records found for the selected filters.\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># --- 5. HANDLING FAILED OR NO LOGIN ATTEMPT ---\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">elif\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> st.session_state.get(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"authentication_status\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">) \u003C/span>\u003Cspan style=\"color:#F97583\">is\u003C/span>\u003Cspan style=\"color:#79B8FF\"> False\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    st.error(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'Incorrect username or password.'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">elif\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> st.session_state.get(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"authentication_status\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">) \u003C/span>\u003Cspan style=\"color:#F97583\">is\u003C/span>\u003Cspan style=\"color:#79B8FF\"> None\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    st.warning(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'Please enter your username and password.'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>\u003Cimg src=\"/assets/posts/2025-06-27/2.png\" alt=\"desktop View\">\n\u003Cem>View of Streamlit app after login auth\u003C/em>\u003C/p>\n\u003Ch2 id=\"3-project-conclusion\">3. Project Conclusion\u003C/h2>\n\u003Cp>This project successfully replaced an unsupported legacy system with a modern, efficient data application, ensuring continued access to critical historical payroll data.\u003C/p>\n\u003Cp>The core of the solution was a strategic combination of technologies. By migrating the data to Parquet files and using DuckDB as the query engine, we were able to deliver high-performance analytics directly on low-specification hardware, bypassing memory limitations. Streamlit provided the final piece, wrapping our backend logic in a secure and user-friendly web interface for the HR team.\u003C/p>",{"headings":30,"localImagePaths":69,"remoteImagePaths":70,"frontmatter":71,"imagePaths":77},[31,35,39,42,45,48,51,54,57,60,63,66],{"depth":32,"slug":33,"text":34},2,"introduction","Introduction",{"depth":36,"slug":37,"text":38},3,"the-challenge","The Challenge",{"depth":36,"slug":40,"text":41},"the-solution","The Solution",{"depth":32,"slug":43,"text":44},"1--getting-data-from-firebird-20","1 . Getting data from firebird 2.0",{"depth":36,"slug":46,"text":47},"pre-requisites","Pre-requisites",{"depth":36,"slug":49,"text":50},"connection-with-python","Connection with Python",{"depth":32,"slug":52,"text":53},"2-developing-the-streamlit-application","2. Developing the Streamlit Application",{"depth":36,"slug":55,"text":56},"about-duckdb-and-its-parquet-optimization","About DuckDB and its Parquet Optimization",{"depth":32,"slug":58,"text":59},"3-building-the-user-interface-with-streamlit","3. Building the User Interface with Streamlit",{"depth":36,"slug":61,"text":62},"about-streamlit","About Streamlit",{"depth":36,"slug":64,"text":65},"application-design-and-workflow","Application Design and Workflow",{"depth":32,"slug":67,"text":68},"3-project-conclusion","3. Project Conclusion",[],[],{"title":14,"description":15,"date":72,"categories":73,"tags":74,"image":75,"render_with_liquid":76},"2025-06-27 00:00:00 +0800",[20,21,22],[21,22],{"path":18},false,[],"2024-11-03/2024-11-03-fut-scrap",{"id":78,"data":80,"body":91,"filePath":92,"digest":93,"rendered":94},{"title":81,"description":82,"date":83,"image":84,"categories":86,"tags":88},"Scrapping football data from optaplayerstats.statsperform.com","This tutorial will demonstrate how to develop a Python program using Selenium and BeautifulSoup to extract data from the Opta Player Stats statistics platform.",["Date","2024-11-03T06:10:00.000Z"],{"path":85},"/assets/img/2024-11-03/f.png",[20,87],"Webscrapping",[89,90],"Selenium","Beautifulsoup4","## Motivation\n\nThe motivation for this tutorial comes from a close friend of mine, who is a data scientist and asked for my help with one of his personal projects. His goal is to build a predictive model to estimate the minute of play when the first yellow card will be issued in soccer matches. For this, the chosen football statistics platform is [Opta Player Stats](https://optaplayerstats.statsperform.com), and the selected league is the Brazilian Série A.\n\n\n## Studying the Website and Defining Variables\n\n\nOn the website, there is a specific link that lists all matches of the year for a given football championship. In the case of the link [Opta Player Stats](https://optaplayerstats.statsperform.com/en_GB/soccer/brasileir%C3%A3o-s%C3%A9rie-a-2023/czjx4rda7swlzql5d1cq90r8/opta-player-stats) - Brasileirão Série A 2023, it provides all the matches of the 2023 Brazilian Championship. Each game has its own specific link that displays detailed information for each individual match, and this will be the first piece of information we need to collect.\n\n\n![desktop View](/assets/img/2024-11-03/1.png)\n_View of the site_\n\nUsing the Firefox browser and pressing the F12 key to access the HTML file of the page, you can view all the information. In the path shown in the image below, we find the class that defines all the matches.\n\n![desktop View](/assets/img/2024-11-03/2.png)\n_Classes on the website that refer to matches_\n\n> Note that the classes starting with `Opta-fixture Opta-Match` are responsible for providing information for each game in the championship.\n{: .prompt-tip }\n\nWith this information, we can start writing our code to extract these data.\n\n## Extracting Matchs Links\n\nThe code below reads the HTML from the link containing the championship matches and uses BeautifulSoup to filter the Opta-fixture Opta-Match class, returning only the href parameter of each one.\n\n```python\nimport numpy as np\nimport pandas as pd\nimport requests\nfrom bs4 import BeautifulSoup\nfrom selenium import webdriver\nfrom selenium.webdriver.firefox.options import Options\n\n# URL of the championship\nurl = \"https://optaplayerstats.statsperform.com/pt_BR/soccer/brasileir%C3%A3o-s%C3%A9rie-a-2023/czjx4rda7swlzql5d1cq90r8/opta-player-stats\"\n\n# Set up Selenium with headless Firefox\noption = Options()\noption.headless = True\ndriver = webdriver.Firefox(options=option)\n# Load the page\ndriver.get(url)\ntime.sleep(10)\nhtml = driver.page_source\n# Parse the HTML with BeautifulSoup\nsoup = BeautifulSoup(html, 'html.parser')\n# Find the table with the class 'Opta-Crested'\ntable = soup.find('table', class_='Opta-Crested')\n# Close the driver\ndriver.quit()\n# Extract the href attributes of the links\npart = [link['href'] for link in table.find_all('a', class_='Opta-MatchLink Opta-Ext')]\nprint(\"Total Matches:\", len(part))\n```\n## Match Data\n\nNow that we have the links for each match, it's necessary to extract the data from each match that is relevant for this study. The variables we will use are essentially those shown in the figure below.\n\n![desktop View](/assets/img/2024-11-03/3.png)\n_Match info_\n\nOn the game timeline, there are symbols indicating yellow cards, goals, and own goals. When you hover the mouse over these symbols, the player responsible for the event and the minute it occurred in the game are displayed.\n                                                                                                                                                      \n## Extracting Match Data\n\nNow that we have the information to be extracted from the site, we can develop the code needed to accomplish this task.\n\n### Extracting Teams Infos\n\nIn this section, we will extract the data for the home team, away team, and the goals for each side. In the image below, you can see that the entire HTML block containing this information is within a `\u003Ctable>` with the class `Opta-MatchHeader Opta-MatchHeader-Crested`.\n\n![desktop View](/assets/img/2024-11-03/4.png)\n_Html that show teams infos_\n\nWe can then use BeautifulSoup to extract the information contained within these specific classes.\n\n```python\nimport numpy as np\nimport pandas as pd\nimport requests\nfrom bs4 import BeautifulSoup\nfrom selenium import webdriver\nfrom selenium.webdriver.firefox.options import Options\n\n# URL of the championship\nurl = \"https://optaplayerstats.statsperform.com/pt_BR/soccer/brasileir%C3%A3o-s%C3%A9rie-a-2023/czjx4rda7swlzql5d1cq90r8/match/view/dykfkagvqqndkwt56ph8meqz8/match-summary\"\n\n# Set up Selenium with headless Firefox\noption = Options()\noption.headless = True\ndriver = webdriver.Firefox(options=option)\n# Load the page\ndriver.get(url)\ntime.sleep(10)\nhtml = driver.page_source\n# Parse the HTML with BeautifulSoup\nsoup = BeautifulSoup(html, 'html.parser')\n# Find the table with the class 'Opta-Crested'\ntable = soup.find('table', class_='Opta-Crested')\n# Close the driver\ndriver.quit()\n\nhome_teams = soup.find_all('td', class_=lambda x: x and x.startswith('Opta-Team Opta-Home Opta-Team-Left Opta-TeamName'))\naway_teams = soup.find_all('td', class_=lambda x: x and x.startswith('Opta-Team Opta-Away Opta-Team-Right Opta-TeamName'))\n\nhome_team_names = [team.text.strip() for team in home_teams]\naway_team_names = [team.text.strip() for team in away_teams]\n\nmatch_widget_container = soup.find('div', class_='match-widget-container')\nhome_scores = match_widget_container.find_all('td', class_=lambda x: x and x.startswith('Opta-Score Opta-Home Opta-Team'))\naway_scores = match_widget_container.find_all('td', class_=lambda x: x and x.startswith('Opta-Score Opta-Away Opta-Team'))\n\n# Extraia os placares dos times\nhome_team_score = [score.find('span', class_='Opta-Team-Score').text.strip() for score in home_scores]\naway_team_score = [score.find('span', class_='Opta-Team-Score').text.strip() for score in away_scores]\n\nprint(home_team_names)\nprint(away_team_names)\nprint(home_team_score)\nprint(away_team_score)\n```\n\nWith this, our code is now able to retrieve the team information and the game score.\n\n### Extracting Matchs Infos\n\nNow we need to develop the part of the code that will retrieve information about the match stadium, attendance, and the referee who officiated the game.\n\n![desktop View](/assets/img/2024-11-03/5.png)\n_Html that show match data_\n\n> Note that the class responsible for providing this information is `Opta-Matchdata`. Therefore, we use BeautifulSoup to extract it.\n{: .prompt-tip }\n\n```python\n#keep the same libraries and driver configuration from the previous code.\n\nmatch_data = soup.find_all('div', class_='Opta-Matchdata')\nmatch_data_text = [data.text.strip() for data in match_data]\n\nest = public = ref = \"No data\"\n\nif match_data:\n    for data in match_data:\n        dls = data.find_all('dl')\n        for dl in dls:\n            dt = dl.find('dt').text.strip()\n            dd = dl.find('dd').text.strip()\n            if dt == 'Est':\n                est = dd\n            elif dt == 'P':\n                public = dd\n            else:\n                ref = dd\n\nprint(est)\nprint(public)\nprint(ref)\n```\n> This part of the code was configured in my native language, Brazilian Portuguese. For other languages, simply change the text that appears before each information topic. For example, \"Est\" becomes \"Venue\" in English, and so on.\n{: .prompt-danger }\n\n### Extracting Cards Infos\n\nTo extract information about cards during the game, we will use the data contained in the match timeline. The HTML divides the timeline into two parts: one for the home team, defined as `Opta-Events Opta-Home`, and another for the away team, as `Opta-Events Opta-Away`.\n\nKnowing this, we will extract these two pieces of information separately.\n\nAnother important detail is that each event occurring within the timeline has a specific numbering, which starts with `opta-MatchEvent Opta...`, as shown in the figure below.\n\nAdditionally, the site defines three types of cards: yellow, red, and second yellow.\n\nThis classification is determined by the type of icon displayed in the timeline. There are three types of classes for these icons:\n- `Opta-Icon Opta-IconYellow` for yellow cards\n- `Opta-Icon Opta-IconRed` for red cards\n- `Opta-Icon Opta-IconDouble` for second yellow cards\n\n![desktop View](/assets/img/2024-11-03/6.png)\n_Html that show timeline data_\n\nWith this information, we can develop the code below:\n\n\n```python\n#keep the same libraries and driver configuration from the previous code.\n\nhome_events_list = soup.find_all('ul', class_='Opta-Events Opta-Home')\nevents_home = []\nfor home_events in home_events_list:\n    events_home.extend(home_events.find_all('li', class_=lambda x: x and x.startswith('Opta-MatchEvent Opta-Event-Type')))\n\nyellow_cards_home = []\nred_cards_home = []\nsec_card_home = []\n\nfor event in events_home:\n    minute = event.find('span', class_='Opta-Event-Min').text.strip().replace('\\u200e', '').replace('\\u200f', '')\n    if event.find('p', class_='Opta-Icon Opta-IconYellow'):\n        player_img = event.find('img')\n        if player_img and 'alt' in player_img.attrs:\n            player = player_img['alt'].strip()\n        else:\n            player = \"undefined\"\n        yellow_cards_home.append({'player': player, 'minute': minute})\n    elif event.find('p', class_='Opta-Icon Opta-IconRed'):\n        player_img = event.find('img')\n        if player_img and 'alt' in player_img.attrs:\n            player = player_img['alt'].strip()\n        else:\n            player = \"undefined\"\n        red_cards_home.append({'player': player, 'minute': minute})\n    elif event.find('p', class_='Opta-Icon Opta-IconDouble'):\n        player_img = event.find('img')\n        if player_img and 'alt' in player_img.attrs:\n            player = player_img['alt'].strip()\n        else:\n            player = \"undefined\"\n        sec_card_home.append({'player': player, 'minute': minute})\n\n\naway_events_list = soup.find_all('ul', class_='Opta-Events Opta-Away')\n#events AWAY\nevents_away = []\nfor away_events in away_events_list:\n    events_away.extend(away_events.find_all('li', class_=lambda x: x and x.startswith('Opta-MatchEvent Opta-Event-Type')))\n\nyellow_cards_away = []\nred_cards_away = []\nsec_card_away = []\n\nfor event in events_away:\n    minute = event.find('span', class_='Opta-Event-Min').text.strip().replace('\\u200e', '').replace('\\u200f', '')\n    if event.find('p', class_='Opta-Icon Opta-IconYellow'):\n        player_img = event.find('img')\n        if player_img and 'alt' in player_img.attrs:\n            player = player_img['alt'].strip()\n        else:\n            player = \"undefined\"\n        yellow_cards_away.append({'player': player, 'minute': minute})\n    elif event.find('p', class_='Opta-Icon Opta-IconRed'):\n        player_img = event.find('img')\n        if player_img and 'alt' in player_img.attrs:\n            player = player_img['alt'].strip()\n        else:\n            player = \"undefined\"\n        red_cards_away.append({'player': player, 'minute': minute})\n    elif event.find('p', class_='Opta-Icon Opta-IconDouble'):\n        player_img = event.find('img')\n        if player_img and 'alt' in player_img.attrs:\n            player = player_img['alt'].strip()\n        else:\n            player = \"undefined\"\n        sec_card_away.append({'player': player, 'minute': minute})\n```\nWith this code, we then create six variables that store a JSON array with information about the players who received the card and the specific minute, as shown in the table below:\n\n| var                   | Description                                                                                                                                                                                                                                                                                |\n| --------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |\n| **yellow_cards_home** | A JSON array containing information about yellow cards received by players of the home team. Each object in the array includes: \u003Cbr> - **player**: The name of the player who received the yellow card. \u003Cbr> - **minute**: The minute when the yellow card was given.                      |\n| **red_cards_home**    | A JSON array containing information about red cards received by players of the home team. Each object in the array includes: \u003Cbr> - **player**: The name of the player who received the red card. \u003Cbr> - **minute**: The minute when the red card was given.                               |\n| **yellow_cards_away** | A JSON array containing information about yellow cards received by players of the away team. Each object in the array includes: \u003Cbr> - **player**: The name of the player who received the yellow card. \u003Cbr> - **minute**: The minute when the yellow card was given.                      |\n| **red_cards_away**    | A JSON array containing information about red cards received by players of the away team. Each object in the array includes: \u003Cbr> - **player**: The name of the player who received the red card. \u003Cbr> - **minute**: The minute when the red card was given.                               |\n| **sec_card_home**     | A JSON array containing information about second yellow cards received by players of the home team. Each object in the array includes: \u003Cbr> - **player**: The name of the player who received the second yellow card. \u003Cbr> - **minute**: The minute when the second yellow card was given. |\n| **sec_card_away**     | A JSON array containing information about second yellow cards received by players of the away team. Each object in the array includes: \u003Cbr> - **player**: The name of the player who received the second yellow card. \u003Cbr> - **minute**: The minute when the second yellow card was given. |\n\n\n\n### Extracting Goals Infos\n\nThe process for extracting goal information is quite similar to that of cards. The difference is that we will use the following classes:\n- `Opta-Icon Opta-IconGoal` for a normal goal\n- `Opta-Icon Opta-IconOwn` for an own goal\n- `Opta-Icon Opta-IconPenGoal` for a penalty goal\n\nThe code then looks like this:\n\n```python\n#keep the same libraries and driver configuration from the previous code.\n\nhome_events_list = soup.find_all('ul', class_='Opta-Events Opta-Home')\nevents_home = []\nfor home_events in home_events_list:\n    events_home.extend(home_events.find_all('li', class_=lambda x: x and x.startswith('Opta-MatchEvent Opta-Event-Type')))\n\ngols_home = []\n\nfor event in events_home:\n    minute = event.find('span', class_='Opta-Event-Min').text.strip().replace('\\u200e', '').replace('\\u200f', '')\n    if event.find('p', class_='Opta-Icon Opta-IconGoal'):\n        player_img = event.find('img')\n        if player_img and 'alt' in player_img.attrs:\n            player = player_img['alt'].strip()\n        else:\n            player = \"undefined\"\n        gols_home.append({'player': player, 'minute': minute, 'cont': 0, 'penal': 0})\n    elif event.find('p', class_='Opta-Icon Opta-IconOwn'):\n        player_img = event.find('img')\n        if player_img and 'alt' in player_img.attrs:\n            player = player_img['alt'].strip()\n        else:\n            player = \"undefined\"\n        gols_home.append({'player': player, 'minute': minute, 'cont': 1, 'penal': 0})\n    elif event.find('p', class_='Opta-Icon Opta-IconPenGoal'):\n        player_img = event.find('img')\n        if player_img and 'alt' in player_img.attrs:\n            player = player_img['alt'].strip()\n        else:\n            player = \"undefined\"\n        gols_home.append({'player': player, 'minute': minute, 'cont': 0, 'penal': 1})\n\n\naway_events_list = soup.find_all('ul', class_='Opta-Events Opta-Away')\n#events AWAY\nevents_away = []\nfor away_events in away_events_list:\n    events_away.extend(away_events.find_all('li', class_=lambda x: x and x.startswith('Opta-MatchEvent Opta-Event-Type')))\n\ngols_away = []\n\nfor event in events_away:\n    minute = event.find('span', class_='Opta-Event-Min').text.strip().replace('\\u200e', '').replace('\\u200f', '')\n    if event.find('p', class_='Opta-Icon Opta-IconGoal'):\n        player_img = event.find('img')\n        if player_img and 'alt' in player_img.attrs:\n            player = player_img['alt'].strip()\n        else:\n            player = \"undefined\"\n        gols_away.append({'player': player, 'minute': minute, 'cont': 0, 'penal': 0})\n    elif event.find('p', class_='Opta-Icon Opta-IconOwn'):\n        player_img = event.find('img')\n        if player_img and 'alt' in player_img.attrs:\n            player = player_img['alt'].strip()\n        else:\n            player = \"undefined\"\n        gols_away.append({'player': player, 'minute': minute, 'cont': 1, 'penal': 0})\n    elif event.find('p', class_='Opta-Icon Opta-IconPenGoal'):\n        player_img = event.find('img')\n        if player_img and 'alt' in player_img.attrs:\n            player = player_img['alt'].strip()\n        else:\n            player = \"undefined\"\n        gols_away.append({'player': player, 'minute': minute, 'cont': 0, 'penal': 1})\n```\nWith this code, we then create two variables that store the goals of the home team and the away team in the format below:\n\n| var           | Description                                                                                                                                                                                                                                                                                                                                                                                                             |\n| ------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |\n| **gols_home** | A JSON array containing information about goals scored by players of the home team. Each object in the array includes: \u003Cbr> - **player**: The name of the player who scored the goal. \u003Cbr> - **minute**: The minute when the goal was scored. \u003Cbr> - **cont**: Indicates if the goal was an own goal (1 for own goal, 0 otherwise). \u003Cbr> - **penal**: Indicates if the goal was a penalty (1 for penalty, 0 otherwise). |\n| **gols_away** | A JSON array containing information about goals scored by players of the away team. Each object in the array includes: \u003Cbr> - **player**: The name of the player who scored the goal. \u003Cbr> - **minute**: The minute when the goal was scored. \u003Cbr> - **cont**: Indicates if the goal was an own goal (1 for own goal, 0 otherwise). \u003Cbr> - **penal**: Indicates if the goal was a penalty (1 for penalty, 0 otherwise). |\n\n## Conclusions\n\nWith the information provided here, it is possible to build a program that extracts football match information from any championship available at optaplayerstats.statsperform.com. The link to this complete project is on [GitHub](https://github.com/lucasbral/fut_scrap/tree/main).\n\nBy using this program, it was possible to create a dataset with the data from all matches of the Brasileirão from 2020 to 2023, which can be found at this link on [Kaggle](https://www.kaggle.com/datasets/lucasbral/brasileirao-cartoes-20-23/).","src/content/blog/2024-11-03/2024-11-03-fut-scrap.md","4dfbd8af49e310d2",{"html":95,"metadata":96},"\u003Ch2 id=\"motivation\">Motivation\u003C/h2>\n\u003Cp>The motivation for this tutorial comes from a close friend of mine, who is a data scientist and asked for my help with one of his personal projects. His goal is to build a predictive model to estimate the minute of play when the first yellow card will be issued in soccer matches. For this, the chosen football statistics platform is \u003Ca href=\"https://optaplayerstats.statsperform.com\">Opta Player Stats\u003C/a>, and the selected league is the Brazilian Série A.\u003C/p>\n\u003Ch2 id=\"studying-the-website-and-defining-variables\">Studying the Website and Defining Variables\u003C/h2>\n\u003Cp>On the website, there is a specific link that lists all matches of the year for a given football championship. In the case of the link \u003Ca href=\"https://optaplayerstats.statsperform.com/en_GB/soccer/brasileir%C3%A3o-s%C3%A9rie-a-2023/czjx4rda7swlzql5d1cq90r8/opta-player-stats\">Opta Player Stats\u003C/a> - Brasileirão Série A 2023, it provides all the matches of the 2023 Brazilian Championship. Each game has its own specific link that displays detailed information for each individual match, and this will be the first piece of information we need to collect.\u003C/p>\n\u003Cp>\u003Cimg src=\"/assets/img/2024-11-03/1.png\" alt=\"desktop View\">\n\u003Cem>View of the site\u003C/em>\u003C/p>\n\u003Cp>Using the Firefox browser and pressing the F12 key to access the HTML file of the page, you can view all the information. In the path shown in the image below, we find the class that defines all the matches.\u003C/p>\n\u003Cp>\u003Cimg src=\"/assets/img/2024-11-03/2.png\" alt=\"desktop View\">\n\u003Cem>Classes on the website that refer to matches\u003C/em>\u003C/p>\n\u003Cblockquote>\n\u003Cp>Note that the classes starting with \u003Ccode>Opta-fixture Opta-Match\u003C/code> are responsible for providing information for each game in the championship.\n{: .prompt-tip }\u003C/p>\n\u003C/blockquote>\n\u003Cp>With this information, we can start writing our code to extract these data.\u003C/p>\n\u003Ch2 id=\"extracting-matchs-links\">Extracting Matchs Links\u003C/h2>\n\u003Cp>The code below reads the HTML from the link containing the championship matches and uses BeautifulSoup to filter the Opta-fixture Opta-Match class, returning only the href parameter of each one.\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> numpy \u003C/span>\u003Cspan style=\"color:#F97583\">as\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> np\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> pandas \u003C/span>\u003Cspan style=\"color:#F97583\">as\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> pd\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> requests\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">from\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> bs4 \u003C/span>\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> BeautifulSoup\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">from\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> selenium \u003C/span>\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> webdriver\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">from\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> selenium.webdriver.firefox.options \u003C/span>\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Options\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># URL of the championship\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">url \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> \"https://optaplayerstats.statsperform.com/pt_BR/soccer/brasileir%C3%A3o-s%C3%A9rie-a-2023/czjx4rda7swlzql5d1cq90r8/opta-player-stats\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># Set up Selenium with headless Firefox\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">option \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Options()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">option.headless \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\"> True\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">driver \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> webdriver.Firefox(\u003C/span>\u003Cspan style=\"color:#FFAB70\">options\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\">option)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># Load the page\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">driver.get(url)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">time.sleep(\u003C/span>\u003Cspan style=\"color:#79B8FF\">10\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">html \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> driver.page_source\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># Parse the HTML with BeautifulSoup\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">soup \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> BeautifulSoup(html, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">'html.parser'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># Find the table with the class 'Opta-Crested'\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">table \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> soup.find(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'table'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#FFAB70\">class_\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'Opta-Crested'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># Close the driver\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">driver.quit()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># Extract the href attributes of the links\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">part \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> [link[\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'href'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">] \u003C/span>\u003Cspan style=\"color:#F97583\">for\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> link \u003C/span>\u003Cspan style=\"color:#F97583\">in\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> table.find_all(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'a'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#FFAB70\">class_\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'Opta-MatchLink Opta-Ext'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">print\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"Total Matches:\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#79B8FF\">len\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(part))\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch2 id=\"match-data\">Match Data\u003C/h2>\n\u003Cp>Now that we have the links for each match, it’s necessary to extract the data from each match that is relevant for this study. The variables we will use are essentially those shown in the figure below.\u003C/p>\n\u003Cp>\u003Cimg src=\"/assets/img/2024-11-03/3.png\" alt=\"desktop View\">\n\u003Cem>Match info\u003C/em>\u003C/p>\n\u003Cp>On the game timeline, there are symbols indicating yellow cards, goals, and own goals. When you hover the mouse over these symbols, the player responsible for the event and the minute it occurred in the game are displayed.\u003C/p>\n\u003Ch2 id=\"extracting-match-data\">Extracting Match Data\u003C/h2>\n\u003Cp>Now that we have the information to be extracted from the site, we can develop the code needed to accomplish this task.\u003C/p>\n\u003Ch3 id=\"extracting-teams-infos\">Extracting Teams Infos\u003C/h3>\n\u003Cp>In this section, we will extract the data for the home team, away team, and the goals for each side. In the image below, you can see that the entire HTML block containing this information is within a \u003Ccode>&#x3C;table>\u003C/code> with the class \u003Ccode>Opta-MatchHeader Opta-MatchHeader-Crested\u003C/code>.\u003C/p>\n\u003Cp>\u003Cimg src=\"/assets/img/2024-11-03/4.png\" alt=\"desktop View\">\n\u003Cem>Html that show teams infos\u003C/em>\u003C/p>\n\u003Cp>We can then use BeautifulSoup to extract the information contained within these specific classes.\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> numpy \u003C/span>\u003Cspan style=\"color:#F97583\">as\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> np\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> pandas \u003C/span>\u003Cspan style=\"color:#F97583\">as\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> pd\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> requests\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">from\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> bs4 \u003C/span>\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> BeautifulSoup\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">from\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> selenium \u003C/span>\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> webdriver\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">from\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> selenium.webdriver.firefox.options \u003C/span>\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Options\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># URL of the championship\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">url \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> \"https://optaplayerstats.statsperform.com/pt_BR/soccer/brasileir%C3%A3o-s%C3%A9rie-a-2023/czjx4rda7swlzql5d1cq90r8/match/view/dykfkagvqqndkwt56ph8meqz8/match-summary\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># Set up Selenium with headless Firefox\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">option \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Options()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">option.headless \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\"> True\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">driver \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> webdriver.Firefox(\u003C/span>\u003Cspan style=\"color:#FFAB70\">options\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\">option)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># Load the page\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">driver.get(url)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">time.sleep(\u003C/span>\u003Cspan style=\"color:#79B8FF\">10\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">html \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> driver.page_source\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># Parse the HTML with BeautifulSoup\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">soup \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> BeautifulSoup(html, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">'html.parser'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># Find the table with the class 'Opta-Crested'\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">table \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> soup.find(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'table'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#FFAB70\">class_\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'Opta-Crested'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># Close the driver\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">driver.quit()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">home_teams \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> soup.find_all(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'td'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#FFAB70\">class_\u003C/span>\u003Cspan style=\"color:#F97583\">=lambda\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> x: x \u003C/span>\u003Cspan style=\"color:#F97583\">and\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> x.startswith(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'Opta-Team Opta-Home Opta-Team-Left Opta-TeamName'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">))\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">away_teams \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> soup.find_all(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'td'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#FFAB70\">class_\u003C/span>\u003Cspan style=\"color:#F97583\">=lambda\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> x: x \u003C/span>\u003Cspan style=\"color:#F97583\">and\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> x.startswith(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'Opta-Team Opta-Away Opta-Team-Right Opta-TeamName'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">))\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">home_team_names \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> [team.text.strip() \u003C/span>\u003Cspan style=\"color:#F97583\">for\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> team \u003C/span>\u003Cspan style=\"color:#F97583\">in\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> home_teams]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">away_team_names \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> [team.text.strip() \u003C/span>\u003Cspan style=\"color:#F97583\">for\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> team \u003C/span>\u003Cspan style=\"color:#F97583\">in\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> away_teams]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">match_widget_container \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> soup.find(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'div'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#FFAB70\">class_\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'match-widget-container'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">home_scores \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> match_widget_container.find_all(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'td'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#FFAB70\">class_\u003C/span>\u003Cspan style=\"color:#F97583\">=lambda\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> x: x \u003C/span>\u003Cspan style=\"color:#F97583\">and\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> x.startswith(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'Opta-Score Opta-Home Opta-Team'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">))\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">away_scores \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> match_widget_container.find_all(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'td'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#FFAB70\">class_\u003C/span>\u003Cspan style=\"color:#F97583\">=lambda\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> x: x \u003C/span>\u003Cspan style=\"color:#F97583\">and\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> x.startswith(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'Opta-Score Opta-Away Opta-Team'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">))\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># Extraia os placares dos times\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">home_team_score \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> [score.find(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'span'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#FFAB70\">class_\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'Opta-Team-Score'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">).text.strip() \u003C/span>\u003Cspan style=\"color:#F97583\">for\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> score \u003C/span>\u003Cspan style=\"color:#F97583\">in\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> home_scores]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">away_team_score \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> [score.find(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'span'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#FFAB70\">class_\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'Opta-Team-Score'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">).text.strip() \u003C/span>\u003Cspan style=\"color:#F97583\">for\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> score \u003C/span>\u003Cspan style=\"color:#F97583\">in\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> away_scores]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">print\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(home_team_names)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">print\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(away_team_names)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">print\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(home_team_score)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">print\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(away_team_score)\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>With this, our code is now able to retrieve the team information and the game score.\u003C/p>\n\u003Ch3 id=\"extracting-matchs-infos\">Extracting Matchs Infos\u003C/h3>\n\u003Cp>Now we need to develop the part of the code that will retrieve information about the match stadium, attendance, and the referee who officiated the game.\u003C/p>\n\u003Cp>\u003Cimg src=\"/assets/img/2024-11-03/5.png\" alt=\"desktop View\">\n\u003Cem>Html that show match data\u003C/em>\u003C/p>\n\u003Cblockquote>\n\u003Cp>Note that the class responsible for providing this information is \u003Ccode>Opta-Matchdata\u003C/code>. Therefore, we use BeautifulSoup to extract it.\n{: .prompt-tip }\u003C/p>\n\u003C/blockquote>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">#keep the same libraries and driver configuration from the previous code.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">match_data \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> soup.find_all(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'div'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#FFAB70\">class_\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'Opta-Matchdata'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">match_data_text \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> [data.text.strip() \u003C/span>\u003Cspan style=\"color:#F97583\">for\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> data \u003C/span>\u003Cspan style=\"color:#F97583\">in\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> match_data]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">est \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> public \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> ref \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> \"No data\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">if\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> match_data:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    for\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> data \u003C/span>\u003Cspan style=\"color:#F97583\">in\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> match_data:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        dls \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> data.find_all(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'dl'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        for\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> dl \u003C/span>\u003Cspan style=\"color:#F97583\">in\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> dls:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            dt \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> dl.find(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'dt'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">).text.strip()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            dd \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> dl.find(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'dd'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">).text.strip()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">            if\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> dt \u003C/span>\u003Cspan style=\"color:#F97583\">==\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> 'Est'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">                est \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> dd\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">            elif\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> dt \u003C/span>\u003Cspan style=\"color:#F97583\">==\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> 'P'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">                public \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> dd\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">            else\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">                ref \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> dd\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">print\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(est)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">print\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(public)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">print\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(ref)\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cblockquote>\n\u003Cp>This part of the code was configured in my native language, Brazilian Portuguese. For other languages, simply change the text that appears before each information topic. For example, “Est” becomes “Venue” in English, and so on.\n{: .prompt-danger }\u003C/p>\n\u003C/blockquote>\n\u003Ch3 id=\"extracting-cards-infos\">Extracting Cards Infos\u003C/h3>\n\u003Cp>To extract information about cards during the game, we will use the data contained in the match timeline. The HTML divides the timeline into two parts: one for the home team, defined as \u003Ccode>Opta-Events Opta-Home\u003C/code>, and another for the away team, as \u003Ccode>Opta-Events Opta-Away\u003C/code>.\u003C/p>\n\u003Cp>Knowing this, we will extract these two pieces of information separately.\u003C/p>\n\u003Cp>Another important detail is that each event occurring within the timeline has a specific numbering, which starts with \u003Ccode>opta-MatchEvent Opta...\u003C/code>, as shown in the figure below.\u003C/p>\n\u003Cp>Additionally, the site defines three types of cards: yellow, red, and second yellow.\u003C/p>\n\u003Cp>This classification is determined by the type of icon displayed in the timeline. There are three types of classes for these icons:\u003C/p>\n\u003Cul>\n\u003Cli>\u003Ccode>Opta-Icon Opta-IconYellow\u003C/code> for yellow cards\u003C/li>\n\u003Cli>\u003Ccode>Opta-Icon Opta-IconRed\u003C/code> for red cards\u003C/li>\n\u003Cli>\u003Ccode>Opta-Icon Opta-IconDouble\u003C/code> for second yellow cards\u003C/li>\n\u003C/ul>\n\u003Cp>\u003Cimg src=\"/assets/img/2024-11-03/6.png\" alt=\"desktop View\">\n\u003Cem>Html that show timeline data\u003C/em>\u003C/p>\n\u003Cp>With this information, we can develop the code below:\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">#keep the same libraries and driver configuration from the previous code.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">home_events_list \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> soup.find_all(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'ul'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#FFAB70\">class_\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'Opta-Events Opta-Home'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">events_home \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> []\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">for\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> home_events \u003C/span>\u003Cspan style=\"color:#F97583\">in\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> home_events_list:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    events_home.extend(home_events.find_all(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'li'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#FFAB70\">class_\u003C/span>\u003Cspan style=\"color:#F97583\">=lambda\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> x: x \u003C/span>\u003Cspan style=\"color:#F97583\">and\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> x.startswith(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'Opta-MatchEvent Opta-Event-Type'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)))\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">yellow_cards_home \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> []\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">red_cards_home \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> []\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">sec_card_home \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> []\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">for\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> event \u003C/span>\u003Cspan style=\"color:#F97583\">in\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> events_home:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    minute \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> event.find(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'span'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#FFAB70\">class_\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'Opta-Event-Min'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">).text.strip().replace(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'\u003C/span>\u003Cspan style=\"color:#79B8FF\">\\u200e\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">''\u003C/span>\u003Cspan style=\"color:#E1E4E8\">).replace(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'\u003C/span>\u003Cspan style=\"color:#79B8FF\">\\u200f\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">''\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    if\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> event.find(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'p'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#FFAB70\">class_\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'Opta-Icon Opta-IconYellow'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">):\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        player_img \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> event.find(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'img'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        if\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> player_img \u003C/span>\u003Cspan style=\"color:#F97583\">and\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> 'alt'\u003C/span>\u003Cspan style=\"color:#F97583\"> in\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> player_img.attrs:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            player \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> player_img[\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'alt'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">].strip()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        else\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            player \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> \"undefined\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        yellow_cards_home.append({\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'player'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: player, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">'minute'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: minute})\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    elif\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> event.find(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'p'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#FFAB70\">class_\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'Opta-Icon Opta-IconRed'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">):\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        player_img \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> event.find(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'img'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        if\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> player_img \u003C/span>\u003Cspan style=\"color:#F97583\">and\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> 'alt'\u003C/span>\u003Cspan style=\"color:#F97583\"> in\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> player_img.attrs:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            player \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> player_img[\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'alt'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">].strip()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        else\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            player \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> \"undefined\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        red_cards_home.append({\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'player'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: player, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">'minute'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: minute})\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    elif\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> event.find(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'p'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#FFAB70\">class_\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'Opta-Icon Opta-IconDouble'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">):\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        player_img \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> event.find(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'img'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        if\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> player_img \u003C/span>\u003Cspan style=\"color:#F97583\">and\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> 'alt'\u003C/span>\u003Cspan style=\"color:#F97583\"> in\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> player_img.attrs:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            player \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> player_img[\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'alt'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">].strip()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        else\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            player \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> \"undefined\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        sec_card_home.append({\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'player'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: player, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">'minute'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: minute})\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">away_events_list \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> soup.find_all(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'ul'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#FFAB70\">class_\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'Opta-Events Opta-Away'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">#events AWAY\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">events_away \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> []\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">for\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> away_events \u003C/span>\u003Cspan style=\"color:#F97583\">in\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> away_events_list:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    events_away.extend(away_events.find_all(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'li'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#FFAB70\">class_\u003C/span>\u003Cspan style=\"color:#F97583\">=lambda\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> x: x \u003C/span>\u003Cspan style=\"color:#F97583\">and\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> x.startswith(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'Opta-MatchEvent Opta-Event-Type'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)))\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">yellow_cards_away \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> []\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">red_cards_away \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> []\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">sec_card_away \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> []\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">for\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> event \u003C/span>\u003Cspan style=\"color:#F97583\">in\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> events_away:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    minute \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> event.find(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'span'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#FFAB70\">class_\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'Opta-Event-Min'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">).text.strip().replace(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'\u003C/span>\u003Cspan style=\"color:#79B8FF\">\\u200e\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">''\u003C/span>\u003Cspan style=\"color:#E1E4E8\">).replace(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'\u003C/span>\u003Cspan style=\"color:#79B8FF\">\\u200f\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">''\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    if\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> event.find(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'p'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#FFAB70\">class_\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'Opta-Icon Opta-IconYellow'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">):\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        player_img \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> event.find(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'img'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        if\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> player_img \u003C/span>\u003Cspan style=\"color:#F97583\">and\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> 'alt'\u003C/span>\u003Cspan style=\"color:#F97583\"> in\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> player_img.attrs:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            player \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> player_img[\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'alt'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">].strip()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        else\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            player \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> \"undefined\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        yellow_cards_away.append({\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'player'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: player, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">'minute'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: minute})\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    elif\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> event.find(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'p'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#FFAB70\">class_\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'Opta-Icon Opta-IconRed'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">):\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        player_img \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> event.find(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'img'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        if\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> player_img \u003C/span>\u003Cspan style=\"color:#F97583\">and\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> 'alt'\u003C/span>\u003Cspan style=\"color:#F97583\"> in\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> player_img.attrs:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            player \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> player_img[\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'alt'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">].strip()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        else\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            player \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> \"undefined\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        red_cards_away.append({\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'player'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: player, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">'minute'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: minute})\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    elif\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> event.find(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'p'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#FFAB70\">class_\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'Opta-Icon Opta-IconDouble'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">):\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        player_img \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> event.find(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'img'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        if\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> player_img \u003C/span>\u003Cspan style=\"color:#F97583\">and\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> 'alt'\u003C/span>\u003Cspan style=\"color:#F97583\"> in\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> player_img.attrs:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            player \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> player_img[\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'alt'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">].strip()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        else\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            player \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> \"undefined\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        sec_card_away.append({\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'player'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: player, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">'minute'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: minute})\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>With this code, we then create six variables that store a JSON array with information about the players who received the card and the specific minute, as shown in the table below:\u003C/p>\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\u003Ctable>\u003Cthead>\u003Ctr>\u003Cth>var\u003C/th>\u003Cth>Description\u003C/th>\u003C/tr>\u003C/thead>\u003Ctbody>\u003Ctr>\u003Ctd>\u003Cstrong>yellow_cards_home\u003C/strong>\u003C/td>\u003Ctd>A JSON array containing information about yellow cards received by players of the home team. Each object in the array includes: \u003Cbr> - \u003Cstrong>player\u003C/strong>: The name of the player who received the yellow card. \u003Cbr> - \u003Cstrong>minute\u003C/strong>: The minute when the yellow card was given.\u003C/td>\u003C/tr>\u003Ctr>\u003Ctd>\u003Cstrong>red_cards_home\u003C/strong>\u003C/td>\u003Ctd>A JSON array containing information about red cards received by players of the home team. Each object in the array includes: \u003Cbr> - \u003Cstrong>player\u003C/strong>: The name of the player who received the red card. \u003Cbr> - \u003Cstrong>minute\u003C/strong>: The minute when the red card was given.\u003C/td>\u003C/tr>\u003Ctr>\u003Ctd>\u003Cstrong>yellow_cards_away\u003C/strong>\u003C/td>\u003Ctd>A JSON array containing information about yellow cards received by players of the away team. Each object in the array includes: \u003Cbr> - \u003Cstrong>player\u003C/strong>: The name of the player who received the yellow card. \u003Cbr> - \u003Cstrong>minute\u003C/strong>: The minute when the yellow card was given.\u003C/td>\u003C/tr>\u003Ctr>\u003Ctd>\u003Cstrong>red_cards_away\u003C/strong>\u003C/td>\u003Ctd>A JSON array containing information about red cards received by players of the away team. Each object in the array includes: \u003Cbr> - \u003Cstrong>player\u003C/strong>: The name of the player who received the red card. \u003Cbr> - \u003Cstrong>minute\u003C/strong>: The minute when the red card was given.\u003C/td>\u003C/tr>\u003Ctr>\u003Ctd>\u003Cstrong>sec_card_home\u003C/strong>\u003C/td>\u003Ctd>A JSON array containing information about second yellow cards received by players of the home team. Each object in the array includes: \u003Cbr> - \u003Cstrong>player\u003C/strong>: The name of the player who received the second yellow card. \u003Cbr> - \u003Cstrong>minute\u003C/strong>: The minute when the second yellow card was given.\u003C/td>\u003C/tr>\u003Ctr>\u003Ctd>\u003Cstrong>sec_card_away\u003C/strong>\u003C/td>\u003Ctd>A JSON array containing information about second yellow cards received by players of the away team. Each object in the array includes: \u003Cbr> - \u003Cstrong>player\u003C/strong>: The name of the player who received the second yellow card. \u003Cbr> - \u003Cstrong>minute\u003C/strong>: The minute when the second yellow card was given.\u003C/td>\u003C/tr>\u003C/tbody>\u003C/table>\n\u003Ch3 id=\"extracting-goals-infos\">Extracting Goals Infos\u003C/h3>\n\u003Cp>The process for extracting goal information is quite similar to that of cards. The difference is that we will use the following classes:\u003C/p>\n\u003Cul>\n\u003Cli>\u003Ccode>Opta-Icon Opta-IconGoal\u003C/code> for a normal goal\u003C/li>\n\u003Cli>\u003Ccode>Opta-Icon Opta-IconOwn\u003C/code> for an own goal\u003C/li>\n\u003Cli>\u003Ccode>Opta-Icon Opta-IconPenGoal\u003C/code> for a penalty goal\u003C/li>\n\u003C/ul>\n\u003Cp>The code then looks like this:\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">#keep the same libraries and driver configuration from the previous code.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">home_events_list \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> soup.find_all(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'ul'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#FFAB70\">class_\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'Opta-Events Opta-Home'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">events_home \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> []\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">for\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> home_events \u003C/span>\u003Cspan style=\"color:#F97583\">in\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> home_events_list:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    events_home.extend(home_events.find_all(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'li'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#FFAB70\">class_\u003C/span>\u003Cspan style=\"color:#F97583\">=lambda\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> x: x \u003C/span>\u003Cspan style=\"color:#F97583\">and\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> x.startswith(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'Opta-MatchEvent Opta-Event-Type'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)))\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">gols_home \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> []\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">for\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> event \u003C/span>\u003Cspan style=\"color:#F97583\">in\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> events_home:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    minute \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> event.find(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'span'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#FFAB70\">class_\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'Opta-Event-Min'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">).text.strip().replace(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'\u003C/span>\u003Cspan style=\"color:#79B8FF\">\\u200e\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">''\u003C/span>\u003Cspan style=\"color:#E1E4E8\">).replace(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'\u003C/span>\u003Cspan style=\"color:#79B8FF\">\\u200f\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">''\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    if\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> event.find(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'p'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#FFAB70\">class_\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'Opta-Icon Opta-IconGoal'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">):\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        player_img \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> event.find(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'img'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        if\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> player_img \u003C/span>\u003Cspan style=\"color:#F97583\">and\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> 'alt'\u003C/span>\u003Cspan style=\"color:#F97583\"> in\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> player_img.attrs:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            player \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> player_img[\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'alt'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">].strip()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        else\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            player \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> \"undefined\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        gols_home.append({\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'player'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: player, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">'minute'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: minute, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">'cont'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#79B8FF\">0\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">'penal'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#79B8FF\">0\u003C/span>\u003Cspan style=\"color:#E1E4E8\">})\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    elif\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> event.find(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'p'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#FFAB70\">class_\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'Opta-Icon Opta-IconOwn'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">):\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        player_img \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> event.find(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'img'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        if\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> player_img \u003C/span>\u003Cspan style=\"color:#F97583\">and\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> 'alt'\u003C/span>\u003Cspan style=\"color:#F97583\"> in\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> player_img.attrs:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            player \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> player_img[\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'alt'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">].strip()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        else\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            player \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> \"undefined\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        gols_home.append({\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'player'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: player, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">'minute'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: minute, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">'cont'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#79B8FF\">1\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">'penal'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#79B8FF\">0\u003C/span>\u003Cspan style=\"color:#E1E4E8\">})\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    elif\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> event.find(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'p'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#FFAB70\">class_\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'Opta-Icon Opta-IconPenGoal'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">):\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        player_img \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> event.find(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'img'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        if\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> player_img \u003C/span>\u003Cspan style=\"color:#F97583\">and\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> 'alt'\u003C/span>\u003Cspan style=\"color:#F97583\"> in\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> player_img.attrs:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            player \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> player_img[\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'alt'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">].strip()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        else\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            player \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> \"undefined\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        gols_home.append({\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'player'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: player, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">'minute'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: minute, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">'cont'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#79B8FF\">0\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">'penal'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#79B8FF\">1\u003C/span>\u003Cspan style=\"color:#E1E4E8\">})\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">away_events_list \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> soup.find_all(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'ul'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#FFAB70\">class_\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'Opta-Events Opta-Away'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">#events AWAY\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">events_away \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> []\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">for\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> away_events \u003C/span>\u003Cspan style=\"color:#F97583\">in\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> away_events_list:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    events_away.extend(away_events.find_all(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'li'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#FFAB70\">class_\u003C/span>\u003Cspan style=\"color:#F97583\">=lambda\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> x: x \u003C/span>\u003Cspan style=\"color:#F97583\">and\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> x.startswith(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'Opta-MatchEvent Opta-Event-Type'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)))\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">gols_away \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> []\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">for\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> event \u003C/span>\u003Cspan style=\"color:#F97583\">in\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> events_away:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    minute \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> event.find(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'span'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#FFAB70\">class_\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'Opta-Event-Min'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">).text.strip().replace(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'\u003C/span>\u003Cspan style=\"color:#79B8FF\">\\u200e\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">''\u003C/span>\u003Cspan style=\"color:#E1E4E8\">).replace(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'\u003C/span>\u003Cspan style=\"color:#79B8FF\">\\u200f\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">''\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    if\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> event.find(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'p'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#FFAB70\">class_\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'Opta-Icon Opta-IconGoal'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">):\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        player_img \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> event.find(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'img'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        if\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> player_img \u003C/span>\u003Cspan style=\"color:#F97583\">and\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> 'alt'\u003C/span>\u003Cspan style=\"color:#F97583\"> in\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> player_img.attrs:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            player \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> player_img[\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'alt'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">].strip()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        else\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            player \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> \"undefined\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        gols_away.append({\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'player'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: player, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">'minute'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: minute, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">'cont'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#79B8FF\">0\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">'penal'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#79B8FF\">0\u003C/span>\u003Cspan style=\"color:#E1E4E8\">})\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    elif\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> event.find(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'p'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#FFAB70\">class_\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'Opta-Icon Opta-IconOwn'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">):\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        player_img \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> event.find(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'img'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        if\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> player_img \u003C/span>\u003Cspan style=\"color:#F97583\">and\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> 'alt'\u003C/span>\u003Cspan style=\"color:#F97583\"> in\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> player_img.attrs:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            player \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> player_img[\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'alt'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">].strip()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        else\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            player \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> \"undefined\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        gols_away.append({\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'player'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: player, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">'minute'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: minute, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">'cont'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#79B8FF\">1\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">'penal'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#79B8FF\">0\u003C/span>\u003Cspan style=\"color:#E1E4E8\">})\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    elif\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> event.find(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'p'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#FFAB70\">class_\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'Opta-Icon Opta-IconPenGoal'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">):\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        player_img \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> event.find(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'img'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        if\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> player_img \u003C/span>\u003Cspan style=\"color:#F97583\">and\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> 'alt'\u003C/span>\u003Cspan style=\"color:#F97583\"> in\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> player_img.attrs:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            player \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> player_img[\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'alt'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">].strip()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        else\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            player \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> \"undefined\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        gols_away.append({\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'player'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: player, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">'minute'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: minute, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">'cont'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#79B8FF\">0\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">'penal'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#79B8FF\">1\u003C/span>\u003Cspan style=\"color:#E1E4E8\">})\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>With this code, we then create two variables that store the goals of the home team and the away team in the format below:\u003C/p>\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\u003Ctable>\u003Cthead>\u003Ctr>\u003Cth>var\u003C/th>\u003Cth>Description\u003C/th>\u003C/tr>\u003C/thead>\u003Ctbody>\u003Ctr>\u003Ctd>\u003Cstrong>gols_home\u003C/strong>\u003C/td>\u003Ctd>A JSON array containing information about goals scored by players of the home team. Each object in the array includes: \u003Cbr> - \u003Cstrong>player\u003C/strong>: The name of the player who scored the goal. \u003Cbr> - \u003Cstrong>minute\u003C/strong>: The minute when the goal was scored. \u003Cbr> - \u003Cstrong>cont\u003C/strong>: Indicates if the goal was an own goal (1 for own goal, 0 otherwise). \u003Cbr> - \u003Cstrong>penal\u003C/strong>: Indicates if the goal was a penalty (1 for penalty, 0 otherwise).\u003C/td>\u003C/tr>\u003Ctr>\u003Ctd>\u003Cstrong>gols_away\u003C/strong>\u003C/td>\u003Ctd>A JSON array containing information about goals scored by players of the away team. Each object in the array includes: \u003Cbr> - \u003Cstrong>player\u003C/strong>: The name of the player who scored the goal. \u003Cbr> - \u003Cstrong>minute\u003C/strong>: The minute when the goal was scored. \u003Cbr> - \u003Cstrong>cont\u003C/strong>: Indicates if the goal was an own goal (1 for own goal, 0 otherwise). \u003Cbr> - \u003Cstrong>penal\u003C/strong>: Indicates if the goal was a penalty (1 for penalty, 0 otherwise).\u003C/td>\u003C/tr>\u003C/tbody>\u003C/table>\n\u003Ch2 id=\"conclusions\">Conclusions\u003C/h2>\n\u003Cp>With the information provided here, it is possible to build a program that extracts football match information from any championship available at optaplayerstats.statsperform.com. The link to this complete project is on \u003Ca href=\"https://github.com/lucasbral/fut_scrap/tree/main\">GitHub\u003C/a>.\u003C/p>\n\u003Cp>By using this program, it was possible to create a dataset with the data from all matches of the Brasileirão from 2020 to 2023, which can be found at this link on \u003Ca href=\"https://www.kaggle.com/datasets/lucasbral/brasileirao-cartoes-20-23/\">Kaggle\u003C/a>.\u003C/p>",{"headings":97,"localImagePaths":128,"remoteImagePaths":129,"frontmatter":130,"imagePaths":135},[98,101,104,107,110,113,116,119,122,125],{"depth":32,"slug":99,"text":100},"motivation","Motivation",{"depth":32,"slug":102,"text":103},"studying-the-website-and-defining-variables","Studying the Website and Defining Variables",{"depth":32,"slug":105,"text":106},"extracting-matchs-links","Extracting Matchs Links",{"depth":32,"slug":108,"text":109},"match-data","Match Data",{"depth":32,"slug":111,"text":112},"extracting-match-data","Extracting Match Data",{"depth":36,"slug":114,"text":115},"extracting-teams-infos","Extracting Teams Infos",{"depth":36,"slug":117,"text":118},"extracting-matchs-infos","Extracting Matchs Infos",{"depth":36,"slug":120,"text":121},"extracting-cards-infos","Extracting Cards Infos",{"depth":36,"slug":123,"text":124},"extracting-goals-infos","Extracting Goals Infos",{"depth":32,"slug":126,"text":127},"conclusions","Conclusions",[],[],{"title":81,"description":82,"date":131,"categories":132,"tags":133,"image":134,"render_with_liquid":76},"2024-11-03 14:10:00 +0800",[20,87],[89,90],{"path":85},[],"2025-02-25/2025-02-25-aws-pipeline",{"id":136,"data":138,"body":148,"filePath":149,"digest":150,"rendered":151},{"title":139,"description":140,"date":141,"image":142,"categories":144,"tags":147},"Creating A Small Data Pipeline Using Dynamodb And Lambda Functions On Aws","In This Project We Will Create A Small Pipeline Inside The Aws Enviroment Using The Free Tier For Practicing Aws Tools.",["Date","2025-02-24T16:00:00.000Z"],{"path":143},"/assets/posts/2025-02-25/aws.png",[20,145,146],"AWS","Lambda",[145],"## Introduction\n\nIn This Project We Will Create A Small Pipeline Inside The Aws Enviroment Using The Free Tier For Practicing Aws Tools.\n\n## 🚀 Project Overview  \n\n- **Data Ingestion**: An **API Gateway** triggers a **Lambda function** to insert data into **DynamoDB**.  \n- **Data Processing**: The function processes the data from an **HTTP request**.  \n- **Scheduled Tasks**: An **EventBridge rule** triggers a **Lambda function** on a schedule (every day) to perform ]:  \n  - Data processing \n- **Monitoring**: Use **CloudWatch** to monitor logs and set up basic alarms for:  \n  - Failures  \n  - Performance issues  \n\n\n## 1 - DynamoDB\n\nFirst, we will create a new DynamoDB table within the AWS Management Console.\nAmazon **DynamoDB** is a fully managed **NoSQL database service** offered by AWS, designed for **high-performance, low-latency applications**. It provides **seamless scalability**, allowing you to handle large amounts of data with **consistent single-digit millisecond response times**.  \n\n- Supports both **key-value** and **document** data structures, making it flexible for various use cases.  \n- Offers features like:  \n  - **Automatic scaling**  \n  - **Backup and restore**  \n  - **DynamoDB Streams** for real-time data processing  \n- Being **serverless**, it eliminates the need for manual infrastructure management.  \n- Ensures **high availability and security** by default. \n\n### 1.1 Acessing DynamoDB in AWS Console\n\nIn the search bar, type `DynamoDB` and select it from the results.\n\n![desktop View](/assets/posts/2025-02-25/1.png)\n_Amazon Console UI_\n\nIn the DynamoDB page, select `Tables` from the navigation panel on the left and `Create Table` select id as hash , this is going to be our target vairable and we will set it as a number.\n\n![desktop View](/assets/posts/2025-02-25/2.png)\n_Tables from DynamoDB_\n\n![desktop View](/assets/posts/2025-02-25/3.png)\n_Create Table from DynamoDB_\n\n### 1.2 Configuring Your DynamoDB Table  \n\nHere, we will provide all the necessary information for our **DynamoDB table**.  \n\n- In **Table name**, enter the name for your table (**ensure it follows AWS naming conventions**).  \n- In **Partition key**, define the unique data attribute that will be used.  \n  - In this case, it's the **ID**, configured as a **number**.  \n- For **Table settings**, leave the **default options** as they are.  \n- Then, select **Create table**.  \n\nAfter that, we will be able to see our new table in the UI:\n\n![desktop View](/assets/posts/2025-02-25/4.png)\n_Table Created in DynamoDB_\n\n## 2 - Lambda Function\n\nNow, we will create our Lambda function, which will be responsible for accessing the `API` and retrieving `JSON` data with the desired resources.\n\n### 2.1 API Overview  \n\nThe API we will be using is available at [Yu-Gi-Oh! API Guide](https://ygoprodeck.com/api-guide/). This API returns all **Yu-Gi-Oh! cards** available at the time of the request.  \n\n- The **Card Information** endpoint is available at:  \n  [https://db.ygoprodeck.com/api/v7/cardinfo.php](https://db.ygoprodeck.com/api/v7/cardinfo.php)  \n\n- It will return data in the following format:  \n\n```json\n{\n  \"data\": [\n    {\n      \"id\": 6983839,\n      \"name\": \"Tornado Dragon\",\n      \"type\": \"XYZ Monster\",\n      \"frameType\": \"xyz\",\n      \"desc\": \"2 Level 4 monsters\\nOnce per turn (Quick Effect): You can detach 1 material from this card, then target 1 Spell/Trap on the field; destroy it.\",\n      \"atk\": 2100,\n      \"def\": 2000,\n      \"level\": 4,\n      \"race\": \"Wyrm\",\n      \"attribute\": \"WIND\",\n      \"card_sets\": [\n        {\n          \"set_name\": \"Battles of Legend: Relentless Revenge\",\n          \"set_code\": \"BLRR-EN084\",\n          \"set_rarity\": \"Secret Rare\",\n          \"set_rarity_code\": \"(ScR)\",\n          \"set_price\": \"4.08\"\n        },\n        {\n          \"set_name\": \"Duel Devastator\",\n          \"set_code\": \"DUDE-EN019\",\n          \"set_rarity\": \"Ultra Rare\",\n          \"set_rarity_code\": \"(UR)\",\n          \"set_price\": \"1.4\"\n        },\n        {\n          \"set_name\": \"Maximum Crisis\",\n          \"set_code\": \"MACR-EN081\",\n          \"set_rarity\": \"Secret Rare\",\n          \"set_rarity_code\": \"(ScR)\",\n          \"set_price\": \"4.32\"\n        }\n      ],\n      \"card_images\": [\n        {\n          \"id\": 6983839,\n          \"image_url\": \"https://images.ygoprodeck.com/images/cards/6983839.jpg\",\n          \"image_url_small\": \"https://images.ygoprodeck.com/images/cards_small/6983839.jpg\",\n          \"image_url_cropped\": \"https://images.ygoprodeck.com/images/cards_cropped/6983839.jpg\"\n        }\n      ],\n      \"card_prices\": [\n        {\n          \"cardmarket_price\": \"0.42\",\n          \"tcgplayer_price\": \"0.48\",\n          \"ebay_price\": \"2.99\",\n          \"amazon_price\": \"0.77\",\n          \"coolstuffinc_price\": \"0.99\"\n        }\n      ]\n    }\n  ]\n}\n```\n\nThis data will be returned for all available Yu-Gi-Oh! cards.\n\n### 2.2 Creating Lambda Function\n\nNow, we need to create the `Lambda function` responsible for making the `API request` and saving the data in `DynamoDB`.  \n\nTo do this:  \n- Go to the `AWS Management Console`.  \n- Type `Lambda` in the search bar.  \n- Select `Lambda` from the results. \n- Select Create A Function\n\n![desktop View](/assets/posts/2025-02-25/5.png)\n_Create Lambda Function_\n\n### 2.2 Define the Lambda Function  \n\n- **Author from Scratch**: Choose **Author from Scratch** to create a new Lambda function.  \n- **Function Name**: Define a name for your function (e.g., `FetchYuGiOhCards`).  \n- **Runtime**: Select **Python 3.13** as the runtime.  \n- **Architecture**: Choose **ARM64** architecture (this is more cost-effective compared to `x86_64`).  \n- **Execution Role**:  \n  - Collapse the **default execution role** section.  \n  - Select **Create a new role from AWS policy templates**.  \n- **Role Name & Policy Templates**:  \n  - Define a name for the role (e.g., `LambdaDynamoDBRole`).  \n  - In the **Policy templates** section, choose templates related to **DynamoDB** (e.g., `AmazonDynamoDBFullAccess`). \n  - Select create function \n\n\n> - Depending on the processing time, you may need to increase the `timeout` and `memory` settings for your function. In my case, I set the `timeout` to 15 minutes** and `memory` to 500MB.  Be cautious, as increasing these settings **can lead to higher costs**. \n{: .prompt-tip }\n\n\n![desktop View](/assets/posts/2025-02-25/6.png)\n_Lambda Function Settings_\n\n### 2.3 Definig Python Code\n\nNow, we need to define the Python code required to run our program.\nYou can either use the AWS Management Console’s built-in editor or upload your code from a local device.\nIn this case, we will use the requests library in Python, which is not included by default in AWS Lambda. Therefore, we need to import it manually.\nSo, we will create a new directory on my Linux Mint machine to begin the development process (or other device).\n\n\nIn this directory, we will create a file named `lambda_function.py`, which will contain our Python code for the Lambda function.\nSince the **requests** library is not available by default in AWS Lambda, we need to install it manually. Open a terminal in your project directory and run the following command:\n\n```bash\npip install requests -t .\n```\n- This installs the requests library \n- -t .: Specifies the target directory (. means the current directory from your project).\n\n> - This is commonly used for AWS Lambda deployments, where you need to package dependencies in the same directory as your Lambda function before uploading it as a ZIP file.\n{: .prompt-tip }\n\nNow, your project directory should look something like this:  \n\n```text\n/my-lambda-project\n│\n├── lambda_function.py\n├── requests/\n├── requests-*.dist-info/\n├── urllib3/\n└── ...\n```\n\n\n### 2.4 Setting the Python Function\n\nOur Python code will primarily use three libraries:  \n\n- **requests** – Handles HTTP requests.  \n- **boto3** – Manages AWS infrastructure.  \n- **json** – Processes JSON data.  \n\nThe Python code is provided below:  \n\n\n```python\nimport json\nimport boto3\nimport requests\n\n# Initializes the DynamoDB client\ndynamodb = boto3.resource('dynamodb')\ntable = dynamodb.Table('yugioh_cards_db')\n\ndef lambda_handler(event, context):\n    # URL for the JSON API\n    url = \"https://db.ygoprodeck.com/api/v7/cardinfo.php?misc=yes\"\n    \n    # Make the request to fetch the data from the API\n    try:\n        response = requests.get(url)  # Send GET request to the URL\n        response.raise_for_status()  # Check if the request was successful (status code 200)\n        data = response.json()  # Parse the JSON response\n        \n        # Write data to DynamoDB using batch_writer for efficiency\n        with table.batch_writer() as batch:\n            for card in data['data']:  # Loop through each card in the response\n                # Convert dictionary or list values to strings to avoid issues with DynamoDB storage\n                item = {key: str(value) if isinstance(value, (dict, list)) else value for key, value in card.items()}\n                batch.put_item(Item=item)  # Put each card as an item in the DynamoDB table\n            \n        return {\n            'statusCode': 'ok',\n            'body': 'success!'  # Return success message\n        }\n\n    # Handle any request-related errors\n    except requests.exceptions.RequestException as e:\n        return {\n            'statusCode': 'error',\n            'body': f'Error fetching data from API: {str(e)}'  # Return error message\n        }\n    \n    # Handle any other general errors (e.g., DynamoDB write issues)\n    except Exception as e:\n        return {\n            'statusCode': 'error',\n            'body': f'Error writing to DynamoDB: {str(e)}'  # Return error message\n        }\n\n```\n> - We use `table.batch_writer()` to optimize writes to DynamoDB by reducing the number of requests. However, make sure your IAM role has the necessary permissions; otherwise, the operation will fail with an error.  \n{: .prompt-danger }\n\nNow, zip all the folders and upload the archive to the AWS Lambda console.  \n\n![desktop View](/assets/posts/2025-02-25/9.png)\n_Lambda Function Defined_\n\nSelect `Deploy` and Then `Test` \n\n#### 2.5 Testing Code\n\nIn the test menu Create any test and execute it.\n\n\n![desktop View](/assets/posts/2025-02-25/10.png)\n_Lambda Function Test Return_\n\nOur code is working! 🎉 Now, you can view the data in the DynamoDB console.  \n\nIn the search bar, type `DynamoDB` and select it from the results.\n\nIn the DynamoDB page, select `Explore Itens` and then your table.\n\nYou should see something like:\n\n![desktop View](/assets/posts/2025-02-25/11.png)\n_DynamoDB table With Data_\n\nAs you can see, this is the information for Yu-Gi-Oh! cards—listing all available cards from the API.  \n\n## 3 - EventBridge\n\nNow that our pipeline is working, we need to set up scheduling to run every day at 10 AM. To achieve this, we will use **EventBridge**.  \nReturn to the Lambda Console and in you function select **Add trigger**\n\n\n![desktop View](/assets/posts/2025-02-25/12.png)\n_Lambda Function Add trigger_\n\nTo configure the trigger, follow these steps:  \n\n- Select **EventBridge (CloudWatch Events)**.  \n- Choose **Create a new role**.  \n- Set the **Rule Name** to `run_every_day`.  \n- For **Rule Type**, select **Schedule Expression**.  \n- In **Schedule Expression**, enter: `cron(0 10 * * ? *)`.  \n\n![desktop View](/assets/posts/2025-02-25/13.png)\n_Lambda Function Add trigger Settings_\n\nSelect `add` \n\nFinally, our project is fully configured to run **automatically every day at 10 AM**, updating the **DynamoDB database** with the latest **Yu-Gi-Oh! cards** from the API. 🚀  \n\n![desktop View](/assets/posts/2025-02-25/14.png)\n_Pipeline With All Steps_\n\n## Conclusions \n\nWe successfully built a fully functional **AWS Lambda pipeline** that fetches **Yu-Gi-Oh! card data** from an API and stores it in **DynamoDB**.  \n\n### Summary of What We Accomplished:  \n- **Set up a Lambda function** to request data from the API and write it to DynamoDB.  \n- **Configured IAM roles and permissions** to ensure proper access.  \n- **Optimized database writes** using `batch_writer()`.  \n- **Verified data storage** by checking the DynamoDB console.  \n- **Automated execution** using **EventBridge** to run the function daily at **10 AM UTC**.  \n\nWith this setup, our pipeline ensures that our DynamoDB table stays updated with the latest card data every day. 🚀","src/content/blog/2025-02-25/2025-02-25-aws-pipeline.md","6ca1253bb9296893",{"html":152,"metadata":153},"\u003Ch2 id=\"introduction\">Introduction\u003C/h2>\n\u003Cp>In This Project We Will Create A Small Pipeline Inside The Aws Enviroment Using The Free Tier For Practicing Aws Tools.\u003C/p>\n\u003Ch2 id=\"-project-overview\">🚀 Project Overview\u003C/h2>\n\u003Cul>\n\u003Cli>\u003Cstrong>Data Ingestion\u003C/strong>: An \u003Cstrong>API Gateway\u003C/strong> triggers a \u003Cstrong>Lambda function\u003C/strong> to insert data into \u003Cstrong>DynamoDB\u003C/strong>.\u003C/li>\n\u003Cli>\u003Cstrong>Data Processing\u003C/strong>: The function processes the data from an \u003Cstrong>HTTP request\u003C/strong>.\u003C/li>\n\u003Cli>\u003Cstrong>Scheduled Tasks\u003C/strong>: An \u003Cstrong>EventBridge rule\u003C/strong> triggers a \u003Cstrong>Lambda function\u003C/strong> on a schedule (every day) to perform ]:\n\u003Cul>\n\u003Cli>Data processing\u003C/li>\n\u003C/ul>\n\u003C/li>\n\u003Cli>\u003Cstrong>Monitoring\u003C/strong>: Use \u003Cstrong>CloudWatch\u003C/strong> to monitor logs and set up basic alarms for:\n\u003Cul>\n\u003Cli>Failures\u003C/li>\n\u003Cli>Performance issues\u003C/li>\n\u003C/ul>\n\u003C/li>\n\u003C/ul>\n\u003Ch2 id=\"1---dynamodb\">1 - DynamoDB\u003C/h2>\n\u003Cp>First, we will create a new DynamoDB table within the AWS Management Console.\nAmazon \u003Cstrong>DynamoDB\u003C/strong> is a fully managed \u003Cstrong>NoSQL database service\u003C/strong> offered by AWS, designed for \u003Cstrong>high-performance, low-latency applications\u003C/strong>. It provides \u003Cstrong>seamless scalability\u003C/strong>, allowing you to handle large amounts of data with \u003Cstrong>consistent single-digit millisecond response times\u003C/strong>.\u003C/p>\n\u003Cul>\n\u003Cli>Supports both \u003Cstrong>key-value\u003C/strong> and \u003Cstrong>document\u003C/strong> data structures, making it flexible for various use cases.\u003C/li>\n\u003Cli>Offers features like:\n\u003Cul>\n\u003Cli>\u003Cstrong>Automatic scaling\u003C/strong>\u003C/li>\n\u003Cli>\u003Cstrong>Backup and restore\u003C/strong>\u003C/li>\n\u003Cli>\u003Cstrong>DynamoDB Streams\u003C/strong> for real-time data processing\u003C/li>\n\u003C/ul>\n\u003C/li>\n\u003Cli>Being \u003Cstrong>serverless\u003C/strong>, it eliminates the need for manual infrastructure management.\u003C/li>\n\u003Cli>Ensures \u003Cstrong>high availability and security\u003C/strong> by default.\u003C/li>\n\u003C/ul>\n\u003Ch3 id=\"11-acessing-dynamodb-in-aws-console\">1.1 Acessing DynamoDB in AWS Console\u003C/h3>\n\u003Cp>In the search bar, type \u003Ccode>DynamoDB\u003C/code> and select it from the results.\u003C/p>\n\u003Cp>\u003Cimg src=\"/assets/posts/2025-02-25/1.png\" alt=\"desktop View\">\n\u003Cem>Amazon Console UI\u003C/em>\u003C/p>\n\u003Cp>In the DynamoDB page, select \u003Ccode>Tables\u003C/code> from the navigation panel on the left and \u003Ccode>Create Table\u003C/code> select id as hash , this is going to be our target vairable and we will set it as a number.\u003C/p>\n\u003Cp>\u003Cimg src=\"/assets/posts/2025-02-25/2.png\" alt=\"desktop View\">\n\u003Cem>Tables from DynamoDB\u003C/em>\u003C/p>\n\u003Cp>\u003Cimg src=\"/assets/posts/2025-02-25/3.png\" alt=\"desktop View\">\n\u003Cem>Create Table from DynamoDB\u003C/em>\u003C/p>\n\u003Ch3 id=\"12-configuring-your-dynamodb-table\">1.2 Configuring Your DynamoDB Table\u003C/h3>\n\u003Cp>Here, we will provide all the necessary information for our \u003Cstrong>DynamoDB table\u003C/strong>.\u003C/p>\n\u003Cul>\n\u003Cli>In \u003Cstrong>Table name\u003C/strong>, enter the name for your table (\u003Cstrong>ensure it follows AWS naming conventions\u003C/strong>).\u003C/li>\n\u003Cli>In \u003Cstrong>Partition key\u003C/strong>, define the unique data attribute that will be used.\n\u003Cul>\n\u003Cli>In this case, it’s the \u003Cstrong>ID\u003C/strong>, configured as a \u003Cstrong>number\u003C/strong>.\u003C/li>\n\u003C/ul>\n\u003C/li>\n\u003Cli>For \u003Cstrong>Table settings\u003C/strong>, leave the \u003Cstrong>default options\u003C/strong> as they are.\u003C/li>\n\u003Cli>Then, select \u003Cstrong>Create table\u003C/strong>.\u003C/li>\n\u003C/ul>\n\u003Cp>After that, we will be able to see our new table in the UI:\u003C/p>\n\u003Cp>\u003Cimg src=\"/assets/posts/2025-02-25/4.png\" alt=\"desktop View\">\n\u003Cem>Table Created in DynamoDB\u003C/em>\u003C/p>\n\u003Ch2 id=\"2---lambda-function\">2 - Lambda Function\u003C/h2>\n\u003Cp>Now, we will create our Lambda function, which will be responsible for accessing the \u003Ccode>API\u003C/code> and retrieving \u003Ccode>JSON\u003C/code> data with the desired resources.\u003C/p>\n\u003Ch3 id=\"21-api-overview\">2.1 API Overview\u003C/h3>\n\u003Cp>The API we will be using is available at \u003Ca href=\"https://ygoprodeck.com/api-guide/\">Yu-Gi-Oh! API Guide\u003C/a>. This API returns all \u003Cstrong>Yu-Gi-Oh! cards\u003C/strong> available at the time of the request.\u003C/p>\n\u003Cul>\n\u003Cli>\n\u003Cp>The \u003Cstrong>Card Information\u003C/strong> endpoint is available at:\u003Cbr>\n\u003Ca href=\"https://db.ygoprodeck.com/api/v7/cardinfo.php\">https://db.ygoprodeck.com/api/v7/cardinfo.php\u003C/a>\u003C/p>\n\u003C/li>\n\u003Cli>\n\u003Cp>It will return data in the following format:\u003C/p>\n\u003C/li>\n\u003C/ul>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"json\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">{\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">  \"data\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: [\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">      \"id\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#79B8FF\">6983839\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">      \"name\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"Tornado Dragon\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">      \"type\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"XYZ Monster\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">      \"frameType\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"xyz\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">      \"desc\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"2 Level 4 monsters\u003C/span>\u003Cspan style=\"color:#79B8FF\">\\n\u003C/span>\u003Cspan style=\"color:#9ECBFF\">Once per turn (Quick Effect): You can detach 1 material from this card, then target 1 Spell/Trap on the field; destroy it.\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">      \"atk\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#79B8FF\">2100\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">      \"def\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#79B8FF\">2000\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">      \"level\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#79B8FF\">4\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">      \"race\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"Wyrm\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">      \"attribute\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"WIND\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">      \"card_sets\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: [\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">          \"set_name\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"Battles of Legend: Relentless Revenge\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">          \"set_code\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"BLRR-EN084\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">          \"set_rarity\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"Secret Rare\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">          \"set_rarity_code\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"(ScR)\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">          \"set_price\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"4.08\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        },\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">          \"set_name\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"Duel Devastator\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">          \"set_code\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"DUDE-EN019\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">          \"set_rarity\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"Ultra Rare\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">          \"set_rarity_code\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"(UR)\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">          \"set_price\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"1.4\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        },\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">          \"set_name\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"Maximum Crisis\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">          \"set_code\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"MACR-EN081\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">          \"set_rarity\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"Secret Rare\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">          \"set_rarity_code\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"(ScR)\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">          \"set_price\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"4.32\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      ],\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">      \"card_images\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: [\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">          \"id\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#79B8FF\">6983839\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">          \"image_url\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"https://images.ygoprodeck.com/images/cards/6983839.jpg\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">          \"image_url_small\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"https://images.ygoprodeck.com/images/cards_small/6983839.jpg\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">          \"image_url_cropped\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"https://images.ygoprodeck.com/images/cards_cropped/6983839.jpg\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      ],\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">      \"card_prices\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: [\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">          \"cardmarket_price\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"0.42\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">          \"tcgplayer_price\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"0.48\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">          \"ebay_price\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"2.99\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">          \"amazon_price\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"0.77\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">          \"coolstuffinc_price\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"0.99\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      ]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">  ]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>This data will be returned for all available Yu-Gi-Oh! cards.\u003C/p>\n\u003Ch3 id=\"22-creating-lambda-function\">2.2 Creating Lambda Function\u003C/h3>\n\u003Cp>Now, we need to create the \u003Ccode>Lambda function\u003C/code> responsible for making the \u003Ccode>API request\u003C/code> and saving the data in \u003Ccode>DynamoDB\u003C/code>.\u003C/p>\n\u003Cp>To do this:\u003C/p>\n\u003Cul>\n\u003Cli>Go to the \u003Ccode>AWS Management Console\u003C/code>.\u003C/li>\n\u003Cli>Type \u003Ccode>Lambda\u003C/code> in the search bar.\u003C/li>\n\u003Cli>Select \u003Ccode>Lambda\u003C/code> from the results.\u003C/li>\n\u003Cli>Select Create A Function\u003C/li>\n\u003C/ul>\n\u003Cp>\u003Cimg src=\"/assets/posts/2025-02-25/5.png\" alt=\"desktop View\">\n\u003Cem>Create Lambda Function\u003C/em>\u003C/p>\n\u003Ch3 id=\"22-define-the-lambda-function\">2.2 Define the Lambda Function\u003C/h3>\n\u003Cul>\n\u003Cli>\u003Cstrong>Author from Scratch\u003C/strong>: Choose \u003Cstrong>Author from Scratch\u003C/strong> to create a new Lambda function.\u003C/li>\n\u003Cli>\u003Cstrong>Function Name\u003C/strong>: Define a name for your function (e.g., \u003Ccode>FetchYuGiOhCards\u003C/code>).\u003C/li>\n\u003Cli>\u003Cstrong>Runtime\u003C/strong>: Select \u003Cstrong>Python 3.13\u003C/strong> as the runtime.\u003C/li>\n\u003Cli>\u003Cstrong>Architecture\u003C/strong>: Choose \u003Cstrong>ARM64\u003C/strong> architecture (this is more cost-effective compared to \u003Ccode>x86_64\u003C/code>).\u003C/li>\n\u003Cli>\u003Cstrong>Execution Role\u003C/strong>:\n\u003Cul>\n\u003Cli>Collapse the \u003Cstrong>default execution role\u003C/strong> section.\u003C/li>\n\u003Cli>Select \u003Cstrong>Create a new role from AWS policy templates\u003C/strong>.\u003C/li>\n\u003C/ul>\n\u003C/li>\n\u003Cli>\u003Cstrong>Role Name &#x26; Policy Templates\u003C/strong>:\n\u003Cul>\n\u003Cli>Define a name for the role (e.g., \u003Ccode>LambdaDynamoDBRole\u003C/code>).\u003C/li>\n\u003Cli>In the \u003Cstrong>Policy templates\u003C/strong> section, choose templates related to \u003Cstrong>DynamoDB\u003C/strong> (e.g., \u003Ccode>AmazonDynamoDBFullAccess\u003C/code>).\u003C/li>\n\u003Cli>Select create function\u003C/li>\n\u003C/ul>\n\u003C/li>\n\u003C/ul>\n\u003Cblockquote>\n\u003Cul>\n\u003Cli>Depending on the processing time, you may need to increase the \u003Ccode>timeout\u003C/code> and \u003Ccode>memory\u003C/code> settings for your function. In my case, I set the \u003Ccode>timeout\u003C/code> to 15 minutes** and \u003Ccode>memory\u003C/code> to 500MB.  Be cautious, as increasing these settings \u003Cstrong>can lead to higher costs\u003C/strong>.\n{: .prompt-tip }\u003C/li>\n\u003C/ul>\n\u003C/blockquote>\n\u003Cp>\u003Cimg src=\"/assets/posts/2025-02-25/6.png\" alt=\"desktop View\">\n\u003Cem>Lambda Function Settings\u003C/em>\u003C/p>\n\u003Ch3 id=\"23-definig-python-code\">2.3 Definig Python Code\u003C/h3>\n\u003Cp>Now, we need to define the Python code required to run our program.\nYou can either use the AWS Management Console’s built-in editor or upload your code from a local device.\nIn this case, we will use the requests library in Python, which is not included by default in AWS Lambda. Therefore, we need to import it manually.\nSo, we will create a new directory on my Linux Mint machine to begin the development process (or other device).\u003C/p>\n\u003Cp>In this directory, we will create a file named \u003Ccode>lambda_function.py\u003C/code>, which will contain our Python code for the Lambda function.\nSince the \u003Cstrong>requests\u003C/strong> library is not available by default in AWS Lambda, we need to install it manually. Open a terminal in your project directory and run the following command:\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"bash\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">pip\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> install\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> requests\u003C/span>\u003Cspan style=\"color:#79B8FF\"> -t\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> .\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cul>\n\u003Cli>This installs the requests library\u003C/li>\n\u003Cli>-t .: Specifies the target directory (. means the current directory from your project).\u003C/li>\n\u003C/ul>\n\u003Cblockquote>\n\u003Cul>\n\u003Cli>This is commonly used for AWS Lambda deployments, where you need to package dependencies in the same directory as your Lambda function before uploading it as a ZIP file.\n{: .prompt-tip }\u003C/li>\n\u003C/ul>\n\u003C/blockquote>\n\u003Cp>Now, your project directory should look something like this:\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"text\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan>/my-lambda-project\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>│\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>├── lambda_function.py\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>├── requests/\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>├── requests-*.dist-info/\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>├── urllib3/\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>└── ...\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch3 id=\"24-setting-the-python-function\">2.4 Setting the Python Function\u003C/h3>\n\u003Cp>Our Python code will primarily use three libraries:\u003C/p>\n\u003Cul>\n\u003Cli>\u003Cstrong>requests\u003C/strong> – Handles HTTP requests.\u003C/li>\n\u003Cli>\u003Cstrong>boto3\u003C/strong> – Manages AWS infrastructure.\u003C/li>\n\u003Cli>\u003Cstrong>json\u003C/strong> – Processes JSON data.\u003C/li>\n\u003C/ul>\n\u003Cp>The Python code is provided below:\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> json\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> boto3\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> requests\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># Initializes the DynamoDB client\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">dynamodb \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> boto3.resource(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'dynamodb'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">table \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> dynamodb.Table(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'yugioh_cards_db'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">def\u003C/span>\u003Cspan style=\"color:#B392F0\"> lambda_handler\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(event, context):\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    # URL for the JSON API\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    url \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> \"https://db.ygoprodeck.com/api/v7/cardinfo.php?misc=yes\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    \u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    # Make the request to fetch the data from the API\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    try\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        response \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> requests.get(url)  \u003C/span>\u003Cspan style=\"color:#6A737D\"># Send GET request to the URL\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        response.raise_for_status()  \u003C/span>\u003Cspan style=\"color:#6A737D\"># Check if the request was successful (status code 200)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        data \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> response.json()  \u003C/span>\u003Cspan style=\"color:#6A737D\"># Parse the JSON response\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        \u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">        # Write data to DynamoDB using batch_writer for efficiency\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        with\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> table.batch_writer() \u003C/span>\u003Cspan style=\"color:#F97583\">as\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> batch:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">            for\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> card \u003C/span>\u003Cspan style=\"color:#F97583\">in\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> data[\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'data'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]:  \u003C/span>\u003Cspan style=\"color:#6A737D\"># Loop through each card in the response\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">                # Convert dictionary or list values to strings to avoid issues with DynamoDB storage\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">                item \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {key: \u003C/span>\u003Cspan style=\"color:#79B8FF\">str\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(value) \u003C/span>\u003Cspan style=\"color:#F97583\">if\u003C/span>\u003Cspan style=\"color:#79B8FF\"> isinstance\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(value, (\u003C/span>\u003Cspan style=\"color:#79B8FF\">dict\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#79B8FF\">list\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)) \u003C/span>\u003Cspan style=\"color:#F97583\">else\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> value \u003C/span>\u003Cspan style=\"color:#F97583\">for\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> key, value \u003C/span>\u003Cspan style=\"color:#F97583\">in\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> card.items()}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">                batch.put_item(\u003C/span>\u003Cspan style=\"color:#FFAB70\">Item\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\">item)  \u003C/span>\u003Cspan style=\"color:#6A737D\"># Put each card as an item in the DynamoDB table\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            \u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        return\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">            'statusCode'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">'ok'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">            'body'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">'success!'\u003C/span>\u003Cspan style=\"color:#6A737D\">  # Return success message\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    # Handle any request-related errors\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    except\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> requests.exceptions.RequestException \u003C/span>\u003Cspan style=\"color:#F97583\">as\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> e:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        return\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">            'statusCode'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">'error'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">            'body'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#F97583\">f\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'Error fetching data from API: \u003C/span>\u003Cspan style=\"color:#79B8FF\">{str\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(e)\u003C/span>\u003Cspan style=\"color:#79B8FF\">}\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'\u003C/span>\u003Cspan style=\"color:#6A737D\">  # Return error message\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    \u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    # Handle any other general errors (e.g., DynamoDB write issues)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    except\u003C/span>\u003Cspan style=\"color:#79B8FF\"> Exception\u003C/span>\u003Cspan style=\"color:#F97583\"> as\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> e:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        return\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">            'statusCode'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">'error'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">            'body'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#F97583\">f\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'Error writing to DynamoDB: \u003C/span>\u003Cspan style=\"color:#79B8FF\">{str\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(e)\u003C/span>\u003Cspan style=\"color:#79B8FF\">}\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'\u003C/span>\u003Cspan style=\"color:#6A737D\">  # Return error message\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\u003C/code>\u003C/pre>\n\u003Cblockquote>\n\u003Cul>\n\u003Cli>We use \u003Ccode>table.batch_writer()\u003C/code> to optimize writes to DynamoDB by reducing the number of requests. However, make sure your IAM role has the necessary permissions; otherwise, the operation will fail with an error.\u003Cbr>\n{: .prompt-danger }\u003C/li>\n\u003C/ul>\n\u003C/blockquote>\n\u003Cp>Now, zip all the folders and upload the archive to the AWS Lambda console.\u003C/p>\n\u003Cp>\u003Cimg src=\"/assets/posts/2025-02-25/9.png\" alt=\"desktop View\">\n\u003Cem>Lambda Function Defined\u003C/em>\u003C/p>\n\u003Cp>Select \u003Ccode>Deploy\u003C/code> and Then \u003Ccode>Test\u003C/code>\u003C/p>\n\u003Ch4 id=\"25-testing-code\">2.5 Testing Code\u003C/h4>\n\u003Cp>In the test menu Create any test and execute it.\u003C/p>\n\u003Cp>\u003Cimg src=\"/assets/posts/2025-02-25/10.png\" alt=\"desktop View\">\n\u003Cem>Lambda Function Test Return\u003C/em>\u003C/p>\n\u003Cp>Our code is working! 🎉 Now, you can view the data in the DynamoDB console.\u003C/p>\n\u003Cp>In the search bar, type \u003Ccode>DynamoDB\u003C/code> and select it from the results.\u003C/p>\n\u003Cp>In the DynamoDB page, select \u003Ccode>Explore Itens\u003C/code> and then your table.\u003C/p>\n\u003Cp>You should see something like:\u003C/p>\n\u003Cp>\u003Cimg src=\"/assets/posts/2025-02-25/11.png\" alt=\"desktop View\">\n\u003Cem>DynamoDB table With Data\u003C/em>\u003C/p>\n\u003Cp>As you can see, this is the information for Yu-Gi-Oh! cards—listing all available cards from the API.\u003C/p>\n\u003Ch2 id=\"3---eventbridge\">3 - EventBridge\u003C/h2>\n\u003Cp>Now that our pipeline is working, we need to set up scheduling to run every day at 10 AM. To achieve this, we will use \u003Cstrong>EventBridge\u003C/strong>.\u003Cbr>\nReturn to the Lambda Console and in you function select \u003Cstrong>Add trigger\u003C/strong>\u003C/p>\n\u003Cp>\u003Cimg src=\"/assets/posts/2025-02-25/12.png\" alt=\"desktop View\">\n\u003Cem>Lambda Function Add trigger\u003C/em>\u003C/p>\n\u003Cp>To configure the trigger, follow these steps:\u003C/p>\n\u003Cul>\n\u003Cli>Select \u003Cstrong>EventBridge (CloudWatch Events)\u003C/strong>.\u003C/li>\n\u003Cli>Choose \u003Cstrong>Create a new role\u003C/strong>.\u003C/li>\n\u003Cli>Set the \u003Cstrong>Rule Name\u003C/strong> to \u003Ccode>run_every_day\u003C/code>.\u003C/li>\n\u003Cli>For \u003Cstrong>Rule Type\u003C/strong>, select \u003Cstrong>Schedule Expression\u003C/strong>.\u003C/li>\n\u003Cli>In \u003Cstrong>Schedule Expression\u003C/strong>, enter: \u003Ccode>cron(0 10 * * ? *)\u003C/code>.\u003C/li>\n\u003C/ul>\n\u003Cp>\u003Cimg src=\"/assets/posts/2025-02-25/13.png\" alt=\"desktop View\">\n\u003Cem>Lambda Function Add trigger Settings\u003C/em>\u003C/p>\n\u003Cp>Select \u003Ccode>add\u003C/code>\u003C/p>\n\u003Cp>Finally, our project is fully configured to run \u003Cstrong>automatically every day at 10 AM\u003C/strong>, updating the \u003Cstrong>DynamoDB database\u003C/strong> with the latest \u003Cstrong>Yu-Gi-Oh! cards\u003C/strong> from the API. 🚀\u003C/p>\n\u003Cp>\u003Cimg src=\"/assets/posts/2025-02-25/14.png\" alt=\"desktop View\">\n\u003Cem>Pipeline With All Steps\u003C/em>\u003C/p>\n\u003Ch2 id=\"conclusions\">Conclusions\u003C/h2>\n\u003Cp>We successfully built a fully functional \u003Cstrong>AWS Lambda pipeline\u003C/strong> that fetches \u003Cstrong>Yu-Gi-Oh! card data\u003C/strong> from an API and stores it in \u003Cstrong>DynamoDB\u003C/strong>.\u003C/p>\n\u003Ch3 id=\"summary-of-what-we-accomplished\">Summary of What We Accomplished:\u003C/h3>\n\u003Cul>\n\u003Cli>\u003Cstrong>Set up a Lambda function\u003C/strong> to request data from the API and write it to DynamoDB.\u003C/li>\n\u003Cli>\u003Cstrong>Configured IAM roles and permissions\u003C/strong> to ensure proper access.\u003C/li>\n\u003Cli>\u003Cstrong>Optimized database writes\u003C/strong> using \u003Ccode>batch_writer()\u003C/code>.\u003C/li>\n\u003Cli>\u003Cstrong>Verified data storage\u003C/strong> by checking the DynamoDB console.\u003C/li>\n\u003Cli>\u003Cstrong>Automated execution\u003C/strong> using \u003Cstrong>EventBridge\u003C/strong> to run the function daily at \u003Cstrong>10 AM UTC\u003C/strong>.\u003C/li>\n\u003C/ul>\n\u003Cp>With this setup, our pipeline ensures that our DynamoDB table stays updated with the latest card data every day. 🚀\u003C/p>",{"headings":154,"localImagePaths":197,"remoteImagePaths":198,"frontmatter":199,"imagePaths":204},[155,156,159,162,165,168,171,174,177,180,183,186,190,193,194],{"depth":32,"slug":33,"text":34},{"depth":32,"slug":157,"text":158},"-project-overview","🚀 Project Overview",{"depth":32,"slug":160,"text":161},"1---dynamodb","1 - DynamoDB",{"depth":36,"slug":163,"text":164},"11-acessing-dynamodb-in-aws-console","1.1 Acessing DynamoDB in AWS Console",{"depth":36,"slug":166,"text":167},"12-configuring-your-dynamodb-table","1.2 Configuring Your DynamoDB Table",{"depth":32,"slug":169,"text":170},"2---lambda-function","2 - Lambda Function",{"depth":36,"slug":172,"text":173},"21-api-overview","2.1 API Overview",{"depth":36,"slug":175,"text":176},"22-creating-lambda-function","2.2 Creating Lambda Function",{"depth":36,"slug":178,"text":179},"22-define-the-lambda-function","2.2 Define the Lambda Function",{"depth":36,"slug":181,"text":182},"23-definig-python-code","2.3 Definig Python Code",{"depth":36,"slug":184,"text":185},"24-setting-the-python-function","2.4 Setting the Python Function",{"depth":187,"slug":188,"text":189},4,"25-testing-code","2.5 Testing Code",{"depth":32,"slug":191,"text":192},"3---eventbridge","3 - EventBridge",{"depth":32,"slug":126,"text":127},{"depth":36,"slug":195,"text":196},"summary-of-what-we-accomplished","Summary of What We Accomplished:",[],[],{"title":139,"description":140,"date":200,"categories":201,"tags":202,"image":203,"render_with_liquid":76},"2025-02-25 00:00:00 +0800",[20,145,146],[145],{"path":143},[],"2024-11-11/2024-11-11-airflow",{"id":205,"data":207,"body":217,"filePath":218,"digest":219,"rendered":220},{"title":208,"description":209,"date":210,"image":211,"categories":213,"tags":216},"Apache Airflow Using Docker","Tutorial explaining how to install Apache Airflow using Docker.",["Date","2024-11-11T06:10:00.000Z"],{"path":212},"/assets/posts/2024-11-11/docker.png",[20,214,215],"Airflow","Docker",[214],"## Apache Airflow\n\nApache Airflow is an open-source platform used to orchestrate, schedule, and monitor workflows in data engineering. It allows users to define workflows as Directed Acyclic Graphs (DAGs), where each node represents a task, and the edges represent dependencies between tasks. Airflow is designed for managing complex, multi-step data pipelines and automating the execution of tasks across different systems. It provides features like scheduling, monitoring, and logging, making it easier to automate and manage workflows, ensuring they run efficiently and reliably. You can read more in the [official webite](https://airflow.apache.org/)\n\n### Pre-install\n\nNow, we will prepare to install Airflow in a Docker image. Before that, it is necessary to have Docker and Docker Compose installed on your environment. To test if both are installed, you can run the following commands:\n\n```bash\ndocker version\n#and\ndocker compose version\n```\n\nIf they are not installed on your system, you can follow the tutorial available at [Docker](https://docs.docker.com/install/#supported-platforms) and [Docker Compose](https://docs.docker.com/compose/install/)\n\nRemember to Add your user to the `docker` group by using a terminal to run:\n\n```bash\nsudo usermod -aG docker $USER\n```\nSign out and back in again so your changes take effect\n\n### Installing Apache Airflow\n\nOn the [official Apache Airflow page](https://airflow.apache.org/docs/apache-airflow/stable/howto/docker-compose/index.html), we find the link to download the latest version of Docker Compose. As of the time this post is being written, the most recent version is `2.10.3`, and we will be installing this version.\n\nSo we execute:\n```bash\ncurl -LfO 'https://airflow.apache.org/docs/apache-airflow/2.10.3/docker-compose.yaml'\n```\nThis file is an official template from the Airflow team, and it has the following structure:\n\n\n```docker\n# Licensed to the Apache Software Foundation (ASF) under one\n# or more contributor license agreements.  See the NOTICE file\n# distributed with this work for additional information\n# regarding copyright ownership.  The ASF licenses this file\n# to you under the Apache License, Version 2.0 (the\n# \"License\"); you may not use this file except in compliance\n# with the License.  You may obtain a copy of the License at\n#\n#   http://www.apache.org/licenses/LICENSE-2.0\n#\n# Unless required by applicable law or agreed to in writing,\n# software distributed under the License is distributed on an\n# \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n# KIND, either express or implied.  See the License for the\n# specific language governing permissions and limitations\n# under the License.\n#\n\n# Basic Airflow cluster configuration for CeleryExecutor with Redis and PostgreSQL.\n#\n# WARNING: This configuration is for local development. Do not use it in a production deployment.\n#\n# This configuration supports basic configuration using environment variables or an .env file\n# The following variables are supported:\n#\n# AIRFLOW_IMAGE_NAME           - Docker image name used to run Airflow.\n#                                Default: apache/airflow:2.10.3\n# AIRFLOW_UID                  - User ID in Airflow containers\n#                                Default: 50000\n# AIRFLOW_PROJ_DIR             - Base path to which all the files will be volumed.\n#                                Default: .\n# Those configurations are useful mostly in case of standalone testing/running Airflow in test/try-out mode\n#\n# _AIRFLOW_WWW_USER_USERNAME   - Username for the administrator account (if requested).\n#                                Default: airflow\n# _AIRFLOW_WWW_USER_PASSWORD   - Password for the administrator account (if requested).\n#                                Default: airflow\n# _PIP_ADDITIONAL_REQUIREMENTS - Additional PIP requirements to add when starting all containers.\n#                                Use this option ONLY for quick checks. Installing requirements at container\n#                                startup is done EVERY TIME the service is started.\n#                                A better way is to build a custom image or extend the official image\n#                                as described in https://airflow.apache.org/docs/docker-stack/build.html.\n#                                Default: ''\n#\n# Feel free to modify this file to suit your needs.\n---\nx-airflow-common:\n  &airflow-common\n  # In order to add custom dependencies or upgrade provider packages you can use your extended image.\n  # Comment the image line, place your Dockerfile in the directory where you placed the docker-compose.yaml\n  # and uncomment the \"build\" line below, Then run `docker-compose build` to build the images.\n  image: ${AIRFLOW_IMAGE_NAME:-apache/airflow:2.10.3}\n  # build: .\n  environment:\n    &airflow-common-env\n    AIRFLOW__CORE__EXECUTOR: CeleryExecutor\n    AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: postgresql+psycopg2://airflow:airflow@postgres/airflow\n    AIRFLOW__CELERY__RESULT_BACKEND: db+postgresql://airflow:airflow@postgres/airflow\n    AIRFLOW__CELERY__BROKER_URL: redis://:@redis:6379/0\n    AIRFLOW__CORE__FERNET_KEY: ''\n    AIRFLOW__CORE__DAGS_ARE_PAUSED_AT_CREATION: 'true'\n    AIRFLOW__CORE__LOAD_EXAMPLES: 'true'\n    AIRFLOW__API__AUTH_BACKENDS: 'airflow.api.auth.backend.basic_auth,airflow.api.auth.backend.session'\n    # yamllint disable rule:line-length\n    # Use simple http server on scheduler for health checks\n    # See https://airflow.apache.org/docs/apache-airflow/stable/administration-and-deployment/logging-monitoring/check-health.html#scheduler-health-check-server\n    # yamllint enable rule:line-length\n    AIRFLOW__SCHEDULER__ENABLE_HEALTH_CHECK: 'true'\n    # WARNING: Use _PIP_ADDITIONAL_REQUIREMENTS option ONLY for a quick checks\n    # for other purpose (development, test and especially production usage) build/extend Airflow image.\n    _PIP_ADDITIONAL_REQUIREMENTS: ${_PIP_ADDITIONAL_REQUIREMENTS:-}\n    # The following line can be used to set a custom config file, stored in the local config folder\n    # If you want to use it, outcomment it and replace airflow.cfg with the name of your config file\n    # AIRFLOW_CONFIG: '/opt/airflow/config/airflow.cfg'\n  volumes:\n    - ${AIRFLOW_PROJ_DIR:-.}/dags:/opt/airflow/dags\n    - ${AIRFLOW_PROJ_DIR:-.}/logs:/opt/airflow/logs\n    - ${AIRFLOW_PROJ_DIR:-.}/config:/opt/airflow/config\n    - ${AIRFLOW_PROJ_DIR:-.}/plugins:/opt/airflow/plugins\n  user: \"${AIRFLOW_UID:-50000}:0\"\n  depends_on:\n    &airflow-common-depends-on\n    redis:\n      condition: service_healthy\n    postgres:\n      condition: service_healthy\n\nservices:\n  postgres:\n    image: postgres:13\n    environment:\n      POSTGRES_USER: airflow\n      POSTGRES_PASSWORD: airflow\n      POSTGRES_DB: airflow\n    volumes:\n      - postgres-db-volume:/var/lib/postgresql/data\n    healthcheck:\n      test: [\"CMD\", \"pg_isready\", \"-U\", \"airflow\"]\n      interval: 10s\n      retries: 5\n      start_period: 5s\n    restart: always\n\n  redis:\n    # Redis is limited to 7.2-bookworm due to licencing change\n    # https://redis.io/blog/redis-adopts-dual-source-available-licensing/\n    image: redis:7.2-bookworm\n    expose:\n      - 6379\n    healthcheck:\n      test: [\"CMD\", \"redis-cli\", \"ping\"]\n      interval: 10s\n      timeout: 30s\n      retries: 50\n      start_period: 30s\n    restart: always\n\n  airflow-webserver:\n    \u003C\u003C: *airflow-common\n    command: webserver\n    ports:\n      - \"8080:8080\"\n    healthcheck:\n      test: [\"CMD\", \"curl\", \"--fail\", \"http://localhost:8080/health\"]\n      interval: 30s\n      timeout: 10s\n      retries: 5\n      start_period: 30s\n    restart: always\n    depends_on:\n      \u003C\u003C: *airflow-common-depends-on\n      airflow-init:\n        condition: service_completed_successfully\n\n  airflow-scheduler:\n    \u003C\u003C: *airflow-common\n    command: scheduler\n    healthcheck:\n      test: [\"CMD\", \"curl\", \"--fail\", \"http://localhost:8974/health\"]\n      interval: 30s\n      timeout: 10s\n      retries: 5\n      start_period: 30s\n    restart: always\n    depends_on:\n      \u003C\u003C: *airflow-common-depends-on\n      airflow-init:\n        condition: service_completed_successfully\n\n  airflow-worker:\n    \u003C\u003C: *airflow-common\n    command: celery worker\n    healthcheck:\n      # yamllint disable rule:line-length\n      test:\n        - \"CMD-SHELL\"\n        - 'celery --app airflow.providers.celery.executors.celery_executor.app inspect ping -d \"celery@$${HOSTNAME}\" || celery --app airflow.executors.celery_executor.app inspect ping -d \"celery@$${HOSTNAME}\"'\n      interval: 30s\n      timeout: 10s\n      retries: 5\n      start_period: 30s\n    environment:\n      \u003C\u003C: *airflow-common-env\n      # Required to handle warm shutdown of the celery workers properly\n      # See https://airflow.apache.org/docs/docker-stack/entrypoint.html#signal-propagation\n      DUMB_INIT_SETSID: \"0\"\n    restart: always\n    depends_on:\n      \u003C\u003C: *airflow-common-depends-on\n      airflow-init:\n        condition: service_completed_successfully\n\n  airflow-triggerer:\n    \u003C\u003C: *airflow-common\n    command: triggerer\n    healthcheck:\n      test: [\"CMD-SHELL\", 'airflow jobs check --job-type TriggererJob --hostname \"$${HOSTNAME}\"']\n      interval: 30s\n      timeout: 10s\n      retries: 5\n      start_period: 30s\n    restart: always\n    depends_on:\n      \u003C\u003C: *airflow-common-depends-on\n      airflow-init:\n        condition: service_completed_successfully\n\n  airflow-init:\n    \u003C\u003C: *airflow-common\n    entrypoint: /bin/bash\n    # yamllint disable rule:line-length\n    command:\n      - -c\n      - |\n        if [[ -z \"${AIRFLOW_UID}\" ]]; then\n          echo\n          echo -e \"\\033[1;33mWARNING!!!: AIRFLOW_UID not set!\\e[0m\"\n          echo \"If you are on Linux, you SHOULD follow the instructions below to set \"\n          echo \"AIRFLOW_UID environment variable, otherwise files will be owned by root.\"\n          echo \"For other operating systems you can get rid of the warning with manually created .env file:\"\n          echo \"    See: https://airflow.apache.org/docs/apache-airflow/stable/howto/docker-compose/index.html#setting-the-right-airflow-user\"\n          echo\n        fi\n        one_meg=1048576\n        mem_available=$$(($$(getconf _PHYS_PAGES) * $$(getconf PAGE_SIZE) / one_meg))\n        cpus_available=$$(grep -cE 'cpu[0-9]+' /proc/stat)\n        disk_available=$$(df / | tail -1 | awk '{print $$4}')\n        warning_resources=\"false\"\n        if (( mem_available \u003C 4000 )) ; then\n          echo\n          echo -e \"\\033[1;33mWARNING!!!: Not enough memory available for Docker.\\e[0m\"\n          echo \"At least 4GB of memory required. You have $$(numfmt --to iec $$((mem_available * one_meg)))\"\n          echo\n          warning_resources=\"true\"\n        fi\n        if (( cpus_available \u003C 2 )); then\n          echo\n          echo -e \"\\033[1;33mWARNING!!!: Not enough CPUS available for Docker.\\e[0m\"\n          echo \"At least 2 CPUs recommended. You have $${cpus_available}\"\n          echo\n          warning_resources=\"true\"\n        fi\n        if (( disk_available \u003C one_meg * 10 )); then\n          echo\n          echo -e \"\\033[1;33mWARNING!!!: Not enough Disk space available for Docker.\\e[0m\"\n          echo \"At least 10 GBs recommended. You have $$(numfmt --to iec $$((disk_available * 1024 )))\"\n          echo\n          warning_resources=\"true\"\n        fi\n        if [[ $${warning_resources} == \"true\" ]]; then\n          echo\n          echo -e \"\\033[1;33mWARNING!!!: You have not enough resources to run Airflow (see above)!\\e[0m\"\n          echo \"Please follow the instructions to increase amount of resources available:\"\n          echo \"   https://airflow.apache.org/docs/apache-airflow/stable/howto/docker-compose/index.html#before-you-begin\"\n          echo\n        fi\n        mkdir -p /sources/logs /sources/dags /sources/plugins\n        chown -R \"${AIRFLOW_UID}:0\" /sources/{logs,dags,plugins}\n        exec /entrypoint airflow version\n    # yamllint enable rule:line-length\n    environment:\n      \u003C\u003C: *airflow-common-env\n      _AIRFLOW_DB_MIGRATE: 'true'\n      _AIRFLOW_WWW_USER_CREATE: 'true'\n      _AIRFLOW_WWW_USER_USERNAME: ${_AIRFLOW_WWW_USER_USERNAME:-airflow}\n      _AIRFLOW_WWW_USER_PASSWORD: ${_AIRFLOW_WWW_USER_PASSWORD:-airflow}\n      _PIP_ADDITIONAL_REQUIREMENTS: ''\n    user: \"0:0\"\n    volumes:\n      - ${AIRFLOW_PROJ_DIR:-.}:/sources\n\n  airflow-cli:\n    \u003C\u003C: *airflow-common\n    profiles:\n      - debug\n    environment:\n      \u003C\u003C: *airflow-common-env\n      CONNECTION_CHECK_MAX_COUNT: \"0\"\n    # Workaround for entrypoint issue. See: https://github.com/apache/airflow/issues/16252\n    command:\n      - bash\n      - -c\n      - airflow\n\n  # You can enable flower by adding \"--profile flower\" option e.g. docker-compose --profile flower up\n  # or by explicitly targeted on the command line e.g. docker-compose up flower.\n  # See: https://docs.docker.com/compose/profiles/\n  flower:\n    \u003C\u003C: *airflow-common\n    command: celery flower\n    profiles:\n      - flower\n    ports:\n      - \"5555:5555\"\n    healthcheck:\n      test: [\"CMD\", \"curl\", \"--fail\", \"http://localhost:5555/\"]\n      interval: 30s\n      timeout: 10s\n      retries: 5\n      start_period: 30s\n    restart: always\n    depends_on:\n      \u003C\u003C: *airflow-common-depends-on\n      airflow-init:\n        condition: service_completed_successfully\n\nvolumes:\n  postgres-db-volume:\n```\n\nThe arguments below can be modified to customize your project.\n\n- **AIRFLOW_UID**: Defines the user ID that will run the processes in the container.  \n- **AIRFLOW_PROJ_DIR**: Specifies the project's base folder for mounting local volumes.  \n- **_AIRFLOW_WWW_USER_USERNAME** and **_AIRFLOW_WWW_USER_PASSWORD**: Configure admin credentials to access the Airflow interface.  \n- **_PIP_ADDITIONAL_REQUIREMENTS**: Allows the installation of additional Python packages during container initialization, but this is recommended for testing purposes only.  \n\n\nAfter that we will create the folders that will be shared between your computer and the container:\n\n- `./dags`:  DAG directory.\n- `./logs`: Will kepp logs of task executions and the scheduler.\n- `./plugins`: Plugins directory.\n- `./config`: Configuration files will be stored here.\n\nOn Linux, the quick-start setup needs to know your host user ID and requires the group ID to be set to 0. Otherwise, the files created in `dags`, `logs`, and `plugins` will be owned by the root user. You must ensure that these configurations are set correctly in your `docker-compose` setup.\n\n```bash\nmkdir -p ./dags ./logs ./plugins ./config\necho -e \"AIRFLOW_UID=$(id -u)\" > .env\n```\n\nThe Apache Airflow instance can now be initialized using the 'airflow-init' service.\n\n```bash\ndocker compose up airflow-init\n```\n\nNow you can start all services:\n\n```bash\ndocker compose up\n```","src/content/blog/2024-11-11/2024-11-11-airflow.md","a93b68ea3c5425b4",{"html":221,"metadata":222},"\u003Ch2 id=\"apache-airflow\">Apache Airflow\u003C/h2>\n\u003Cp>Apache Airflow is an open-source platform used to orchestrate, schedule, and monitor workflows in data engineering. It allows users to define workflows as Directed Acyclic Graphs (DAGs), where each node represents a task, and the edges represent dependencies between tasks. Airflow is designed for managing complex, multi-step data pipelines and automating the execution of tasks across different systems. It provides features like scheduling, monitoring, and logging, making it easier to automate and manage workflows, ensuring they run efficiently and reliably. You can read more in the \u003Ca href=\"https://airflow.apache.org/\">official webite\u003C/a>\u003C/p>\n\u003Ch3 id=\"pre-install\">Pre-install\u003C/h3>\n\u003Cp>Now, we will prepare to install Airflow in a Docker image. Before that, it is necessary to have Docker and Docker Compose installed on your environment. To test if both are installed, you can run the following commands:\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"bash\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">docker\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> version\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">#and\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">docker\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> compose\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> version\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>If they are not installed on your system, you can follow the tutorial available at \u003Ca href=\"https://docs.docker.com/install/#supported-platforms\">Docker\u003C/a> and \u003Ca href=\"https://docs.docker.com/compose/install/\">Docker Compose\u003C/a>\u003C/p>\n\u003Cp>Remember to Add your user to the \u003Ccode>docker\u003C/code> group by using a terminal to run:\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"bash\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">sudo\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> usermod\u003C/span>\u003Cspan style=\"color:#79B8FF\"> -aG\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> docker\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> $USER\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Sign out and back in again so your changes take effect\u003C/p>\n\u003Ch3 id=\"installing-apache-airflow\">Installing Apache Airflow\u003C/h3>\n\u003Cp>On the \u003Ca href=\"https://airflow.apache.org/docs/apache-airflow/stable/howto/docker-compose/index.html\">official Apache Airflow page\u003C/a>, we find the link to download the latest version of Docker Compose. As of the time this post is being written, the most recent version is \u003Ccode>2.10.3\u003C/code>, and we will be installing this version.\u003C/p>\n\u003Cp>So we execute:\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"bash\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">curl\u003C/span>\u003Cspan style=\"color:#79B8FF\"> -LfO\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> 'https://airflow.apache.org/docs/apache-airflow/2.10.3/docker-compose.yaml'\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>This file is an official template from the Airflow team, and it has the following structure:\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"docker\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># Licensed to the Apache Software Foundation (ASF) under one\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># or more contributor license agreements.  See the NOTICE file\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># distributed with this work for additional information\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># regarding copyright ownership.  The ASF licenses this file\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># to you under the Apache License, Version 2.0 (the\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># \"License\"); you may not use this file except in compliance\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># with the License.  You may obtain a copy of the License at\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">#\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">#   http://www.apache.org/licenses/LICENSE-2.0\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">#\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># Unless required by applicable law or agreed to in writing,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># software distributed under the License is distributed on an\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># KIND, either express or implied.  See the License for the\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># specific language governing permissions and limitations\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># under the License.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">#\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># Basic Airflow cluster configuration for CeleryExecutor with Redis and PostgreSQL.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">#\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># WARNING: This configuration is for local development. Do not use it in a production deployment.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">#\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># This configuration supports basic configuration using environment variables or an .env file\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># The following variables are supported:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">#\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># AIRFLOW_IMAGE_NAME           - Docker image name used to run Airflow.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">#                                Default: apache/airflow:2.10.3\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># AIRFLOW_UID                  - User ID in Airflow containers\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">#                                Default: 50000\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># AIRFLOW_PROJ_DIR             - Base path to which all the files will be volumed.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">#                                Default: .\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># Those configurations are useful mostly in case of standalone testing/running Airflow in test/try-out mode\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">#\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># _AIRFLOW_WWW_USER_USERNAME   - Username for the administrator account (if requested).\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">#                                Default: airflow\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># _AIRFLOW_WWW_USER_PASSWORD   - Password for the administrator account (if requested).\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">#                                Default: airflow\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># _PIP_ADDITIONAL_REQUIREMENTS - Additional PIP requirements to add when starting all containers.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">#                                Use this option ONLY for quick checks. Installing requirements at container\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">#                                startup is done EVERY TIME the service is started.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">#                                A better way is to build a custom image or extend the official image\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">#                                as described in https://airflow.apache.org/docs/docker-stack/build.html.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">#                                Default: ''\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">#\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># Feel free to modify this file to suit your needs.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">---\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">x-airflow-common:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">  &#x26;airflow-common\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">  # In order to add custom dependencies or upgrade provider packages you can use your extended image.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">  # Comment the image line, place your Dockerfile in the directory where you placed the docker-compose.yaml\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">  # and uncomment the \"build\" line below, Then run `docker-compose build` to build the images.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">  image: ${AIRFLOW_IMAGE_NAME:-apache/airflow:2.10.3}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">  # build: .\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">  environment:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    &#x26;airflow-common-env\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    AIRFLOW__CORE__EXECUTOR: CeleryExecutor\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: postgresql+psycopg2://airflow:airflow@postgres/airflow\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    AIRFLOW__CELERY__RESULT_BACKEND: db+postgresql://airflow:airflow@postgres/airflow\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    AIRFLOW__CELERY__BROKER_URL: redis://:@redis:6379/0\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    AIRFLOW__CORE__FERNET_KEY: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">''\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    AIRFLOW__CORE__DAGS_ARE_PAUSED_AT_CREATION: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">'true'\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    AIRFLOW__CORE__LOAD_EXAMPLES: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">'true'\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    AIRFLOW__API__AUTH_BACKENDS: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">'airflow.api.auth.backend.basic_auth,airflow.api.auth.backend.session'\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    # yamllint disable rule:line-length\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    # Use simple http server on scheduler for health checks\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    # See https://airflow.apache.org/docs/apache-airflow/stable/administration-and-deployment/logging-monitoring/check-health.html#scheduler-health-check-server\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    # yamllint enable rule:line-length\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    AIRFLOW__SCHEDULER__ENABLE_HEALTH_CHECK: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">'true'\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    # WARNING: Use _PIP_ADDITIONAL_REQUIREMENTS option ONLY for a quick checks\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    # for other purpose (development, test and especially production usage) build/extend Airflow image.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    _PIP_ADDITIONAL_REQUIREMENTS: ${_PIP_ADDITIONAL_REQUIREMENTS:-}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    # The following line can be used to set a custom config file, stored in the local config folder\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    # If you want to use it, outcomment it and replace airflow.cfg with the name of your config file\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    # AIRFLOW_CONFIG: '/opt/airflow/config/airflow.cfg'\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">  volumes:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    - ${AIRFLOW_PROJ_DIR:-.}/dags:/opt/airflow/dags\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    - ${AIRFLOW_PROJ_DIR:-.}/logs:/opt/airflow/logs\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    - ${AIRFLOW_PROJ_DIR:-.}/config:/opt/airflow/config\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    - ${AIRFLOW_PROJ_DIR:-.}/plugins:/opt/airflow/plugins\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">  user: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"${AIRFLOW_UID:-50000}:0\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">  depends_on:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    &#x26;airflow-common-depends-on\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    redis:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      condition: service_healthy\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    postgres:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      condition: service_healthy\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">services:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">  postgres:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    image: postgres:13\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    environment:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      POSTGRES_USER: airflow\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      POSTGRES_PASSWORD: airflow\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      POSTGRES_DB: airflow\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    volumes:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      - postgres-db-volume:/var/lib/postgresql/data\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    healthcheck:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      test: [\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"CMD\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"pg_isready\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"-U\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"airflow\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      interval: 10s\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      retries: 5\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      start_period: 5s\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    restart: always\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">  redis:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    # Redis is limited to 7.2-bookworm due to licencing change\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    # https://redis.io/blog/redis-adopts-dual-source-available-licensing/\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    image: redis:7.2-bookworm\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    expose:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      - 6379\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    healthcheck:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      test: [\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"CMD\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"redis-cli\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"ping\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      interval: 10s\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      timeout: 30s\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      retries: 50\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      start_period: 30s\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    restart: always\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">  airflow-webserver:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    &#x3C;&#x3C;: *airflow-common\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    command: webserver\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    ports:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      - \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"8080:8080\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    healthcheck:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      test: [\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"CMD\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"curl\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"--fail\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"http://localhost:8080/health\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      interval: 30s\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      timeout: 10s\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      retries: 5\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      start_period: 30s\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    restart: always\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    depends_on:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      &#x3C;&#x3C;: *airflow-common-depends-on\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      airflow-init:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        condition: service_completed_successfully\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">  airflow-scheduler:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    &#x3C;&#x3C;: *airflow-common\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    command: scheduler\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    healthcheck:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      test: [\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"CMD\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"curl\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"--fail\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"http://localhost:8974/health\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      interval: 30s\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      timeout: 10s\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      retries: 5\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      start_period: 30s\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    restart: always\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    depends_on:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      &#x3C;&#x3C;: *airflow-common-depends-on\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      airflow-init:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        condition: service_completed_successfully\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">  airflow-worker:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    &#x3C;&#x3C;: *airflow-common\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    command: celery worker\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    healthcheck:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">      # yamllint disable rule:line-length\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      test:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        - \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"CMD-SHELL\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        - \u003C/span>\u003Cspan style=\"color:#9ECBFF\">'celery --app airflow.providers.celery.executors.celery_executor.app inspect ping -d \"celery@$${HOSTNAME}\" || celery --app airflow.executors.celery_executor.app inspect ping -d \"celery@$${HOSTNAME}\"'\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      interval: 30s\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      timeout: 10s\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      retries: 5\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      start_period: 30s\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    environment:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      &#x3C;&#x3C;: *airflow-common-env\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">      # Required to handle warm shutdown of the celery workers properly\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">      # See https://airflow.apache.org/docs/docker-stack/entrypoint.html#signal-propagation\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      DUMB_INIT_SETSID: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"0\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    restart: always\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    depends_on:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      &#x3C;&#x3C;: *airflow-common-depends-on\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      airflow-init:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        condition: service_completed_successfully\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">  airflow-triggerer:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    &#x3C;&#x3C;: *airflow-common\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    command: triggerer\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    healthcheck:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      test: [\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"CMD-SHELL\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">'airflow jobs check --job-type TriggererJob --hostname \"$${HOSTNAME}\"'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      interval: 30s\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      timeout: 10s\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      retries: 5\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      start_period: 30s\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    restart: always\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    depends_on:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      &#x3C;&#x3C;: *airflow-common-depends-on\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      airflow-init:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        condition: service_completed_successfully\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">  airflow-init:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    &#x3C;&#x3C;: *airflow-common\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    entrypoint: /bin/bash\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    # yamllint disable rule:line-length\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    command:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      - -c\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      - |\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        if [[ -z \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"${AIRFLOW_UID}\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> ]]; then\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">          echo\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">          echo -e \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"\u003C/span>\u003Cspan style=\"color:#79B8FF\">\\0\u003C/span>\u003Cspan style=\"color:#9ECBFF\">33[1;33mWARNING!!!: AIRFLOW_UID not set!\u003C/span>\u003Cspan style=\"color:#79B8FF\">\\e\u003C/span>\u003Cspan style=\"color:#9ECBFF\">[0m\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">          echo \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"If you are on Linux, you SHOULD follow the instructions below to set \"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">          echo \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"AIRFLOW_UID environment variable, otherwise files will be owned by root.\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">          echo \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"For other operating systems you can get rid of the warning with manually created .env file:\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">          echo \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"    See: https://airflow.apache.org/docs/apache-airflow/stable/howto/docker-compose/index.html#setting-the-right-airflow-user\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">          echo\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        fi\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        one_meg=1048576\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        mem_available=$$(($$(getconf _PHYS_PAGES) * $$(getconf PAGE_SIZE) / one_meg))\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        cpus_available=$$(grep -cE \u003C/span>\u003Cspan style=\"color:#9ECBFF\">'cpu[0-9]+'\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> /proc/stat)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        disk_available=$$(df / | tail -1 | awk \u003C/span>\u003Cspan style=\"color:#9ECBFF\">'{print $$4}'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        warning_resources=\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"false\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        if (( mem_available &#x3C; 4000 )) ; then\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">          echo\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">          echo -e \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"\u003C/span>\u003Cspan style=\"color:#79B8FF\">\\0\u003C/span>\u003Cspan style=\"color:#9ECBFF\">33[1;33mWARNING!!!: Not enough memory available for Docker.\u003C/span>\u003Cspan style=\"color:#79B8FF\">\\e\u003C/span>\u003Cspan style=\"color:#9ECBFF\">[0m\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">          echo \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"At least 4GB of memory required. You have $$(numfmt --to iec $$((mem_available * one_meg)))\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">          echo\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">          warning_resources=\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"true\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        fi\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        if (( cpus_available &#x3C; 2 )); then\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">          echo\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">          echo -e \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"\u003C/span>\u003Cspan style=\"color:#79B8FF\">\\0\u003C/span>\u003Cspan style=\"color:#9ECBFF\">33[1;33mWARNING!!!: Not enough CPUS available for Docker.\u003C/span>\u003Cspan style=\"color:#79B8FF\">\\e\u003C/span>\u003Cspan style=\"color:#9ECBFF\">[0m\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">          echo \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"At least 2 CPUs recommended. You have $${cpus_available}\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">          echo\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">          warning_resources=\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"true\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        fi\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        if (( disk_available &#x3C; one_meg * 10 )); then\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">          echo\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">          echo -e \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"\u003C/span>\u003Cspan style=\"color:#79B8FF\">\\0\u003C/span>\u003Cspan style=\"color:#9ECBFF\">33[1;33mWARNING!!!: Not enough Disk space available for Docker.\u003C/span>\u003Cspan style=\"color:#79B8FF\">\\e\u003C/span>\u003Cspan style=\"color:#9ECBFF\">[0m\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">          echo \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"At least 10 GBs recommended. You have $$(numfmt --to iec $$((disk_available * 1024 )))\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">          echo\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">          warning_resources=\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"true\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        fi\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        if [[ $${warning_resources} == \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"true\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> ]]; then\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">          echo\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">          echo -e \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"\u003C/span>\u003Cspan style=\"color:#79B8FF\">\\0\u003C/span>\u003Cspan style=\"color:#9ECBFF\">33[1;33mWARNING!!!: You have not enough resources to run Airflow (see above)!\u003C/span>\u003Cspan style=\"color:#79B8FF\">\\e\u003C/span>\u003Cspan style=\"color:#9ECBFF\">[0m\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">          echo \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"Please follow the instructions to increase amount of resources available:\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">          echo \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"   https://airflow.apache.org/docs/apache-airflow/stable/howto/docker-compose/index.html#before-you-begin\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">          echo\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        fi\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        mkdir -p /sources/logs /sources/dags /sources/plugins\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        chown -R \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"${AIRFLOW_UID}:0\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> /sources/{logs,dags,plugins}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        exec /entrypoint airflow version\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    # yamllint enable rule:line-length\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    environment:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      &#x3C;&#x3C;: *airflow-common-env\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      _AIRFLOW_DB_MIGRATE: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">'true'\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      _AIRFLOW_WWW_USER_CREATE: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">'true'\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      _AIRFLOW_WWW_USER_USERNAME: ${_AIRFLOW_WWW_USER_USERNAME:-airflow}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      _AIRFLOW_WWW_USER_PASSWORD: ${_AIRFLOW_WWW_USER_PASSWORD:-airflow}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      _PIP_ADDITIONAL_REQUIREMENTS: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">''\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    user: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"0:0\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    volumes:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      - ${AIRFLOW_PROJ_DIR:-.}:/sources\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">  airflow-cli:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    &#x3C;&#x3C;: *airflow-common\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    profiles:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      - debug\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    environment:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      &#x3C;&#x3C;: *airflow-common-env\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      CONNECTION_CHECK_MAX_COUNT: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"0\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    # Workaround for entrypoint issue. See: https://github.com/apache/airflow/issues/16252\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    command:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      - bash\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      - -c\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      - airflow\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">  # You can enable flower by adding \"--profile flower\" option e.g. docker-compose --profile flower up\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">  # or by explicitly targeted on the command line e.g. docker-compose up flower.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">  # See: https://docs.docker.com/compose/profiles/\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">  flower:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    &#x3C;&#x3C;: *airflow-common\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    command: celery flower\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    profiles:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      - flower\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    ports:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      - \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"5555:5555\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    healthcheck:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      test: [\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"CMD\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"curl\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"--fail\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"http://localhost:5555/\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      interval: 30s\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      timeout: 10s\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      retries: 5\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      start_period: 30s\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    restart: always\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    depends_on:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      &#x3C;&#x3C;: *airflow-common-depends-on\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      airflow-init:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        condition: service_completed_successfully\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">volumes:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">  postgres-db-volume:\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The arguments below can be modified to customize your project.\u003C/p>\n\u003Cul>\n\u003Cli>\u003Cstrong>AIRFLOW_UID\u003C/strong>: Defines the user ID that will run the processes in the container.\u003C/li>\n\u003Cli>\u003Cstrong>AIRFLOW_PROJ_DIR\u003C/strong>: Specifies the project’s base folder for mounting local volumes.\u003C/li>\n\u003Cli>\u003Cstrong>_AIRFLOW_WWW_USER_USERNAME\u003C/strong> and \u003Cstrong>_AIRFLOW_WWW_USER_PASSWORD\u003C/strong>: Configure admin credentials to access the Airflow interface.\u003C/li>\n\u003Cli>\u003Cstrong>_PIP_ADDITIONAL_REQUIREMENTS\u003C/strong>: Allows the installation of additional Python packages during container initialization, but this is recommended for testing purposes only.\u003C/li>\n\u003C/ul>\n\u003Cp>After that we will create the folders that will be shared between your computer and the container:\u003C/p>\n\u003Cul>\n\u003Cli>\u003Ccode>./dags\u003C/code>:  DAG directory.\u003C/li>\n\u003Cli>\u003Ccode>./logs\u003C/code>: Will kepp logs of task executions and the scheduler.\u003C/li>\n\u003Cli>\u003Ccode>./plugins\u003C/code>: Plugins directory.\u003C/li>\n\u003Cli>\u003Ccode>./config\u003C/code>: Configuration files will be stored here.\u003C/li>\n\u003C/ul>\n\u003Cp>On Linux, the quick-start setup needs to know your host user ID and requires the group ID to be set to 0. Otherwise, the files created in \u003Ccode>dags\u003C/code>, \u003Ccode>logs\u003C/code>, and \u003Ccode>plugins\u003C/code> will be owned by the root user. You must ensure that these configurations are set correctly in your \u003Ccode>docker-compose\u003C/code> setup.\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"bash\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">mkdir\u003C/span>\u003Cspan style=\"color:#79B8FF\"> -p\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> ./dags\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> ./logs\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> ./plugins\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> ./config\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">echo\u003C/span>\u003Cspan style=\"color:#79B8FF\"> -e\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> \"AIRFLOW_UID=$(\u003C/span>\u003Cspan style=\"color:#B392F0\">id\u003C/span>\u003Cspan style=\"color:#79B8FF\"> -u\u003C/span>\u003Cspan style=\"color:#9ECBFF\">)\"\u003C/span>\u003Cspan style=\"color:#F97583\"> >\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> .env\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The Apache Airflow instance can now be initialized using the ‘airflow-init’ service.\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"bash\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">docker\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> compose\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> up\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> airflow-init\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Now you can start all services:\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"bash\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">docker\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> compose\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> up\u003C/span>\u003C/span>\u003C/code>\u003C/pre>",{"headings":223,"localImagePaths":233,"remoteImagePaths":234,"frontmatter":235,"imagePaths":240},[224,227,230],{"depth":32,"slug":225,"text":226},"apache-airflow","Apache Airflow",{"depth":36,"slug":228,"text":229},"pre-install","Pre-install",{"depth":36,"slug":231,"text":232},"installing-apache-airflow","Installing Apache Airflow",[],[],{"title":208,"description":209,"date":236,"categories":237,"tags":238,"image":239,"render_with_liquid":76},"2024-11-11 14:10:00 +0800",[20,214,215],[214],{"path":212},[],"2024-11-29/2024-11-29-spotify",{"id":241,"data":243,"body":252,"filePath":253,"digest":254,"rendered":255},{"title":244,"description":245,"date":246,"image":247,"categories":249,"tags":250},"Obtaining the Most Listened Tracks on Spotify with Apache Airflow","In this tutorial, we will use Apache Airflow to orchestrate a data pipeline that retrieves the most listened-to tracks worldwide and saves them in a MongoDB cluster.",["Date","2024-11-28T16:00:00.000Z"],{"path":248},"/assets/posts/2024-11-29/airflow.png",[20,214,215],[214,251],"Spotify","## Introduction\n\nIn this project, we will put into practice some of the most common skills in the data world. The goal is to automatically retrieve the top 50 most listened-to songs on Spotify worldwide on a daily basis and store this information in a non-relational database, in this case, MongoDB.\n\n![desktop View](/assets/posts/2024-11-29/airflow2.png)\n_Pipeline Schema_\n\n### Pre-install\n\nOur entire project will run on a pre-configured Docker image with Apache Airflow and MongoDB dependencies. \n\nYou can check out a brief tutorial on how to install Airflow in the [previous blog post](https://lucasbral.github.io/posts/airflow/), which provides a more detailed explanation.\n\nIn our case, we will use the same Docker image from the tutorial with just one environment modification, as we will need to install the MongoDB dependency for Airflow. \n\nFor more details, check the official [docs](https://www.mongodb.com/developer/products/mongodb/mongodb-apache-airflow/).\n\nIf they are not installed on your system, you can follow the tutorial available at [Docker](https://docs.docker.com/install/#supported-platforms) and [Docker Compose](https://docs.docker.com/compose/install/)\n\nRemember to Add your user to the `docker` group by using a terminal to run:\n\n```bash\nsudo usermod -aG docker $USER\n```\nSign out and back in again so your changes take effect\n\nOn the [official Apache Airflow page](https://airflow.apache.org/docs/apache-airflow/stable/howto/docker-compose/index.html), we find the link to download the latest version of Docker Compose. As of the time this post is being written, the most recent version is `2.10.3`, and we will be installing this version.\n\nIn a directory, create a `docker-compose.yaml` file with the following configurations:\n\n```docker\nx-airflow-common:\n  &airflow-common\n  build: ./airflow\n  # build: .\n  environment:\n    &airflow-common-env\n    AIRFLOW__CORE__EXECUTOR: CeleryExecutor\n    AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: postgresql+psycopg2://airflow:airflow@postgres/airflow\n    AIRFLOW__CELERY__RESULT_BACKEND: db+postgresql://airflow:airflow@postgres/airflow\n    AIRFLOW__CELERY__BROKER_URL: redis://:@redis:6379/0\n    AIRFLOW__CORE__FERNET_KEY: ''\n    AIRFLOW__CORE__DAGS_ARE_PAUSED_AT_CREATION: 'true'\n    AIRFLOW__CORE__LOAD_EXAMPLES: 'true'\n    AIRFLOW__API__AUTH_BACKENDS: 'airflow.api.auth.backend.basic_auth,airflow.api.auth.backend.session'\n    # yamllint disable rule:line-length\n    # Use simple http server on scheduler for health checks\n    # See https://airflow.apache.org/docs/apache-airflow/stable/administration-and-deployment/logging-monitoring/check-health.html#scheduler-health-check-server\n    # yamllint enable rule:line-length\n    AIRFLOW__SCHEDULER__ENABLE_HEALTH_CHECK: 'true'\n    # WARNING: Use _PIP_ADDITIONAL_REQUIREMENTS option ONLY for a quick checks\n    # for other purpose (development, test and especially production usage) build/extend Airflow image.\n    _PIP_ADDITIONAL_REQUIREMENTS: ${_PIP_ADDITIONAL_REQUIREMENTS:-}\n    # The following line can be used to set a custom config file, stored in the local config folder\n    # If you want to use it, outcomment it and replace airflow.cfg with the name of your config file\n    # AIRFLOW_CONFIG: '/opt/airflow/config/airflow.cfg'\n  volumes:\n    - ${AIRFLOW_PROJ_DIR:-.}/dags:/opt/airflow/dags\n    - ${AIRFLOW_PROJ_DIR:-.}/logs:/opt/airflow/logs\n    - ${AIRFLOW_PROJ_DIR:-.}/config:/opt/airflow/config\n    - ${AIRFLOW_PROJ_DIR:-.}/plugins:/opt/airflow/plugins\n  user: \"${AIRFLOW_UID:-50000}:0\"\n  depends_on:\n    &airflow-common-depends-on\n    redis:\n      condition: service_healthy\n    postgres:\n      condition: service_healthy\n\nservices:\n  postgres:\n    image: postgres:13\n    environment:\n      POSTGRES_USER: airflow\n      POSTGRES_PASSWORD: airflow\n      POSTGRES_DB: airflow\n    volumes:\n      - postgres-db-volume:/var/lib/postgresql/data\n    healthcheck:\n      test: [\"CMD\", \"pg_isready\", \"-U\", \"airflow\"]\n      interval: 10s\n      retries: 5\n      start_period: 5s\n    restart: always\n\n  redis:\n    # Redis is limited to 7.2-bookworm due to licencing change\n    # https://redis.io/blog/redis-adopts-dual-source-available-licensing/\n    image: redis:7.2-bookworm\n    expose:\n      - 6379\n    healthcheck:\n      test: [\"CMD\", \"redis-cli\", \"ping\"]\n      interval: 10s\n      timeout: 30s\n      retries: 50\n      start_period: 30s\n    restart: always\n\n  airflow-webserver:\n    \u003C\u003C: *airflow-common\n    command: webserver\n    ports:\n      - \"8080:8080\"\n    healthcheck:\n      test: [\"CMD\", \"curl\", \"--fail\", \"http://localhost:8080/health\"]\n      interval: 30s\n      timeout: 10s\n      retries: 5\n      start_period: 30s\n    restart: always\n    depends_on:\n      \u003C\u003C: *airflow-common-depends-on\n      airflow-init:\n        condition: service_completed_successfully\n\n  airflow-scheduler:\n    \u003C\u003C: *airflow-common\n    command: scheduler\n    healthcheck:\n      test: [\"CMD\", \"curl\", \"--fail\", \"http://localhost:8974/health\"]\n      interval: 30s\n      timeout: 10s\n      retries: 5\n      start_period: 30s\n    restart: always\n    depends_on:\n      \u003C\u003C: *airflow-common-depends-on\n      airflow-init:\n        condition: service_completed_successfully\n\n  airflow-worker:\n    \u003C\u003C: *airflow-common\n    command: celery worker\n    healthcheck:\n      # yamllint disable rule:line-length\n      test:\n        - \"CMD-SHELL\"\n        - 'celery --app airflow.providers.celery.executors.celery_executor.app inspect ping -d \"celery@$${HOSTNAME}\" || celery --app airflow.executors.celery_executor.app inspect ping -d \"celery@$${HOSTNAME}\"'\n      interval: 30s\n      timeout: 10s\n      retries: 5\n      start_period: 30s\n    environment:\n      \u003C\u003C: *airflow-common-env\n      # Required to handle warm shutdown of the celery workers properly\n      # See https://airflow.apache.org/docs/docker-stack/entrypoint.html#signal-propagation\n      DUMB_INIT_SETSID: \"0\"\n    restart: always\n    depends_on:\n      \u003C\u003C: *airflow-common-depends-on\n      airflow-init:\n        condition: service_completed_successfully\n\n  airflow-triggerer:\n    \u003C\u003C: *airflow-common\n    command: triggerer\n    healthcheck:\n      test: [\"CMD-SHELL\", 'airflow jobs check --job-type TriggererJob --hostname \"$${HOSTNAME}\"']\n      interval: 30s\n      timeout: 10s\n      retries: 5\n      start_period: 30s\n    restart: always\n    depends_on:\n      \u003C\u003C: *airflow-common-depends-on\n      airflow-init:\n        condition: service_completed_successfully\n\n  airflow-init:\n    \u003C\u003C: *airflow-common\n    entrypoint: /bin/bash\n    # yamllint disable rule:line-length\n    command:\n      - -c\n      - |\n        if [[ -z \"${AIRFLOW_UID}\" ]]; then\n          echo\n          echo -e \"\\033[1;33mWARNING!!!: AIRFLOW_UID not set!\\e[0m\"\n          echo \"If you are on Linux, you SHOULD follow the instructions below to set \"\n          echo \"AIRFLOW_UID environment variable, otherwise files will be owned by root.\"\n          echo \"For other operating systems you can get rid of the warning with manually created .env file:\"\n          echo \"    See: https://airflow.apache.org/docs/apache-airflow/stable/howto/docker-compose/index.html#setting-the-right-airflow-user\"\n          echo\n        fi\n        one_meg=1048576\n        mem_available=$$(($$(getconf _PHYS_PAGES) * $$(getconf PAGE_SIZE) / one_meg))\n        cpus_available=$$(grep -cE 'cpu[0-9]+' /proc/stat)\n        disk_available=$$(df / | tail -1 | awk '{print $$4}')\n        warning_resources=\"false\"\n        if (( mem_available \u003C 4000 )) ; then\n          echo\n          echo -e \"\\033[1;33mWARNING!!!: Not enough memory available for Docker.\\e[0m\"\n          echo \"At least 4GB of memory required. You have $$(numfmt --to iec $$((mem_available * one_meg)))\"\n          echo\n          warning_resources=\"true\"\n        fi\n        if (( cpus_available \u003C 2 )); then\n          echo\n          echo -e \"\\033[1;33mWARNING!!!: Not enough CPUS available for Docker.\\e[0m\"\n          echo \"At least 2 CPUs recommended. You have $${cpus_available}\"\n          echo\n          warning_resources=\"true\"\n        fi\n        if (( disk_available \u003C one_meg * 10 )); then\n          echo\n          echo -e \"\\033[1;33mWARNING!!!: Not enough Disk space available for Docker.\\e[0m\"\n          echo \"At least 10 GBs recommended. You have $$(numfmt --to iec $$((disk_available * 1024 )))\"\n          echo\n          warning_resources=\"true\"\n        fi\n        if [[ $${warning_resources} == \"true\" ]]; then\n          echo\n          echo -e \"\\033[1;33mWARNING!!!: You have not enough resources to run Airflow (see above)!\\e[0m\"\n          echo \"Please follow the instructions to increase amount of resources available:\"\n          echo \"   https://airflow.apache.org/docs/apache-airflow/stable/howto/docker-compose/index.html#before-you-begin\"\n          echo\n        fi\n        mkdir -p /sources/logs /sources/dags /sources/plugins\n        chown -R \"${AIRFLOW_UID}:0\" /sources/{logs,dags,plugins}\n        exec /entrypoint airflow version\n    # yamllint enable rule:line-length\n    environment:\n      \u003C\u003C: *airflow-common-env\n      _AIRFLOW_DB_MIGRATE: 'true'\n      _AIRFLOW_WWW_USER_CREATE: 'true'\n      _AIRFLOW_WWW_USER_USERNAME: ${_AIRFLOW_WWW_USER_USERNAME:-airflow}\n      _AIRFLOW_WWW_USER_PASSWORD: ${_AIRFLOW_WWW_USER_PASSWORD:-airflow}\n      _PIP_ADDITIONAL_REQUIREMENTS: ''\n    user: \"0:0\"\n    volumes:\n      - ${AIRFLOW_PROJ_DIR:-.}:/sources\n\n  airflow-cli:\n    \u003C\u003C: *airflow-common\n    profiles:\n      - debug\n    environment:\n      \u003C\u003C: *airflow-common-env\n      CONNECTION_CHECK_MAX_COUNT: \"0\"\n    # Workaround for entrypoint issue. See: https://github.com/apache/airflow/issues/16252\n    command:\n      - bash\n      - -c\n      - airflow\n\n  # You can enable flower by adding \"--profile flower\" option e.g. docker-compose --profile flower up\n  # or by explicitly targeted on the command line e.g. docker-compose up flower.\n  # See: https://docs.docker.com/compose/profiles/\n  flower:\n    \u003C\u003C: *airflow-common\n    command: celery flower\n    profiles:\n      - flower\n    ports:\n      - \"5555:5555\"\n    healthcheck:\n      test: [\"CMD\", \"curl\", \"--fail\", \"http://localhost:5555/\"]\n      interval: 30s\n      timeout: 10s\n      retries: 5\n      start_period: 30s\n    restart: always\n    depends_on:\n      \u003C\u003C: *airflow-common-depends-on\n      airflow-init:\n        condition: service_completed_successfully\n\nvolumes:\n  postgres-db-volume:\n```\n\nAfter that we will create the folders that will be shared between your computer and the container:\n\n- `./dags`:  DAG directory.\n- `./logs`: Will kepp logs of task executions and the scheduler.\n- `./plugins`: Plugins directory.\n- `./config`: Configuration files will be stored here.\n- `./airflow`: Dockerfile directory.\n\nOn Linux, the quick-start setup needs to know your host user ID and requires the group ID to be set to 0. Otherwise, the files created in `dags`, `logs`, and `plugins` will be owned by the root user. You must ensure that these configurations are set correctly in your `docker-compose` setup.\n\n```bash\nmkdir -p ./dags ./logs ./plugins ./config ./airflow\necho -e \"AIRFLOW_UID=$(id -u)\" > .env\n```\nAfter that, create a `Dockerfile` in the `/airflow` folder with the following configurations:\n\n```docker\nFROM apache/airflow:2.10.3\n# add your dependencies here:\nRUN pip install apache-airflow-providers-mongo\n```\n\nThe Apache Airflow instance can now be initialized using :\n\n```bash\ndocker compose up --build airflow-init\n```\n\nNow you can start all services:\n\n```bash\ndocker compose up\n```\n\nAirflow will be available at `0.0.0.0:8080`, and to log in, simply use `airflow` as both the username and password, as this is the default configuration.\n\n## Spotify API\n\nTo obtain data from Spotify, it is necessary to create an account and also create an app within the Spotify API Dashboard under the Developer area. Here is a link to the API documentation with a brief description: [docs](https://developer.spotify.com/documentation/web-api).\n\nBasically, we will need two pieces of information: the `client_id` and `client_secret`. With these two keys, it is possible to generate an `access_token` ([docs](https://developer.spotify.com/documentation/web-api/concepts/access-token)).\n\nWith the access token, it is possible to communicate with the Spotify API and retrieve a variety of information.\n\n> The `access_token` is valid for only 1 hour, so we have the option to either refresh it or request a new one. In my case, I chose to request a new token each time, as the pipeline is scheduled to run only once per day.\n{: .prompt-tip }\n\n## Setting up Apache Airflow\n\nAirflow has a very useful feature to define variables and secrets that can be used in DAGs and Tasks.\n\nWe will use it to store the Spotify API information.\n\nTo do this, on the front end, click on **Admin** > **Variables** > **add new record**\n\n![desktop View](/assets/posts/2024-11-29/1.png)\n_add client_id and client_secret_\n\nAdd the `client_id` and `client_secret` information and click **Save**.\n\n## Configuring Mongo DB\n\nBefore anything, it is necessary to create an account on [MongoDB](https://www.mongodb.com/) and set up a cluster. For this project, we will use the Free Tier.\n\n![desktop View](/assets/posts/2024-11-29/2.png)\n_Mongo DB homepage_\n\nClick on Database Access > add new database user\n\nUse the authentication method with a password, define the user's role.\n\nAnd make sure to store the password in a secure place as it will be needed later.\n\nClick on Network Acess Allow IP access to the port.\n\n![desktop View](/assets/posts/2024-11-29/3.png)\n_Acess Network_\n\nIt is also necessary to create a new database and collection within the cluster. This is where the music information will be saved. In my case, the database \"spotify\" was created in the \"currency collection\" collection.\n\n![desktop View](/assets/posts/2024-11-29/4.png)\n_Creating Database and Collection_\n\n## Creating a connection to MongoDB in Airflow\nAgora que o MongoDB está devidamente configurado, é necessário conectá-lo no Airflow. Para isso, basta ir na aba **Admin > Connections** > **add new record** .\n\nAnd set it up as shown below:\n\nSet up the connection as shown below:\n\n- **Conn Id:** mongo\n- **Conn Type:** MongoDB\n- **Host:** cluster0.mtfak.mongodb.net\n- **Login:** myuser (set before on the MongoDB webpage)\n- **Password:** mypass (set before on the MongoDB webpage)\n- **Port:** empty\n- **Extra:** `{\"srv\": true}`\n\nClick on Save.\n\n## Airflow DAG\n\nOur pipeline will have 3 main parts:\n\n1. Obtain the access_token from the Spotify API.\n2. With the access_token in hand, make the request to the Spotify Playlist API to get the information of the 50 most played songs of the day (from the Top 50 Global playlist).\n3. Save the JSON object in MongoDB.\n\n### 1 - Get Acess Token\n\nThe get_token task retrieves the access token from the Spotify API by sending a request with the client credentials. It encodes the client ID and secret in base64, makes a POST request to Spotify's token endpoint, and returns the access token as an XCom.\n\n```python\n    @task\n    def get_token():\n        # get credentials\n        client_id = Variable.get(\"client_id\")\n        client_secret = Variable.get(\"client_secret\")\n\n        auth_string = f\"{client_id}:{client_secret}\"\n        auth_bytes = auth_string.encode('utf-8')\n        auth_base64 = base64.b64encode(auth_bytes).decode('utf-8')\n        # make request\n        url = 'https://accounts.spotify.com/api/token'\n        headers = {\n            'Authorization': f'Basic {auth_base64}'\n        }\n        data = {\n            'grant_type': 'client_credentials'\n        }\n        response = requests.post(url, headers=headers, data=data)\n        print(response.json().get('access_token'))\n        #transform token in a xcom\n        return response.json().get('access_token')\n```\n### 2 - Obtain Playlist Songs\n\nThe get_playlist task retrieves the top 50 tracks from a specific Spotify playlist using the provided access token. It sends a GET request to the Spotify API and returns the playlist data in JSON format if the request is successful.\n\n```python\n    @task\n    def get_playlist(token):\n        url = 'https://api.spotify.com/v1/playlists/5FN6Ego7eLX6zHuCMovIR2/tracks?limit=50&offset=0'\n        headers = {\n        'Authorization': f'Bearer {token}'\n        }\n        response = requests.get(url, headers=headers)\n        if response.status_code == 200:\n            return response.json()\n```\n\n### 3 - Ingest Data on Mongo DB\n\nThe load_data_to_mongo_db task connects to a MongoDB database using the MongoHook, inserts the result (with a timestamp) into the currency_collection of the spotify database, and logs the connection details.\n\n```python\n    @task\n    def load_data_to_mongo_db(result):\n        hook = MongoHook(conn_id='mongo')\n        client = hook.get_conn()\n        db = (\n        client.spotify\n        )\n        currency_collection = db.currency_collection\n        print(f\"connected to MongoDB - {client.server_info()}\")\n        current_datetime = pendulum.now().to_iso8601_string()\n        result[\"datetime\"] = current_datetime\n        currency_collection.insert_one(result)\n```\n\nHere is our complete DAG:\n\n```python\nfrom airflow.decorators import dag, task\nimport pendulum\nfrom pendulum import datetime\nfrom airflow.models import Variable\nfrom airflow.providers.mongo.hooks.mongo import MongoHook\nimport json\nimport base64\nimport requests\n\n\n@dag(\n    start_date=datetime(2024, 11, 21),\n    schedule=\"@daily\",\n    tags=[\"spotify_api\"],\n    catchup=False,\n)\n\ndef pipe():\n    @task\n    def get_token():\n        # get credentials\n        client_id = Variable.get(\"client_id\")\n        client_secret = Variable.get(\"client_secret\")\n\n        # Codificando as credenciais em base64\n        auth_string = f\"{client_id}:{client_secret}\"\n        auth_bytes = auth_string.encode('utf-8')\n        auth_base64 = base64.b64encode(auth_bytes).decode('utf-8')\n\n        url = 'https://accounts.spotify.com/api/token'\n        headers = {\n            'Authorization': f'Basic {auth_base64}'\n        }\n        data = {\n            'grant_type': 'client_credentials'\n        }\n        # Fazendo a solicitação POST\n        response = requests.post(url, headers=headers, data=data)\n        print(response.json().get('access_token'))\n        return response.json().get('access_token')\n\n    @task\n    def get_playlist(token):\n        url = 'https://api.spotify.com/v1/playlists/5FN6Ego7eLX6zHuCMovIR2/tracks?limit=50&offset=0'\n        headers = {\n        'Authorization': f'Bearer {token}'\n        }\n        response = requests.get(url, headers=headers)\n        if response.status_code == 200:\n            return response.json()\n        \n\n    @task\n    def load_data_to_mongo_db(result):\n        hook = MongoHook(conn_id='mongo')\n        client = hook.get_conn()\n        db = (\n        client.spotify\n        )\n        currency_collection = db.currency_collection\n        print(f\"connected to MongoDB - {client.server_info()}\")\n        current_datetime = pendulum.now().to_iso8601_string()\n        result[\"datetime\"] = current_datetime\n        currency_collection.insert_one(result)\n    \n\n    load_data_to_mongo_db(get_playlist(get_token()))\n\npipe()\n```\n\n> The `pipe.py` must be on the dags directory.\n{: .prompt-tip }\n\n## Observing the Jobs in the Airflow Frontend\n\nNow that our DAG is configured, simply run it manually once for testing, and let Airflow handle the orchestration to execute the code daily.\n\n![desktop View](/assets/posts/2024-11-29/6.png)\n_Airflow Jobs running_\n\n![desktop View](/assets/posts/2024-11-29/7.png)\n_Graph View Job_\n\nThe code worked as expected, and the pipeline is successfully retrieving playlist information, orchestrated via Airflow!\n\nIn MongoDB, it is possible to see the data loads made:\n\n![desktop View](/assets/posts/2024-11-29/8.png)\n_Graph View Job_\n\n## Conclusions\n\nThis project successfully demonstrates the power of Apache Airflow in orchestrating a data pipeline to fetch the most played tracks on Spotify daily. By leveraging Spotify's API and MongoDB for storage, we were able to automate the process of retrieving and storing the data. The use of Docker and MongoDB integration with Airflow allowed for a smooth execution of tasks, ensuring that the pipeline runs automatically each day with minimal intervention. This solution is a great example of how data engineering tools can be used to automate data collection and storage processes, providing valuable insights in an efficient and scalable manner.\n\nAll the codes are available in the [GitHub Repo](https://github.com/lucasbral/spotify_pipeline/tree/main).","src/content/blog/2024-11-29/2024-11-29-spotify.md","f9618806fa130abf",{"html":256,"metadata":257},"\u003Ch2 id=\"introduction\">Introduction\u003C/h2>\n\u003Cp>In this project, we will put into practice some of the most common skills in the data world. The goal is to automatically retrieve the top 50 most listened-to songs on Spotify worldwide on a daily basis and store this information in a non-relational database, in this case, MongoDB.\u003C/p>\n\u003Cp>\u003Cimg src=\"/assets/posts/2024-11-29/airflow2.png\" alt=\"desktop View\">\n\u003Cem>Pipeline Schema\u003C/em>\u003C/p>\n\u003Ch3 id=\"pre-install\">Pre-install\u003C/h3>\n\u003Cp>Our entire project will run on a pre-configured Docker image with Apache Airflow and MongoDB dependencies.\u003C/p>\n\u003Cp>You can check out a brief tutorial on how to install Airflow in the \u003Ca href=\"https://lucasbral.github.io/posts/airflow/\">previous blog post\u003C/a>, which provides a more detailed explanation.\u003C/p>\n\u003Cp>In our case, we will use the same Docker image from the tutorial with just one environment modification, as we will need to install the MongoDB dependency for Airflow.\u003C/p>\n\u003Cp>For more details, check the official \u003Ca href=\"https://www.mongodb.com/developer/products/mongodb/mongodb-apache-airflow/\">docs\u003C/a>.\u003C/p>\n\u003Cp>If they are not installed on your system, you can follow the tutorial available at \u003Ca href=\"https://docs.docker.com/install/#supported-platforms\">Docker\u003C/a> and \u003Ca href=\"https://docs.docker.com/compose/install/\">Docker Compose\u003C/a>\u003C/p>\n\u003Cp>Remember to Add your user to the \u003Ccode>docker\u003C/code> group by using a terminal to run:\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"bash\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">sudo\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> usermod\u003C/span>\u003Cspan style=\"color:#79B8FF\"> -aG\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> docker\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> $USER\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Sign out and back in again so your changes take effect\u003C/p>\n\u003Cp>On the \u003Ca href=\"https://airflow.apache.org/docs/apache-airflow/stable/howto/docker-compose/index.html\">official Apache Airflow page\u003C/a>, we find the link to download the latest version of Docker Compose. As of the time this post is being written, the most recent version is \u003Ccode>2.10.3\u003C/code>, and we will be installing this version.\u003C/p>\n\u003Cp>In a directory, create a \u003Ccode>docker-compose.yaml\u003C/code> file with the following configurations:\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"docker\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">x-airflow-common:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">  &#x26;airflow-common\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">  build: ./airflow\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">  # build: .\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">  environment:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    &#x26;airflow-common-env\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    AIRFLOW__CORE__EXECUTOR: CeleryExecutor\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: postgresql+psycopg2://airflow:airflow@postgres/airflow\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    AIRFLOW__CELERY__RESULT_BACKEND: db+postgresql://airflow:airflow@postgres/airflow\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    AIRFLOW__CELERY__BROKER_URL: redis://:@redis:6379/0\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    AIRFLOW__CORE__FERNET_KEY: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">''\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    AIRFLOW__CORE__DAGS_ARE_PAUSED_AT_CREATION: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">'true'\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    AIRFLOW__CORE__LOAD_EXAMPLES: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">'true'\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    AIRFLOW__API__AUTH_BACKENDS: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">'airflow.api.auth.backend.basic_auth,airflow.api.auth.backend.session'\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    # yamllint disable rule:line-length\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    # Use simple http server on scheduler for health checks\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    # See https://airflow.apache.org/docs/apache-airflow/stable/administration-and-deployment/logging-monitoring/check-health.html#scheduler-health-check-server\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    # yamllint enable rule:line-length\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    AIRFLOW__SCHEDULER__ENABLE_HEALTH_CHECK: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">'true'\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    # WARNING: Use _PIP_ADDITIONAL_REQUIREMENTS option ONLY for a quick checks\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    # for other purpose (development, test and especially production usage) build/extend Airflow image.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    _PIP_ADDITIONAL_REQUIREMENTS: ${_PIP_ADDITIONAL_REQUIREMENTS:-}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    # The following line can be used to set a custom config file, stored in the local config folder\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    # If you want to use it, outcomment it and replace airflow.cfg with the name of your config file\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    # AIRFLOW_CONFIG: '/opt/airflow/config/airflow.cfg'\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">  volumes:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    - ${AIRFLOW_PROJ_DIR:-.}/dags:/opt/airflow/dags\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    - ${AIRFLOW_PROJ_DIR:-.}/logs:/opt/airflow/logs\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    - ${AIRFLOW_PROJ_DIR:-.}/config:/opt/airflow/config\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    - ${AIRFLOW_PROJ_DIR:-.}/plugins:/opt/airflow/plugins\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">  user: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"${AIRFLOW_UID:-50000}:0\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">  depends_on:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    &#x26;airflow-common-depends-on\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    redis:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      condition: service_healthy\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    postgres:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      condition: service_healthy\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">services:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">  postgres:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    image: postgres:13\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    environment:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      POSTGRES_USER: airflow\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      POSTGRES_PASSWORD: airflow\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      POSTGRES_DB: airflow\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    volumes:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      - postgres-db-volume:/var/lib/postgresql/data\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    healthcheck:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      test: [\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"CMD\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"pg_isready\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"-U\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"airflow\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      interval: 10s\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      retries: 5\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      start_period: 5s\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    restart: always\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">  redis:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    # Redis is limited to 7.2-bookworm due to licencing change\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    # https://redis.io/blog/redis-adopts-dual-source-available-licensing/\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    image: redis:7.2-bookworm\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    expose:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      - 6379\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    healthcheck:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      test: [\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"CMD\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"redis-cli\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"ping\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      interval: 10s\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      timeout: 30s\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      retries: 50\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      start_period: 30s\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    restart: always\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">  airflow-webserver:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    &#x3C;&#x3C;: *airflow-common\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    command: webserver\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    ports:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      - \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"8080:8080\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    healthcheck:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      test: [\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"CMD\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"curl\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"--fail\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"http://localhost:8080/health\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      interval: 30s\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      timeout: 10s\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      retries: 5\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      start_period: 30s\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    restart: always\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    depends_on:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      &#x3C;&#x3C;: *airflow-common-depends-on\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      airflow-init:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        condition: service_completed_successfully\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">  airflow-scheduler:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    &#x3C;&#x3C;: *airflow-common\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    command: scheduler\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    healthcheck:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      test: [\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"CMD\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"curl\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"--fail\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"http://localhost:8974/health\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      interval: 30s\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      timeout: 10s\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      retries: 5\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      start_period: 30s\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    restart: always\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    depends_on:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      &#x3C;&#x3C;: *airflow-common-depends-on\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      airflow-init:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        condition: service_completed_successfully\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">  airflow-worker:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    &#x3C;&#x3C;: *airflow-common\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    command: celery worker\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    healthcheck:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">      # yamllint disable rule:line-length\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      test:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        - \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"CMD-SHELL\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        - \u003C/span>\u003Cspan style=\"color:#9ECBFF\">'celery --app airflow.providers.celery.executors.celery_executor.app inspect ping -d \"celery@$${HOSTNAME}\" || celery --app airflow.executors.celery_executor.app inspect ping -d \"celery@$${HOSTNAME}\"'\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      interval: 30s\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      timeout: 10s\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      retries: 5\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      start_period: 30s\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    environment:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      &#x3C;&#x3C;: *airflow-common-env\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">      # Required to handle warm shutdown of the celery workers properly\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">      # See https://airflow.apache.org/docs/docker-stack/entrypoint.html#signal-propagation\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      DUMB_INIT_SETSID: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"0\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    restart: always\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    depends_on:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      &#x3C;&#x3C;: *airflow-common-depends-on\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      airflow-init:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        condition: service_completed_successfully\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">  airflow-triggerer:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    &#x3C;&#x3C;: *airflow-common\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    command: triggerer\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    healthcheck:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      test: [\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"CMD-SHELL\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">'airflow jobs check --job-type TriggererJob --hostname \"$${HOSTNAME}\"'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      interval: 30s\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      timeout: 10s\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      retries: 5\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      start_period: 30s\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    restart: always\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    depends_on:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      &#x3C;&#x3C;: *airflow-common-depends-on\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      airflow-init:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        condition: service_completed_successfully\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">  airflow-init:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    &#x3C;&#x3C;: *airflow-common\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    entrypoint: /bin/bash\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    # yamllint disable rule:line-length\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    command:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      - -c\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      - |\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        if [[ -z \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"${AIRFLOW_UID}\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> ]]; then\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">          echo\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">          echo -e \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"\u003C/span>\u003Cspan style=\"color:#79B8FF\">\\0\u003C/span>\u003Cspan style=\"color:#9ECBFF\">33[1;33mWARNING!!!: AIRFLOW_UID not set!\u003C/span>\u003Cspan style=\"color:#79B8FF\">\\e\u003C/span>\u003Cspan style=\"color:#9ECBFF\">[0m\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">          echo \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"If you are on Linux, you SHOULD follow the instructions below to set \"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">          echo \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"AIRFLOW_UID environment variable, otherwise files will be owned by root.\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">          echo \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"For other operating systems you can get rid of the warning with manually created .env file:\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">          echo \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"    See: https://airflow.apache.org/docs/apache-airflow/stable/howto/docker-compose/index.html#setting-the-right-airflow-user\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">          echo\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        fi\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        one_meg=1048576\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        mem_available=$$(($$(getconf _PHYS_PAGES) * $$(getconf PAGE_SIZE) / one_meg))\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        cpus_available=$$(grep -cE \u003C/span>\u003Cspan style=\"color:#9ECBFF\">'cpu[0-9]+'\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> /proc/stat)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        disk_available=$$(df / | tail -1 | awk \u003C/span>\u003Cspan style=\"color:#9ECBFF\">'{print $$4}'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        warning_resources=\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"false\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        if (( mem_available &#x3C; 4000 )) ; then\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">          echo\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">          echo -e \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"\u003C/span>\u003Cspan style=\"color:#79B8FF\">\\0\u003C/span>\u003Cspan style=\"color:#9ECBFF\">33[1;33mWARNING!!!: Not enough memory available for Docker.\u003C/span>\u003Cspan style=\"color:#79B8FF\">\\e\u003C/span>\u003Cspan style=\"color:#9ECBFF\">[0m\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">          echo \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"At least 4GB of memory required. You have $$(numfmt --to iec $$((mem_available * one_meg)))\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">          echo\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">          warning_resources=\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"true\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        fi\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        if (( cpus_available &#x3C; 2 )); then\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">          echo\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">          echo -e \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"\u003C/span>\u003Cspan style=\"color:#79B8FF\">\\0\u003C/span>\u003Cspan style=\"color:#9ECBFF\">33[1;33mWARNING!!!: Not enough CPUS available for Docker.\u003C/span>\u003Cspan style=\"color:#79B8FF\">\\e\u003C/span>\u003Cspan style=\"color:#9ECBFF\">[0m\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">          echo \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"At least 2 CPUs recommended. You have $${cpus_available}\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">          echo\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">          warning_resources=\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"true\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        fi\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        if (( disk_available &#x3C; one_meg * 10 )); then\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">          echo\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">          echo -e \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"\u003C/span>\u003Cspan style=\"color:#79B8FF\">\\0\u003C/span>\u003Cspan style=\"color:#9ECBFF\">33[1;33mWARNING!!!: Not enough Disk space available for Docker.\u003C/span>\u003Cspan style=\"color:#79B8FF\">\\e\u003C/span>\u003Cspan style=\"color:#9ECBFF\">[0m\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">          echo \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"At least 10 GBs recommended. You have $$(numfmt --to iec $$((disk_available * 1024 )))\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">          echo\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">          warning_resources=\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"true\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        fi\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        if [[ $${warning_resources} == \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"true\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> ]]; then\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">          echo\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">          echo -e \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"\u003C/span>\u003Cspan style=\"color:#79B8FF\">\\0\u003C/span>\u003Cspan style=\"color:#9ECBFF\">33[1;33mWARNING!!!: You have not enough resources to run Airflow (see above)!\u003C/span>\u003Cspan style=\"color:#79B8FF\">\\e\u003C/span>\u003Cspan style=\"color:#9ECBFF\">[0m\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">          echo \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"Please follow the instructions to increase amount of resources available:\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">          echo \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"   https://airflow.apache.org/docs/apache-airflow/stable/howto/docker-compose/index.html#before-you-begin\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">          echo\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        fi\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        mkdir -p /sources/logs /sources/dags /sources/plugins\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        chown -R \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"${AIRFLOW_UID}:0\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> /sources/{logs,dags,plugins}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        exec /entrypoint airflow version\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    # yamllint enable rule:line-length\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    environment:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      &#x3C;&#x3C;: *airflow-common-env\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      _AIRFLOW_DB_MIGRATE: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">'true'\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      _AIRFLOW_WWW_USER_CREATE: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">'true'\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      _AIRFLOW_WWW_USER_USERNAME: ${_AIRFLOW_WWW_USER_USERNAME:-airflow}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      _AIRFLOW_WWW_USER_PASSWORD: ${_AIRFLOW_WWW_USER_PASSWORD:-airflow}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      _PIP_ADDITIONAL_REQUIREMENTS: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">''\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    user: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"0:0\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    volumes:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      - ${AIRFLOW_PROJ_DIR:-.}:/sources\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">  airflow-cli:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    &#x3C;&#x3C;: *airflow-common\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    profiles:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      - debug\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    environment:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      &#x3C;&#x3C;: *airflow-common-env\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      CONNECTION_CHECK_MAX_COUNT: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"0\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    # Workaround for entrypoint issue. See: https://github.com/apache/airflow/issues/16252\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    command:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      - bash\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      - -c\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      - airflow\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">  # You can enable flower by adding \"--profile flower\" option e.g. docker-compose --profile flower up\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">  # or by explicitly targeted on the command line e.g. docker-compose up flower.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">  # See: https://docs.docker.com/compose/profiles/\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">  flower:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    &#x3C;&#x3C;: *airflow-common\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    command: celery flower\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    profiles:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      - flower\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    ports:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      - \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"5555:5555\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    healthcheck:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      test: [\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"CMD\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"curl\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"--fail\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"http://localhost:5555/\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      interval: 30s\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      timeout: 10s\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      retries: 5\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      start_period: 30s\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    restart: always\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    depends_on:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      &#x3C;&#x3C;: *airflow-common-depends-on\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      airflow-init:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        condition: service_completed_successfully\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">volumes:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">  postgres-db-volume:\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>After that we will create the folders that will be shared between your computer and the container:\u003C/p>\n\u003Cul>\n\u003Cli>\u003Ccode>./dags\u003C/code>:  DAG directory.\u003C/li>\n\u003Cli>\u003Ccode>./logs\u003C/code>: Will kepp logs of task executions and the scheduler.\u003C/li>\n\u003Cli>\u003Ccode>./plugins\u003C/code>: Plugins directory.\u003C/li>\n\u003Cli>\u003Ccode>./config\u003C/code>: Configuration files will be stored here.\u003C/li>\n\u003Cli>\u003Ccode>./airflow\u003C/code>: Dockerfile directory.\u003C/li>\n\u003C/ul>\n\u003Cp>On Linux, the quick-start setup needs to know your host user ID and requires the group ID to be set to 0. Otherwise, the files created in \u003Ccode>dags\u003C/code>, \u003Ccode>logs\u003C/code>, and \u003Ccode>plugins\u003C/code> will be owned by the root user. You must ensure that these configurations are set correctly in your \u003Ccode>docker-compose\u003C/code> setup.\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"bash\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">mkdir\u003C/span>\u003Cspan style=\"color:#79B8FF\"> -p\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> ./dags\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> ./logs\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> ./plugins\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> ./config\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> ./airflow\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">echo\u003C/span>\u003Cspan style=\"color:#79B8FF\"> -e\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> \"AIRFLOW_UID=$(\u003C/span>\u003Cspan style=\"color:#B392F0\">id\u003C/span>\u003Cspan style=\"color:#79B8FF\"> -u\u003C/span>\u003Cspan style=\"color:#9ECBFF\">)\"\u003C/span>\u003Cspan style=\"color:#F97583\"> >\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> .env\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>After that, create a \u003Ccode>Dockerfile\u003C/code> in the \u003Ccode>/airflow\u003C/code> folder with the following configurations:\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"docker\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">FROM\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> apache/airflow:2.10.3\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># add your dependencies here:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">RUN\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> pip install apache-airflow-providers-mongo\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The Apache Airflow instance can now be initialized using :\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"bash\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">docker\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> compose\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> up\u003C/span>\u003Cspan style=\"color:#79B8FF\"> --build\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> airflow-init\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Now you can start all services:\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"bash\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">docker\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> compose\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> up\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Airflow will be available at \u003Ccode>0.0.0.0:8080\u003C/code>, and to log in, simply use \u003Ccode>airflow\u003C/code> as both the username and password, as this is the default configuration.\u003C/p>\n\u003Ch2 id=\"spotify-api\">Spotify API\u003C/h2>\n\u003Cp>To obtain data from Spotify, it is necessary to create an account and also create an app within the Spotify API Dashboard under the Developer area. Here is a link to the API documentation with a brief description: \u003Ca href=\"https://developer.spotify.com/documentation/web-api\">docs\u003C/a>.\u003C/p>\n\u003Cp>Basically, we will need two pieces of information: the \u003Ccode>client_id\u003C/code> and \u003Ccode>client_secret\u003C/code>. With these two keys, it is possible to generate an \u003Ccode>access_token\u003C/code> (\u003Ca href=\"https://developer.spotify.com/documentation/web-api/concepts/access-token\">docs\u003C/a>).\u003C/p>\n\u003Cp>With the access token, it is possible to communicate with the Spotify API and retrieve a variety of information.\u003C/p>\n\u003Cblockquote>\n\u003Cp>The \u003Ccode>access_token\u003C/code> is valid for only 1 hour, so we have the option to either refresh it or request a new one. In my case, I chose to request a new token each time, as the pipeline is scheduled to run only once per day.\n{: .prompt-tip }\u003C/p>\n\u003C/blockquote>\n\u003Ch2 id=\"setting-up-apache-airflow\">Setting up Apache Airflow\u003C/h2>\n\u003Cp>Airflow has a very useful feature to define variables and secrets that can be used in DAGs and Tasks.\u003C/p>\n\u003Cp>We will use it to store the Spotify API information.\u003C/p>\n\u003Cp>To do this, on the front end, click on \u003Cstrong>Admin\u003C/strong> > \u003Cstrong>Variables\u003C/strong> > \u003Cstrong>add new record\u003C/strong>\u003C/p>\n\u003Cp>\u003Cimg src=\"/assets/posts/2024-11-29/1.png\" alt=\"desktop View\">\n\u003Cem>add client_id and client_secret\u003C/em>\u003C/p>\n\u003Cp>Add the \u003Ccode>client_id\u003C/code> and \u003Ccode>client_secret\u003C/code> information and click \u003Cstrong>Save\u003C/strong>.\u003C/p>\n\u003Ch2 id=\"configuring-mongo-db\">Configuring Mongo DB\u003C/h2>\n\u003Cp>Before anything, it is necessary to create an account on \u003Ca href=\"https://www.mongodb.com/\">MongoDB\u003C/a> and set up a cluster. For this project, we will use the Free Tier.\u003C/p>\n\u003Cp>\u003Cimg src=\"/assets/posts/2024-11-29/2.png\" alt=\"desktop View\">\n\u003Cem>Mongo DB homepage\u003C/em>\u003C/p>\n\u003Cp>Click on Database Access > add new database user\u003C/p>\n\u003Cp>Use the authentication method with a password, define the user’s role.\u003C/p>\n\u003Cp>And make sure to store the password in a secure place as it will be needed later.\u003C/p>\n\u003Cp>Click on Network Acess Allow IP access to the port.\u003C/p>\n\u003Cp>\u003Cimg src=\"/assets/posts/2024-11-29/3.png\" alt=\"desktop View\">\n\u003Cem>Acess Network\u003C/em>\u003C/p>\n\u003Cp>It is also necessary to create a new database and collection within the cluster. This is where the music information will be saved. In my case, the database “spotify” was created in the “currency collection” collection.\u003C/p>\n\u003Cp>\u003Cimg src=\"/assets/posts/2024-11-29/4.png\" alt=\"desktop View\">\n\u003Cem>Creating Database and Collection\u003C/em>\u003C/p>\n\u003Ch2 id=\"creating-a-connection-to-mongodb-in-airflow\">Creating a connection to MongoDB in Airflow\u003C/h2>\n\u003Cp>Agora que o MongoDB está devidamente configurado, é necessário conectá-lo no Airflow. Para isso, basta ir na aba \u003Cstrong>Admin > Connections\u003C/strong> > \u003Cstrong>add new record\u003C/strong> .\u003C/p>\n\u003Cp>And set it up as shown below:\u003C/p>\n\u003Cp>Set up the connection as shown below:\u003C/p>\n\u003Cul>\n\u003Cli>\u003Cstrong>Conn Id:\u003C/strong> mongo\u003C/li>\n\u003Cli>\u003Cstrong>Conn Type:\u003C/strong> MongoDB\u003C/li>\n\u003Cli>\u003Cstrong>Host:\u003C/strong> cluster0.mtfak.mongodb.net\u003C/li>\n\u003Cli>\u003Cstrong>Login:\u003C/strong> myuser (set before on the MongoDB webpage)\u003C/li>\n\u003Cli>\u003Cstrong>Password:\u003C/strong> mypass (set before on the MongoDB webpage)\u003C/li>\n\u003Cli>\u003Cstrong>Port:\u003C/strong> empty\u003C/li>\n\u003Cli>\u003Cstrong>Extra:\u003C/strong> \u003Ccode>{\"srv\": true}\u003C/code>\u003C/li>\n\u003C/ul>\n\u003Cp>Click on Save.\u003C/p>\n\u003Ch2 id=\"airflow-dag\">Airflow DAG\u003C/h2>\n\u003Cp>Our pipeline will have 3 main parts:\u003C/p>\n\u003Col>\n\u003Cli>Obtain the access_token from the Spotify API.\u003C/li>\n\u003Cli>With the access_token in hand, make the request to the Spotify Playlist API to get the information of the 50 most played songs of the day (from the Top 50 Global playlist).\u003C/li>\n\u003Cli>Save the JSON object in MongoDB.\u003C/li>\n\u003C/ol>\n\u003Ch3 id=\"1---get-acess-token\">1 - Get Acess Token\u003C/h3>\n\u003Cp>The get_token task retrieves the access token from the Spotify API by sending a request with the client credentials. It encodes the client ID and secret in base64, makes a POST request to Spotify’s token endpoint, and returns the access token as an XCom.\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">    @task\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    def\u003C/span>\u003Cspan style=\"color:#B392F0\"> get_token\u003C/span>\u003Cspan style=\"color:#E1E4E8\">():\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">        # get credentials\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        client_id \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Variable.get(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"client_id\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        client_secret \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Variable.get(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"client_secret\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        auth_string \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#F97583\"> f\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"\u003C/span>\u003Cspan style=\"color:#79B8FF\">{\u003C/span>\u003Cspan style=\"color:#E1E4E8\">client_id\u003C/span>\u003Cspan style=\"color:#79B8FF\">}\u003C/span>\u003Cspan style=\"color:#9ECBFF\">:\u003C/span>\u003Cspan style=\"color:#79B8FF\">{\u003C/span>\u003Cspan style=\"color:#E1E4E8\">client_secret\u003C/span>\u003Cspan style=\"color:#79B8FF\">}\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        auth_bytes \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> auth_string.encode(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'utf-8'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        auth_base64 \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> base64.b64encode(auth_bytes).decode(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'utf-8'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">        # make request\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        url \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> 'https://accounts.spotify.com/api/token'\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        headers \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">            'Authorization'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#F97583\">f\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'Basic \u003C/span>\u003Cspan style=\"color:#79B8FF\">{\u003C/span>\u003Cspan style=\"color:#E1E4E8\">auth_base64\u003C/span>\u003Cspan style=\"color:#79B8FF\">}\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        data \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">            'grant_type'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">'client_credentials'\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        response \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> requests.post(url, \u003C/span>\u003Cspan style=\"color:#FFAB70\">headers\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\">headers, \u003C/span>\u003Cspan style=\"color:#FFAB70\">data\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\">data)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">        print\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(response.json().get(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'access_token'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">))\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">        #transform token in a xcom\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        return\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> response.json().get(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'access_token'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch3 id=\"2---obtain-playlist-songs\">2 - Obtain Playlist Songs\u003C/h3>\n\u003Cp>The get_playlist task retrieves the top 50 tracks from a specific Spotify playlist using the provided access token. It sends a GET request to the Spotify API and returns the playlist data in JSON format if the request is successful.\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">    @task\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    def\u003C/span>\u003Cspan style=\"color:#B392F0\"> get_playlist\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(token):\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        url \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> 'https://api.spotify.com/v1/playlists/5FN6Ego7eLX6zHuCMovIR2/tracks?limit=50&#x26;offset=0'\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        headers \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">        'Authorization'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#F97583\">f\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'Bearer \u003C/span>\u003Cspan style=\"color:#79B8FF\">{\u003C/span>\u003Cspan style=\"color:#E1E4E8\">token\u003C/span>\u003Cspan style=\"color:#79B8FF\">}\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        response \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> requests.get(url, \u003C/span>\u003Cspan style=\"color:#FFAB70\">headers\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\">headers)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        if\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> response.status_code \u003C/span>\u003Cspan style=\"color:#F97583\">==\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 200\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">            return\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> response.json()\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch3 id=\"3---ingest-data-on-mongo-db\">3 - Ingest Data on Mongo DB\u003C/h3>\n\u003Cp>The load_data_to_mongo_db task connects to a MongoDB database using the MongoHook, inserts the result (with a timestamp) into the currency_collection of the spotify database, and logs the connection details.\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">    @task\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    def\u003C/span>\u003Cspan style=\"color:#B392F0\"> load_data_to_mongo_db\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(result):\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        hook \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> MongoHook(\u003C/span>\u003Cspan style=\"color:#FFAB70\">conn_id\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'mongo'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        client \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> hook.get_conn()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        db \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        client.spotify\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        )\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        currency_collection \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> db.currency_collection\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">        print\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#F97583\">f\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"connected to MongoDB - \u003C/span>\u003Cspan style=\"color:#79B8FF\">{\u003C/span>\u003Cspan style=\"color:#E1E4E8\">client.server_info()\u003C/span>\u003Cspan style=\"color:#79B8FF\">}\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        current_datetime \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> pendulum.now().to_iso8601_string()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        result[\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"datetime\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">] \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> current_datetime\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        currency_collection.insert_one(result)\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Here is our complete DAG:\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">from\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> airflow.decorators \u003C/span>\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> dag, task\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> pendulum\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">from\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> pendulum \u003C/span>\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> datetime\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">from\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> airflow.models \u003C/span>\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Variable\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">from\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> airflow.providers.mongo.hooks.mongo \u003C/span>\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> MongoHook\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> json\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> base64\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> requests\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">@dag\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">    start_date\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\">datetime(\u003C/span>\u003Cspan style=\"color:#79B8FF\">2024\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#79B8FF\">11\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#79B8FF\">21\u003C/span>\u003Cspan style=\"color:#E1E4E8\">),\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">    schedule\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"@daily\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">    tags\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\">[\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"spotify_api\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">],\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">    catchup\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\">False\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">def\u003C/span>\u003Cspan style=\"color:#B392F0\"> pipe\u003C/span>\u003Cspan style=\"color:#E1E4E8\">():\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">    @task\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    def\u003C/span>\u003Cspan style=\"color:#B392F0\"> get_token\u003C/span>\u003Cspan style=\"color:#E1E4E8\">():\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">        # get credentials\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        client_id \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Variable.get(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"client_id\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        client_secret \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Variable.get(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"client_secret\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">        # Codificando as credenciais em base64\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        auth_string \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#F97583\"> f\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"\u003C/span>\u003Cspan style=\"color:#79B8FF\">{\u003C/span>\u003Cspan style=\"color:#E1E4E8\">client_id\u003C/span>\u003Cspan style=\"color:#79B8FF\">}\u003C/span>\u003Cspan style=\"color:#9ECBFF\">:\u003C/span>\u003Cspan style=\"color:#79B8FF\">{\u003C/span>\u003Cspan style=\"color:#E1E4E8\">client_secret\u003C/span>\u003Cspan style=\"color:#79B8FF\">}\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        auth_bytes \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> auth_string.encode(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'utf-8'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        auth_base64 \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> base64.b64encode(auth_bytes).decode(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'utf-8'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        url \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> 'https://accounts.spotify.com/api/token'\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        headers \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">            'Authorization'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#F97583\">f\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'Basic \u003C/span>\u003Cspan style=\"color:#79B8FF\">{\u003C/span>\u003Cspan style=\"color:#E1E4E8\">auth_base64\u003C/span>\u003Cspan style=\"color:#79B8FF\">}\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        data \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">            'grant_type'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">'client_credentials'\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">        # Fazendo a solicitação POST\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        response \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> requests.post(url, \u003C/span>\u003Cspan style=\"color:#FFAB70\">headers\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\">headers, \u003C/span>\u003Cspan style=\"color:#FFAB70\">data\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\">data)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">        print\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(response.json().get(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'access_token'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">))\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        return\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> response.json().get(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'access_token'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">    @task\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    def\u003C/span>\u003Cspan style=\"color:#B392F0\"> get_playlist\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(token):\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        url \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> 'https://api.spotify.com/v1/playlists/5FN6Ego7eLX6zHuCMovIR2/tracks?limit=50&#x26;offset=0'\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        headers \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">        'Authorization'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#F97583\">f\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'Bearer \u003C/span>\u003Cspan style=\"color:#79B8FF\">{\u003C/span>\u003Cspan style=\"color:#E1E4E8\">token\u003C/span>\u003Cspan style=\"color:#79B8FF\">}\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        response \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> requests.get(url, \u003C/span>\u003Cspan style=\"color:#FFAB70\">headers\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\">headers)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        if\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> response.status_code \u003C/span>\u003Cspan style=\"color:#F97583\">==\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 200\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">            return\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> response.json()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        \u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">    @task\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    def\u003C/span>\u003Cspan style=\"color:#B392F0\"> load_data_to_mongo_db\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(result):\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        hook \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> MongoHook(\u003C/span>\u003Cspan style=\"color:#FFAB70\">conn_id\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'mongo'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        client \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> hook.get_conn()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        db \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        client.spotify\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        )\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        currency_collection \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> db.currency_collection\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">        print\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#F97583\">f\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"connected to MongoDB - \u003C/span>\u003Cspan style=\"color:#79B8FF\">{\u003C/span>\u003Cspan style=\"color:#E1E4E8\">client.server_info()\u003C/span>\u003Cspan style=\"color:#79B8FF\">}\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        current_datetime \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> pendulum.now().to_iso8601_string()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        result[\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"datetime\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">] \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> current_datetime\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        currency_collection.insert_one(result)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    \u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    load_data_to_mongo_db(get_playlist(get_token()))\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">pipe()\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cblockquote>\n\u003Cp>The \u003Ccode>pipe.py\u003C/code> must be on the dags directory.\n{: .prompt-tip }\u003C/p>\n\u003C/blockquote>\n\u003Ch2 id=\"observing-the-jobs-in-the-airflow-frontend\">Observing the Jobs in the Airflow Frontend\u003C/h2>\n\u003Cp>Now that our DAG is configured, simply run it manually once for testing, and let Airflow handle the orchestration to execute the code daily.\u003C/p>\n\u003Cp>\u003Cimg src=\"/assets/posts/2024-11-29/6.png\" alt=\"desktop View\">\n\u003Cem>Airflow Jobs running\u003C/em>\u003C/p>\n\u003Cp>\u003Cimg src=\"/assets/posts/2024-11-29/7.png\" alt=\"desktop View\">\n\u003Cem>Graph View Job\u003C/em>\u003C/p>\n\u003Cp>The code worked as expected, and the pipeline is successfully retrieving playlist information, orchestrated via Airflow!\u003C/p>\n\u003Cp>In MongoDB, it is possible to see the data loads made:\u003C/p>\n\u003Cp>\u003Cimg src=\"/assets/posts/2024-11-29/8.png\" alt=\"desktop View\">\n\u003Cem>Graph View Job\u003C/em>\u003C/p>\n\u003Ch2 id=\"conclusions\">Conclusions\u003C/h2>\n\u003Cp>This project successfully demonstrates the power of Apache Airflow in orchestrating a data pipeline to fetch the most played tracks on Spotify daily. By leveraging Spotify’s API and MongoDB for storage, we were able to automate the process of retrieving and storing the data. The use of Docker and MongoDB integration with Airflow allowed for a smooth execution of tasks, ensuring that the pipeline runs automatically each day with minimal intervention. This solution is a great example of how data engineering tools can be used to automate data collection and storage processes, providing valuable insights in an efficient and scalable manner.\u003C/p>\n\u003Cp>All the codes are available in the \u003Ca href=\"https://github.com/lucasbral/spotify_pipeline/tree/main\">GitHub Repo\u003C/a>.\u003C/p>",{"headings":258,"localImagePaths":289,"remoteImagePaths":290,"frontmatter":291,"imagePaths":296},[259,260,261,264,267,270,273,276,279,282,285,288],{"depth":32,"slug":33,"text":34},{"depth":36,"slug":228,"text":229},{"depth":32,"slug":262,"text":263},"spotify-api","Spotify API",{"depth":32,"slug":265,"text":266},"setting-up-apache-airflow","Setting up Apache Airflow",{"depth":32,"slug":268,"text":269},"configuring-mongo-db","Configuring Mongo DB",{"depth":32,"slug":271,"text":272},"creating-a-connection-to-mongodb-in-airflow","Creating a connection to MongoDB in Airflow",{"depth":32,"slug":274,"text":275},"airflow-dag","Airflow DAG",{"depth":36,"slug":277,"text":278},"1---get-acess-token","1 - Get Acess Token",{"depth":36,"slug":280,"text":281},"2---obtain-playlist-songs","2 - Obtain Playlist Songs",{"depth":36,"slug":283,"text":284},"3---ingest-data-on-mongo-db","3 - Ingest Data on Mongo DB",{"depth":32,"slug":286,"text":287},"observing-the-jobs-in-the-airflow-frontend","Observing the Jobs in the Airflow Frontend",{"depth":32,"slug":126,"text":127},[],[],{"title":244,"description":245,"date":292,"categories":293,"tags":294,"image":295,"render_with_liquid":76},"2024-11-29 00:00:00 +0800",[20,214,215],[214,251],{"path":248},[]]